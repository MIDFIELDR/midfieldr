---
title: "Identify programs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Identify programs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "../man/figures/vignette-identify-programs-")
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
```

## Introduction

In studying student records, a common first step is to subset the data, retaining some instructional programs and dropping others. In the US, instructional programs are encoded by "CIP" codes. 

CIP is the acronym for *Classification of Instructional Programs*, a taxonomy of academic programs curated by the US Department of Education [@NCES:2010]. A CIP code is a 6-digit integer assigned to an instructional program. The 2010 CIP codes are included with midfieldr in the data set `cip`. 

We explore the `cip` data set using several search strategies and we conclude by constructing an example data set used in subsequent vignettes.

### This vignette uses

midfieldr functions 
 
- `filter_text()` 

packages

```{r}
# packages used
library(midfieldr)
library(data.table)

# print max 20 rows, otherwise 10 rows each head/tail
options(datatable.print.nrows = 20, datatable.print.topn = 10)
```

## CIP data

The midfieldr package includes a data set called `cip` that provides the 2010 CIP codes and names for `r nrow(cip)` programs, one program per row. Every program has three codes: 

- 6-digit code, a specific program
- 4-digit code, a group of 6-digit programs of comparable content 
- 2-digit code, a grouping of 4-digit groups of related content 

```{r echo = FALSE}
df <- filter_text(cip, "^41")
n41 <- nrow(df)
n4102 <- filter_text(df, "^4102") %>% nrow()
n4103 <- filter_text(df, "^4103") %>% nrow()
name41 <- df$cip2name %>% unique()

df24 <- filter_text(cip, "^24")
n24 <- nrow(df24)
name24 <- df24$cip2name %>% unique()

df51 <- filter_text(cip, "^51")
n51 <- nrow(df51)
name51 <- df51$cip2name %>% unique()

df1313 <- filter_text(cip, "^1313")
n1313 <- nrow(df1313)
name1313 <- df1313$cip2name %>% unique()

cip <- filter_text(cip) # removes data.frame class if present
```

Examine the column names and class.  

```{r}
# column names and class of each
unlist(lapply(cip, FUN = class))
```

View the 2-, 4-, and 6-digit columns separately. 

```{r}
# 2-digit codes and names alone
cip[, .(cip2, cip2name)]

# 4-digit codes and names alone
cip[, .(cip4, cip4name)]

# 6-digit codes and names alone
cip[, .(cip6, cip6name)]
```

If you prefer to see a spreadsheet-like array of any data frame, run 

```r
View(cip)
```

To facilitate viewing in the vignettes, we will often typeset a data frame as an HTML table. For example, the following table includes the same information from our views of `cip` above in an easy-to-read format. The values are tabulated with the variable names in the header. 

```{r echo=FALSE}
df1 <- cip[1:6]
df1[6, ] <- "---"
df2 <- cip[1580:1584]
kable2html(rbind(df1, df2))
```
<br>

### Relationships between 2-, 4-, and 6-digit CIP

In the table below, we show all programs associated with the 2-digit code "41" for programs in the broad area of "`r name41`". This 2-digit grouping is subdivided into `r length(unique(df$cip4))` groups at the 4-digit level (codes 4100--4199) which are further subdivided into `r n41` programs at the 6-digit level (codes 410000--419999). 

As you can see, the 6-digit codes and names represent distinct instructional programs and the 4- and 2-digit codes are groupings of programs. 

```{r echo=FALSE}
sub_cip <- filter_text(cip, "^41")
kable2html(sub_cip)
```
<br>

Higher-level groups comprise different numbers of lower-level groups. As shown above, codes 4102 and 4103  include `r n4103` programs each but codes 4100, 4101, and 4199 include only one program each. At the 2-digit level, code 41 comprises N = `r n41` programs total. 

In `cip` overall, a 2-digit grouping can include anywhere from `r n24` programs  (code 24 `r name24`) to `r n51` programs (code 51 `r name51`). Similarly, a 4-digit grouping can include anywhere from 1 program (codes 4100, 4101, and 4199 shown above) to `r n1313` programs (code 1313 `r name1313`). 

To learn more, open the help page by running 

```r
? cip
```

## Filtering basics

The variables in `cip` are all characters, facilitating filtering using character search terms. 

```{r}
# examine variable types
unlist(lapply(cip, FUN = class))
```

`filter_text()` filters a data frame using character search terms. The arguments are: 

- `data` data frame to be subsetted
- `keep_text` character vector of search patterns for retaining rows, not case-sensitive 
- `drop_text` (optional) character vector of search patterns for dropping rows

For example, filtering the CIP data for all programs containing the word "engineering" yields `r nrow(filter_text(cip, "engineering"))` observations. 

```{r}
# filter basics
sub_cip <- filter_text(cip, keep_text = "engineering")

# examine the result
sub_cip
```

The first two argument names can be omitted if they are in the correct order. If the optional `drop_text` argument is used, it must be named, 

```{r}
# only the drop_text argument must be named
sub_cip <- filter_text(cip, "civil engineering", drop_text = "technology")

# examine the result
sub_cip
```

To learn more, open the help page by running 

```r
? filter_text()
```

## Filtering examples

### 1. Using keywords and phrases

Suppose we want to find the CIP codes and names for all programs in Civil Engineering. The search is case-insensitive, so we start with the following code chunk. 

```{r}
# example 1 filter using keywords
sub_cip <- filter_text(cip, keep_text = "civil")

# examine the result
sub_cip
```

The same information is tabulated below to help you see the structure.  In the examples that follow, we show a table like this one instead of the R output. 

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kable2html(sub_cip)
```
<br>

The search returns some programs with Civilization in their names as well as Engineering Technology. If we wanted Civil Engineering only, we can use a sequence of function calls, where the outcome of the one operation is assigned to the first argument of the next operation via the pipe `%>%` operator.  

The following code chunk could be read as, "Start with the `cip` data frame, then keep any rows in which 'civil' is detected, then keep any rows in which 'engineering' is detected, then drop any rows in which 'technology' is detected."

```{r results = "hide"}
# first pass
sub_cip <- filter_text(cip, keep_text = "civil")

# refine the search
sub_cip <- filter_text(sub_cip, keep_text = "engineering")

# refine further
sub_cip <- filter_text(sub_cip, drop_text = "technology")
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

Seeing that all Civil Engineering programs have the same `cip4name`, we could combine our search terms in one argument set, 

```{r results = "hide"}
sub_cip <- filter_text(cip, keep_text = "civil engineering", drop_text = "technology")
```

```{r echo = FALSE}
kable2html(sub_cip)
```

### 2. Using numerical codes

Suppose we want to study programs relating to German culture, language, and literature. Using  "german" for the `keep_text` value yields 

```{r results = "hide"}
# example 2 filter using numerical codes
sub_cip <- filter_text(cip, keep_text = "german")
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

From the 6-digit program names we find only two that are of interest, German Studies (050125) and German Language and Literature (160501). We use a character vector to assign these two codes to the `keep_text` argument. 
 
```{r results = "hide"}
sub_cip <- filter_text(cip, keep_text = c("050125", "160501"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

If the 6-digit codes are entered as integers, they produce an error. 
 
```{r error = TRUE, purl = FALSE}
filter_text(cip, keep_text = c(050125, 160501))
```

### 3. Using regular expressions

Specifying 4-digit codes yields a data frame all 6-digit programs containing the 4-digit string. We use the regular expression notation `^` to match the start of the strings.

```{r results = "hide"}
# example 3 filter using regular expressions
sub_cip <- filter_text(cip, keep_text = c("^1407", "^1408"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

The 2-digit series represent the most general groupings of related programs. Here, the result includes all History programs. 

```{r results = "hide"}
# 2-digit example
sub_cip <- filter_text(cip, keep_text = "^54")
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

The series argument can include any combination of 2, 4, and 6-digit codes. 

```{r results = "hide"}
# a series with 2, 4, and 6-digits specified
sub_cip <- filter_text(cip, keep_text = c("^24", "^4102", "^450202"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

### 4. Search terms that cannot be found

If the `keep_text` argument includes terms that cannot be found in the CIP data frame, the unsuccessful terms are identified in a message and the successful terms produce the usual output. 

For example, the following `keep_text` argument includes three search terms that are not present in the CIP data ("111111", "^55", and "Bogus") and two that are ("050125" and "160501").  

```{r message = TRUE}
# unsuccessful terms produce a message
sub_cip <- filter_text(cip, keep_text = c("050125", "111111", "160501", "Bogus", "^55"))

# but the successful terms are returned
sub_cip
```

However, as seen earlier, if none of the search terms are found, an error occurs. 

```{r error = TRUE, purl = FALSE}
filter_text(cip, keep_text = c("111111", "Bogus", "^55"))
```

### 5. Other optional arguments 

`filter_text()` has two additional optional arguments. 

- `keep_col` 
- `unique_row`  

As seen in the previous examples, the default setting for `keep_col` returns all columns. We can select columns by name, 

```{r}
# selecting columns
filter_text(cip,
  keep_text = "^54",
  keep_col = c("cip4", "cip4name")
)
```

The default setting for `unique_row` returns all rows. The default TRUE  argument removes duplicate rows after subsetting is complete. 

```{r}
# remove duplicate rows
filter_text(cip,
  keep_text = "^54",
  keep_col = c("cip4", "cip4name"),
  unique_row = TRUE
)
```

## Case study  

In the midfieldr vignettes, we use a case study of four programs (Civil, Electrical, Industrial, and Mechanical Engineering) to illustrate our process of computing persistence metrics. 

The case study begins here, by extracting CIP data for the four engineering programs. 

```{r results = "hide"}
# explore the CIP
sub_cip <- filter_text(cip, keep_text = "engineering", drop_text = "technology")
sub_cip <- filter_text(sub_cip, keep_text = c("civil", "electrical", "industrial", "mechanical"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

The results show that the codes we want are at the 4-digit level:  1408, 1410, 1419, and 1435.

```{r}
# select the case study CIPs
case_study_cip <- filter_text(cip, keep_text = c("^1408", "^1410", "^1419", "^1435"))
```

```{r echo = FALSE}
kable2html(case_study_cip)
```
<br>

The data frame `case_study_cip` concludes this stage of the case study and, in turn, is the input to the next stage. Similar intermediate results conclude every stage of the case study. In each instance, such results are named with the prefix `rep_` (indicating they are associated with  the "representative" case study) and are included as data sets in midfieldr. 

The CIP data frame derived above is the data set `rep_cip` in midfieldr.  View its help page by running

```r
? rep_cip
```

## Extract and label programs

Starting with a CIP subset, we extract the 6-digit codes and label groups of programs to suit our purposes. The result is later used to filter the student-record data sets (students, courses, terms, or degrees) for the analysis at hand.

As you can see in the table above, the program names at the 4-digit level are those associated with accredited engineering departments. Three of these names (Civil, Industrial, and Mechanical) are concise enough for small-multiple or faceted graphs. The Electrical program name is inconveniently long.  

Two approaches to editing the program labels are shown below. 

### 1. Work with one program one at a time

We separate `rep_cip` into four data frames, one for each program. 

```{r}
# work with programs one at a time and bind
# get civil engineering 6-digit codes
cve <- filter_text(rep_cip, keep_text = "^1408", keep_col = "cip6")
cve
```

We operate on the result to create a new column called `program`, used later for grouping, summarizing, and joining. 

```{r}
# add a program label
cve[, program := "Civil Engineering"]
cve
```

Repeat for the other majors

```{r}
# get electrical  engineering
ele <- filter_text(rep_cip, keep_text = "^1410", keep_col = "cip6")
ele[, program := "Electrical Engineering"]
ele

# get mechanical  engineering
mce <- filter_text(rep_cip, keep_text = "^1419", keep_col = "cip6")
mce[, program := "Mechanical Engineering"]
mce

# get industrial engineering
ise <- filter_text(rep_cip, keep_text = "^1435", keep_col = "cip6")
ise[, program := "Industrial Engineering"]
ise
```

We have 4 data frames that we combine row-wise. 

```{r }
# gather the programs in the study
program_group <- rbind(cve, ele, ise, mce)

# examine the result
program_group
```

### 2. Work with all programs in one data frame

Alternatively, we can operate on one data frame throughout. Starting with the 6-digit codes and the 4-digit names, 

```{r}
# work with programs all in one data frame
program_group <- rep_cip[, .(cip6, program = cip4name)]

# examine the result
program_group
```

All but Electrical Engineering have conveniently short program names. We use `startsWith()` to edit the program column for electrical. 

```{r}
# identify the CIP rows that start with 1410
rows_to_edit <- startsWith(program_group$cip6, "1410")

# relabel the electrical programs
program_group[rows_to_edit, program := "Electrical Engineering"]

# examine the result
program_group
```

The program group derived above is the data set `rep_group` in midfieldr.  View its help page by running

```r
? rep_group
```

## Options for the program column

Our goal is to create a data frame with two columns, `cip6` and `program` or equivalent. In this section, we explore several options for assigning program labels.   

### Option 1. Use one of the built-in CIP names 

We can use one of the built-in 2-, 4-, or 6-digit names as follows. 

```{r}
# retain the 2-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip2name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip2name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 4-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip4name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip4name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 6-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip6name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip6name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

### Option 2. Assign any string

CIP program names are occasionally verbose. In such cases, we often use a shortened version of the program name to use as a graph or table heading. In this example, we substitute our own name for the "Parks, Recreation, Leisure and Fitness Studies" programs used in the previous example. 

```{r}
# ignore all default CIP names
sub_cip <- filter_text(cip, keep_text = "^31", keep_col = "cip6")

# assign an arbitrary program name
program_group <- sub_cip[, program := "Leisure Studies"]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

## CIP data from another source

If you use a CIP data set from another source, it must have the same structure as `cip`: six character columns named as follows,  

```{r}
# name and class of variables (columns) in cip
unlist(lapply(cip, FUN = class))
```





## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r eval=FALSE}
# packages used
library(midfieldr)
library(data.table)

# examine variable types
str(cip)

# filter basics
sub_cip <- filter_text(cip, keep_text = "engineering")
sub_cip <- filter_text(cip, "civil engineering", drop_text = "technology")

# example 1 filter using keywords
sub_cip <- filter_text(cip, keep_text = "civil")
sub_cip <- filter_text(sub_cip, keep_text = "engineering")
sub_cip <- filter_text(sub_cip, drop_text = "technology")
sub_cip <- filter_text(cip, keep_text = "civil engineering", drop_text = "technology")

# example 2 filter using numerical codes
sub_cip <- filter_text(cip, keep_text = "german")
sub_cip <- filter_text(cip, keep_text = c("050125", "160501"))

# example 3 filter using regular expressions
sub_cip <- filter_text(cip, keep_text = c("^1407", "^1408"))
sub_cip <- filter_text(cip, keep_text = "^54")
sub_cip <- filter_text(cip, keep_text = c("^24", "^4102", "^450202"))

# example 4 search terms that cannot be found
sub_cip <- filter_text(cip, keep_text = c("050125", "111111", "160501", "Bogus", "^55"))

# case study data set
filter_text(cip, keep_text = c("^1408", "^1410", "^1419", "^1435"))
print(rep_cip)

# work with programs one at a time and bind
cve <- filter_text(rep_cip, keep_text = "^1408", keep_col = "cip6")
cve[, program := "Civil Engineering"]

ele <- filter_text(rep_cip, keep_text = "^1410", keep_col = "cip6")
ele[, program := "Electrical Engineering"]

mce <- filter_text(rep_cip, keep_text = "^1419", keep_col = "cip6")
mce[, program := "Mechanical Engineering"]

ise <- filter_text(rep_cip, keep_text = "^1435", keep_col = "cip6")
ise[, program := "Industrial Engineering"]

program_group <- rbind(cve, ele, ise, mce)

# work with programs all in one data frame
program_group <- rep_cip[, .(cip6, program = cip4name)]
rows_to_edit <- startsWith(program_group$cip6, "1410")
program_group[rows_to_edit, program := "Electrical Engineering"]

# assign the 2-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip2name")
)
program_group <- sub_cip[, .(cip6, program = cip2name)]

# assign the 4-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip4name")
)
program_group <- sub_cip[, .(cip6, program = cip4name)]

# assign the 6-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip6name")
)
program_group <- sub_cip[, .(cip6, program = cip6name)]

# assign an arbitrary program name
sub_cip <- filter_text(cip, keep_text = "^31", keep_col = "cip6")
program_group <- sub_cip[, program := "Leisure Studies"]

# name and class of variables (columns) in cip
unlist(lapply(cip, FUN = class))
```
