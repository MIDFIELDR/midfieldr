---
title: "Graduation rate"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Graduation rate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: |
resource_files: |
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
  fig.path = "../man/figures/art-080-graduation-rate-",
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
```

Graduation rate is a widely used, though flawed, measure of academic performance. The American Council on Education estimates that the conventional definition of graduation rate may exclude up to 60% of students at 4-year institutions [@Cook+Hartle:2011]. Nevertheless, as Cook and Hartle explain, 

> ... in the eyes of the public, policy makers, and the media, graduation
> rate is a clear, simple, and logical---if often misleading---number.

Recognizing that graduation rate is a popular metric, we illustrate an improved longitudinal graduation rate calculation that includes many (though not all) of the students excluded by the conventional definition. 





## A more inclusive definition

In general, graduation rate is the fraction of starters completing their program in a timely manner. 

IPEDS graduation rate

: In the US, the Integrated Postsecondary Education Data System (IPEDS) defines "graduation rate" as the fraction of a cohort of full-time, first-time, degree-seeking undergraduates who complete their program within a percentage (100%, 150%, or 200%) of the "normal" time (typically 4 years) as defined by the institution [@IPEDS:2020]. IPEDS excludes students who attend college part-time, who transfer between institutions, and who start college in Winter or Spring terms.   

MIDFIELD graduation rate

: The MIDFIELD definition of graduation rate includes starters who are part-time, transfers, or admitted in any term.

The table summarizes the comparison between the two definitions of graduation rate. 

```{r echo = FALSE}
library("midfieldr")
library("midfielddata")
suppressMessages(library("data.table"))
DT <- wrapr::build_frame(
  "Constraints", "IPEDS", "MIDFIELD", "MIDFIELD notes" |
    "completion span:", "4, 6, or 8 years", "4, 6, or 8 years", "Typical usage is 6 years" |
    "students admitted in:", "Summer/Fall only", "any term", "" |
    "part-time students are:", "excluded", "included", "Timely completion same as full-time students" |
    "transfer students are:", "excluded", "included", "Timely completion span adjusted for level at entry" |
    "switchers:", "see below", "see below", "A heuristic could be developed for extending the completion span"
)

DT |>
  kableExtra::kbl(
    align = "llll",
    caption = "Comparing graduation rate criteria"
  ) |>
  kableExtra::kable_paper(lightable_options = "basic", full_width = TRUE) |>
  kableExtra::column_spec(1:2, color = "black", background = "white") |>
  kableExtra::row_spec(c(0), background = "#c7eae5")
```

**Switchers.** Students who change majors (switchers) are problematic in determining graduation rate. Switchers are generally included in the count of starters of their first program. After switching, should they graduate in a timely manner, whether they are included in the count of graduates of their new program depends on the CIP level for which graduation rate is calculated. We have four possible cases:   

- Graduation rate computed at the institution level includes all switchers within the institution. For example, switchers from Engineering (CIP 14) who graduate in Business (CIP 52) are included in the count of institution starters and graduates. IPEDS defines this rate as the *institution completion rate.*

- Computing at the 2-digit CIP level includes switcher graduates within the same 2-digit CIP and excludes others. For example, switchers from Electrical Engineering (CIP 1410) who graduate in Mechanical Engineering (CIP 1419) are included in the count of Engineering starters and graduates (CIP 14). Switchers from Engineering who graduate in Business are excluded from the Business graduate count.

- Computing at the 4-digit CIP level is similar. For example, switchers from Laser and Optical Engineering (CIP 141003) who graduate in Telecommunications Engineering (CIP 141004) are included in the count of Electrical Engineering starters and graduates (CIP 1410). Switchers from Electrical Engineering who graduate in Mechanical Engineering are excluded from the Mechanical Engineering graduate count. 

- Computing at the 6-digit CIP level excludes all switcher graduates, though this case is rarely used.   

**No extensions for switchers.** Because a switcher may have to complete remedial work in their new program, their time to graduation may exceed the defined acceptable span (typically 6 years). The graduation rate definition has no mechanism for extending the completion span even if both the student and faculty of the new program consider the student's graduation timely.

The IPEDS definition of graduation rate excludes such an extension. MIDFIELD currently has no mechanism to extend the completion span for switchers, though a more inclusive heuristic could be developed.






## Data

If you are writing your own script to follow along, we start with these packages:

```{r}
# Packages
library("midfieldr")
library("midfielddata")
suppressMessages(library("data.table"))
suppressPackageStartupMessages(library("ggplot2"))

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

The data set `study_starters` (included with midfieldr) contains the IDs of students starting in four programs (Civil, Electrical, Industrial/Systems, and Mechanical Engineering) after filtering for data sufficiency, degree seeking, and program. Starters include FYE proxies. (Deriving these data from the source data tables is described in [Starters and FYE programs](art-070-fye.html)).

```{r}
# Case study starters
study_starters
```

The data set `study_observations` (included with midfieldr) contains the graduates of the case study programs as well as those ever enrolled, which we ignore for this metric. (Deriving these data from the source data tables is described in [Case study: Data](art-002-case-data.html)) 

```{r}
# Case study graduates
study_observations
```

**Importing.** We use the midfielddata `student` table for its `race` and `sex`  variables, keyed by student ID.

```{r}
# Load data from midfielddata
data(student)

# Display selected columns
student[, .(mcid, race, sex)]
```







## Gather starters

```{r}
# Create a working data frame
DT <- study_starters[, .(mcid, program)]

# Label the group
DT[, group := "start"]

# Display the result
DT[]
```









## Gather graduates

Graduates are a subset of `study_observations`. Rename the `program` variable to prepare for a merge operation. 

```{r}
grad <- study_observations[group == "grad"]
grad[]
```

Prep for joining. 

```{r}
grad <- grad[, .(mcid, program_grad = program)]
grad[]

start <- DT[, .(mcid, program_start = program)]
start[]
```

Left outer join to filter for students with matching start and grad CIPs. 

```{r}
grad <- start[grad, on = c("mcid")]
grad[]

grad <- grad[program_start == program_grad]
grad[]
```

Recode to prepare for joining row-wise. 

```{r}
grad <- grad[, .(mcid, program = program_start, group = "grad")]
grad[]
```

## Combine starters and graduates

**Binding.** Combine two data frames by matching column names.

```{r}
DT <- rbindlist(list(DT, grad))
DT[]
```

## Add demographics

**Creating variables.** Using columns from student, we add variables for race/ethnicity and sex using a left-outer join. 

```{r}
DT <- student[DT, .(mcid, program, group, race, sex), on = c("mcid")]
DT[]
```

## Group and summarize

```{r}
DT <- DT[, .N, by = c("group", "program", "race", "sex")]
DT[]
```


## Compute metric

Transform. 

```{r}
# Transform to row-record form
DT <- dcast(DT, program + sex + race ~ group, value.var = "N", fill = 0)
DT[]

DT[, rate := round(100 * grad / start, 1)]
DT[]
```

## Prepare for dissemination

We take several additional steps to prepare the data for dissemination in tables or charts.

```{r}
# Preserve anonymity
DT <- DT[grad >= 10]
DT[]

# Filter by study design
DT <- DT[!race %chin% c("International", "Other/Unknown")]
DT <- DT[race == "Hispanic/Latinx", race := "Latine"]
DT[]

DT[, people := paste(race, sex)]
DT[, c("race", "sex") := NULL]
setcolorder(DT, c("program", "people"))
DT[]

DT[, program := fcase(
  program %like% "CE", "Civil",
  program %like% "EE", "Electrical",
  program %like% "ME", "Mechanical",
  program %like% "ISE", "Industrial/Systems"
)]
DT[]

# Convert categorical variables to factors
DT <- order_multiway(DT,
  quantity = "rate",
  categories = c("program", "people"),
  method = "percent",
  ratio_of = c("grad", "start")
)
DT[]
```

## Chart
 
```{r}
#| fig-asp: 1

ggplot(DT, aes(x = rate, y = people)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point() +
  labs(x = "Graduation rate (%)", y = "") 
```

**Reminder.** These are practice data, not research data---suitable for learning about student-record analysis, but not for drawing inferences about program attributes or student experiences.

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r}

```



