---
title: "Graduation rate"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Graduation rate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: |
resource_files: |
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
  fig.path = "../man/figures/art-080-graduation-rate-",
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
```

Graduation rate is a widely used, though flawed, measure of academic performance. 

The American Council on Education estimates that the conventional definition of graduation rate may exclude up to 60% of students at 4-year institutions [@Cook+Hartle:2011]. Nevertheless, as Cook and Hartle explain, 

> ... in the eyes of the public, policy makers, and the media, graduation
> rate is a clear, simple, and logical---if often misleading---number.

Recognizing that graduation rate is a popular metric, we illustrate an improved graduation rate calculation that includes many (though not all) of the students excluded by the conventional definition. 

Users can disregard the First-Year Engineering (FYE) content in this vignette if they are working exclusively with either non-engineering programs or  engineering at non-FYE institutions. For users working with FYE programs, the  [Using FYE proxies](art-071-using-fye-proxies.html) vignette is a prerequisite.  









## Definitions

Graduation rate (general)

: The fraction of starters completing their programs in a timely manner. The specific definitions given below differ in how they define starters, with the MIDFIELD definition being more inclusive. 

IPEDS graduation rate

: In the US, the Integrated Postsecondary Education Data System (IPEDS) defines "graduation rate" as the fraction of a cohort of full-time, first-time, degree-seeking undergraduates who complete their program within a percentage (100%, 150%, or 200%) of the "normal" time (typically 4 years) as defined by the institution. IPEDS excludes students who attend college part-time, who transfer between institutions, and who start in Winter or Spring terms [@IPEDS:2020].   

MIDFIELD graduation rate

: The fraction of a cohort of degree-seeking undergraduates who complete their program in a timely manner (typically 6 years). MIDFIELD includes students who attend college part-time, who transfer between institutions, and who start in any term. The table summarizes the comparison between the IPEDS and MIDFIELD graduation rate definitions. 
   
```{r echo = FALSE}
suppressPackageStartupMessages(library("data.table"))
DT <- wrapr::build_frame(
  "Item", "IPEDS", "MIDFIELD", "MIDFIELD notes" |
    "completion span:", "4, 6, or 8 years", "4, 6, or 8 years", "Typical usage is 6 years" |
    "students admitted in:", "Summer/Fall only", "any term", "" |
    "part-time students are:", "excluded", "included", "Timely completion same as full-time students" |
    "transfer students are:", "excluded", "included", "Timely completion span adjusted for level at entry" 
)

DT |>
  kableExtra::kbl(align = "llll") |>
  kableExtra::kable_paper(lightable_options = "basic", full_width = TRUE) |>
  kableExtra::column_spec(1:2, color = "black", background = "white") |>
  kableExtra::row_spec(c(0), background = "#c7eae5")
```




FYE

: First-Year Engineering program, a common-first-year curriculum that is a prerequisite for declaring an engineering major at some US institutions. Denoted by its own CIP code, FYE is not a degree-granting program. 

FYE proxy

: Our estimate of the degree-granting engineering program in which an FYE student in their first term would have started had they not been required to start in FYE. The proxy, a 6-digit CIP code, acts as a substitute for the FYE CIP code when gathering starters.

migrator

: A student who changes majors. In computing graduation rate, whether a student is a migrator depends on the level at which a "program" is defined: institutional, 2-digit CIP, or 4-digit CIP.  





## Migrators

Migrators are problematic in determining graduation rate. In their first-term program, they count as starters. After migrating however, should they graduate in a timely manner, whether they are included in the count of graduates depends on the CIP level for which graduation rate is calculated. 

**Four possible cases** that depend on CIP level 

- Graduation rate computed at the institution level includes all migrators within the institution. For example, starters Engineering (CIP 14) who graduate in Business (CIP 52) are included in the count of institution graduates. IPEDS defines this rate as the *institution completion rate.*

- Computing at the 2-digit CIP level includes migrator graduates within the same 2-digit CIP and excludes others. For example, starters in Electrical Engineering (CIP 1410) who graduate in Mechanical Engineering (CIP 1419) are included in the count of Engineering graduates (CIP 14). But starters in Engineering graduating in Business (CIP 52) are excluded from the count of Business graduates. 

- Computing at the 4-digit CIP level is similar. For example, starters in Laser and Optical Engineering (CIP 141003) who graduate in Telecommunications Engineering (CIP 141004) are included in the count of Electrical Engineering graduates (CIP 1410). But starters in Electrical Engineering graduating in Mechanical Engineering (CIP 1419) are excluded from the count of Mechanical Engineering graduates. 

- Computing at the 6-digit CIP level excludes all migrator graduates, though this case is rarely used.   

**No extensions for migrators.** Because a migrator may have to complete remedial work in their new program, their time to graduation may exceed the defined acceptable span (typically 6 years). Yet graduation rate as defined has no mechanism for extending the timely completion span. (Developing such a heuristic for MIDFIELD data is a potential topic of future work.)




## Work in progress

The remainder of the vignette is still a work in progress. 


## Population

If you are writing your own script to follow along, we start with these packages:

```{r}
# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))
suppressPackageStartupMessages(library("ggplot2"))

# Printing options for data.table
options(
  datatable.print.nrows = 21,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

**Importing.** Load the midfielddata data tables.

```{r}
# Load data sets from midfielddata
data(student, term, degree)
```

**Filtering.** The steps from previous vignettes ([Data sufficiency](art-010-data-sufficiency.html) and  [Degree seeking](art-020-degree-seeking.html) are reproduced here in condensed form to yield the IDs of all students (in all majors) in the practice data satisfying data sufficiency and degree seeking. 

```{r}
# Create a working data frame, IDs only
DT <- term[, .(mcid)]

# Minimize the dimension
DT <- unique(DT)

# Filter for data sufficiency
DT <- add_timely_term(DT, term)
DT <- add_data_sufficiency(DT, term)
DT <- DT[data_sufficiency == "include"]

# Filter for degree seeking
DT <- DT[, .(mcid)]
DT <- unique(DT)
DT <- student[DT, .(mcid), on = c("mcid"), nomatch = NULL]

# Display the result
DT[]
```

**Subsetting `cip`.** Steps from the [Programs](art-030-programs.html) vignette are reproduced here in condensed form to yield the abbreviated program names and 6-digit CIP codes of the four programs in the case study plus First-Year Engineering (FYE). 

```{r}
# Obtain CIP codes and names
four_programs <- filter_search(
    cip, 
    keep_text = c("140102", "^1408", "^1410", "^1419", "^1427", "^1435", "^1436", "^1437"), 
    select = c("cip6")
    )

# Assign custom program names
four_programs[, program := fcase(
  cip6 %chin% "140102", "FYE", 
  cip6 %like% "^1408", "CE",
  cip6 %like% "^1410", "EE",
  cip6 %like% "^1419", "ME",
  cip6 %chin% c("142701", "143501", "143601", "143701"), "ISE" 
)]

# Display the result
four_programs[]
```

## Gather starters

```{r}
# Inner join for all terms for these IDs
DT <- term[DT, .(mcid, term, cip6), on = c("mcid"), nomatch = NULL]

# Retain initial term
setorderv(DT, cols = c("mcid", "term"))
DT <- DT[, .SD[1], by = c("mcid")]
DT <- DT[, .(mcid, cip6)]

# Display the result
DT[]
```

Extract FYE

```{r}
fye <- DT[cip6 == "140102"]
fye[]

fye <- fye_proxy[fye, .(mcid, proxy), on = c("mcid")]
fye[]

# rejoin
DT <- fye[DT, on = c("mcid")]
DT[]

# Combine all starting CIPs
DT[, start := fcase(
  cip6 == "140102", proxy,
  cip6 != "140102", cip6
)]

# Display the result
DT[]
```





Join the program names and filter. 

```{r}
setnames(four_programs, old = "cip6", new = "start")
DT[]

DT <- four_programs[DT, .(mcid, program), on = c("start")]
DT[]


DT <- DT[!is.na(program)]
DT <- unique(DT)
DT[]
```





```{r}

```
















## stuff

The data set `study_starters` (included with midfieldr) contains the IDs of students starting in four programs (Civil, Electrical, Industrial/Systems, and Mechanical Engineering) after filtering for data sufficiency, degree seeking, and program. Starters include FYE proxies. (Deriving these data from the source data tables is described in [Starters and FYE programs](art-070-fye.html)).

```{r}
# Case study starters
study_starters
```

The data set `study_observations` (included with midfieldr) contains the graduates of the case study programs as well as those ever enrolled, which we ignore for this metric.  (Deriving these data from the source data tables is described in [Case study: Data](art-002-case-data.html)) These graduates have been filtered for timely completion.

```{r}
# Case study graduates
study_observations
```







## Gather starters 2

Our case study starters have already been gathered in `study_starters`. Here we select the two variables we need, rename the program variable to prepare for a merge operation later, and add a `group` variable for later use in grouping and summarizing. 

```{r}
# Create a working data frame
DT <- study_starters[, .(mcid, program)]

# Rename the program variable
setnames(DT, old = "program", new = "program_start")

# Create a group variable
DT[, group := "start"]

# Display the result
DT[]
```









## Gather graduates

Case study graduates are a subset of `study_observations`.   We filter for the graduates and rename the program variable to prepare for a merge operation later. 

```{r}
# Filter for graduates only
grad <- study_observations[group == "grad", .(mcid, program, group)]

# Rename the program variable
setnames(grad, old = "program", new = "program_grad")

# Display the result
grad[]
```

**Adding variables.** We use a left-outer join to add starting programs to the graduates data. An NA represents a graduate not starting in one of the case study programs. 

```{r}
join_cols <- DT[, .(mcid, program_start)]
grad <- join_cols[grad, on = "mcid"]

# Display the result
grad[]
```

**Filtering.** For graduation rate we want graduates who started in their completed program. Retain rows in which start and grad programs match. 

```{r}
grad <- grad[program_start == program_grad]

# Display the result
grad[]
```

The starting program is no longer needed. 

```{r}
# Drop an unnecessary variable 
grad[, program_start := NULL]

# Display the result
grad[]
```










## Combine starters and graduates

**Binding.** Combine two data frames by matching column names. The structure of this data frame is designed to support the upcoming summarizing operation. 

```{r}
# Rename the program variables to match before binding
setnames(DT, old = "program_start", new = "program")
setnames(grad, old = "program_grad", new = "program")

# Combine data tables
DT <- rbindlist(list(DT, grad))

# Display the result
DT[]
```

## Add demographics

**Creating variables.** Using columns from student, we add variables for race/ethnicity and sex using a left-outer join. 

```{r}
DT <- student[DT, .(mcid, program, group, race, sex), on = c("mcid")]

# Display the result
DT[]
```

## Group and summarize

To calculate graduation rate, we want to count the number of students starting in each of our programs and the number of those graduating in their starting programs, grouped by race/ethnicity and sex.

These grouping variables are columns in the data set (race, sex, program, and group)---a structure we designed to support this specific analytical goal. We can now group and summarize in one line of code.

```{r}
# Count by the grouping variables 
DT <- DT[, .N, by = c("group", "program", "race", "sex")]

# Display the result
DT[]
```


## Compute metric

Transform. 

```{r}
# Transform to row-record form
DT <- dcast(DT, program + sex + race ~ group, value.var = "N", fill = 0)

# Display the result
DT[]

DT[, rate := round(100 * grad / start, 1)]

# Display the result
DT[]
```

## Prepare for dissemination

We take several additional steps to prepare the data for dissemination in tables or charts.

```{r}
# Preserve anonymity
DT <- DT[grad >= 10]

# Display the result
DT[]

# Filter by study design
DT <- DT[!race %chin% c("International", "Other/Unknown")]

# Display the result
DT[]

DT[, people := paste(race, sex)]
DT[, c("race", "sex") := NULL]
setcolorder(DT, c("program", "people"))

# Display the result
DT[]

DT[, program := fcase(
  program %like% "CE", "Civil",
  program %like% "EE", "Electrical",
  program %like% "ME", "Mechanical",
  program %like% "ISE", "Industrial/Systems"
)]

# Display the result
DT[]

# Convert categorical variables to factors
DT <- order_multiway(DT,
  quantity = "rate",
  categories = c("program", "people"),
  method = "percent",
  ratio_of = c("grad", "start")
)

# Display the result
DT[]
```

## Chart

Vertical dashed line is the graduation rate for the program as a whole. 
 
```{r grad-rate-people}
#| fig-asp: 1

ggplot(DT, aes(x = rate, y = people)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_vline(aes(xintercept = program_rate), linetype = 2) +
  geom_point() +
  labs(x = "Graduation rate (%)", y = "") 
```

**Reminder.** These are practice data, not research data---suitable for learning about student-record analysis, but not for drawing inferences about program attributes or student experiences.






## References

<div id="refs"></div>






## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r}
# Script
```


```{r}
#| echo: false

# to change the CSS file for block quotes
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    border-left: 0px
}
```


