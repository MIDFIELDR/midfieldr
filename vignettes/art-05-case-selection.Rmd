---
title: "Case selection"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Case selection}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "../man/figures/art-05-case-selection-")
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
```

## Introduction

```{r}
#packages used
library("midfieldr")
library("midfielddata")
library("data.table")
```













## Case study  

In the midfieldr vignettes, we use a case study of four programs (Civil, Electrical, Industrial, and Mechanical Engineering) to illustrate our process of computing persistence metrics. 

The case study begins here, by extracting CIP data for the four engineering programs. 

```{r results = "hide"}
# explore the CIP
sub_cip <- filter_text(cip, keep_text = "engineering", drop_text = "technology")
sub_cip <- filter_text(sub_cip, keep_text = c("civil", "electrical", "industrial", "mechanical"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

The results show that the codes we want are at the 4-digit level:  1408, 1410, 1419, and 1435.

```{r}
# select the case study CIPs
case_study_cip <- filter_text(cip, keep_text = c("^1408", "^1410", "^1419", "^1435"))
```

```{r echo = FALSE}
kable2html(case_study_cip)
```
<br>

The data frame `case_study_cip` concludes this stage of the case study and, in turn, is the input to the next stage. Similar intermediate results conclude every stage of the case study. In each instance, such results are named with the prefix `rep_` (indicating they are associated with  the "representative" case study) and are included as data sets in midfieldr. 

The CIP data frame derived above is the data set `rep_cip` in midfieldr.  View its help page by running

```r
? rep_cip
```

## Extract and label programs

Starting with a CIP subset, we extract the 6-digit codes and label groups of programs to suit our purposes. The result is later used to filter the student-record data sets (students, courses, terms, or degrees) for the analysis at hand.

As you can see in the table above, the program names at the 4-digit level are those associated with accredited engineering departments. Three of these names (Civil, Industrial, and Mechanical) are concise enough for small-multiple or faceted graphs. The Electrical program name is inconveniently long.  

Two approaches to editing the program labels are shown below. 

### 1. Work with one program one at a time

We separate `rep_cip` into four data frames, one for each program. 

```{r}
# work with programs one at a time and bind
# get civil engineering 6-digit codes
cve <- filter_text(rep_cip, keep_text = "^1408", keep_col = "cip6")
cve
```

We operate on the result to create a new column called `program`, used later for grouping, summarizing, and joining. 

```{r}
# add a program label
cve[, program := "Civil Engineering"]
cve
```

Repeat for the other majors

```{r}
# get electrical  engineering
ele <- filter_text(rep_cip, keep_text = "^1410", keep_col = "cip6")
ele[, program := "Electrical Engineering"]
ele

# get mechanical  engineering
mce <- filter_text(rep_cip, keep_text = "^1419", keep_col = "cip6")
mce[, program := "Mechanical Engineering"]
mce

# get industrial engineering
ise <- filter_text(rep_cip, keep_text = "^1435", keep_col = "cip6")
ise[, program := "Industrial Engineering"]
ise
```

We have 4 data frames that we combine row-wise. 

```{r }
# gather the programs in the study
program_group <- rbind(cve, ele, ise, mce)

# examine the result
program_group
```

### 2. Work with all programs in one data frame

Alternatively, we can operate on one data frame throughout. Starting with the 6-digit codes and the 4-digit names, 

```{r}
# work with programs all in one data frame
program_group <- rep_cip[, .(cip6, program = cip4name)]

# examine the result
program_group
```

All but Electrical Engineering have conveniently short program names. We use `startsWith()` to edit the program column for electrical. 

```{r}
# identify the CIP rows that start with 1410
rows_to_edit <- startsWith(program_group$cip6, "1410")

# relabel the electrical programs
program_group[rows_to_edit, program := "Electrical Engineering"]

# examine the result
program_group
```

The program group derived above is the data set `rep_group` in midfieldr.  View its help page by running

```r
? rep_group
```

## Options for the program column

Our goal is to create a data frame with two columns, `cip6` and `program` or equivalent. In this section, we explore several options for assigning program labels.   

### Option 1. Use one of the built-in CIP names 

We can use one of the built-in 2-, 4-, or 6-digit names as follows. 

```{r}
# retain the 2-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip2name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip2name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 4-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip4name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip4name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 6-digit level name
sub_cip <- filter_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip6name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip6name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

### Option 2. Assign any string

CIP program names are occasionally verbose. In such cases, we often use a shortened version of the program name to use as a graph or table heading. In this example, we substitute our own name for the "Parks, Recreation, Leisure and Fitness Studies" programs used in the previous example. 

```{r}
# ignore all default CIP names
sub_cip <- filter_text(cip, keep_text = "^31", keep_col = "cip6")

# assign an arbitrary program name
program_group <- sub_cip[, program := "Leisure Studies"]
```

```{r echo = FALSE}
kable2html(program_group)
```





## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r eval=FALSE}
# packages used
library(midfieldr)
library(data.table)

```
