---
title: "Completion status"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Completion status}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: |
  @Dowle+Srinivasan:2021:data.table
resource_files: |
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
  fig.path = "../man/figures/art-040-completion-",
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})

# accented text
accent <- function (text_string){
    kableExtra::text_spec(text_string, color = "#b35806", bold = TRUE)
}
```

Completion status is required for most metrics because graduation is an important measure of both program success and student success. 




## Definitions

degree completion

: Graduating from a baccalaureate program 

timely completion criterion 

: Completing a program in no more than a specified span of years, in many cases, within 6 years after admission, or possibly less for some transfer students. 




## Method

We determine whether a student completes their program, and in what term, using information in the `degree` table. We determine whether their completion is timely or late by comparing their degree term to their timely completion term. We typically use the result for counting  completers and non-completers. 

This vignette in the MIDFIELD workflow. 

1. Planning  
1. Initial processing  
1. Blocs  
    - Ever-enrolled in programs  
    - Graduates of programs  
    - `r accent("Completion status")`  
    - FYE proxies  
    - Starters in programs  
1. Grouping variables  
1. Metrics  
1. Results  

*Caveat:* The Student Unit Records included with midfieldr and midfielddata are practice data, not research data, suitable for practice working with SURs but not for drawing inferences about program attributes or student experiences.








## Load practice data

*Start a script*. If you are writing your own script to follow along, we use these packages in this vignette:

```{r}
# Completion status
# midfieldr vignette

# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))

# Printing options for data.table
options(
  datatable.print.nrows = 55,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

*Load source data.* MIDFIELD practice data tables as described in [Getting started](art-000-getting-started.html). 

```{r}
# Load practice data sets
data(student, term, degree, package = "midfielddata")
```

*Prepared data.* `study_programs`, included with midfieldr, contains the CIP codes and custom program names for the case study as developed in [Programs](art-030-programs.html#assigning-program-names). 

```{r}
#| collapse: true

# Display prepared data
study_programs
```







## Initial processing

*Optional.* Reduce the dimensions of MIDFIELD data tables. Code reproduced from [Data sufficiency](art-010-data-sufficiency.html). 

```{r}
#| collapse: true

# Optional. Set aside the source files in case they are needed
source_student <- copy(student)
source_term    <- copy(term)
source_degree  <- copy(degree)

# Work with required midfieldr variables only
student <- select_required(source_student)
term    <- select_required(source_term)
degree  <- select_required(source_degree)

# View top few rows of the result
head(student, n = 3L)

head(term, n = 3L)

head(degree, n = 3L)
```


*Copying.* Prevents operations on `DT` from affecting `term` by reference  [@data.table-reference-semantics].

```{r}
# Working data frame
DT <- copy(term)
```

*Data sufficiency.* Obtain the IDs of all students for whom the data sufficiency criteria are satisfied. Code reproduced from [Data sufficiency](art-010-data-sufficiency.html).

```{r}
# Filter for data sufficiency
DT <- add_timely_term(DT, term)
DT <- add_data_sufficiency(DT, term)
DT <- DT[data_sufficiency == "include"]
```

*Degree seeking.* Filter to retain degree-seeking students only.  Code reproduced from [Degree seeking](art-020-data-seeking.html).

```{r}
# Filter for degree seeking
DT <- DT[, .(mcid)]
DT <- unique(DT)
DT <- DT[student, .(mcid), on = c("mcid"), nomatch = NULL]

# Display the result
DT[]
```







## `add_completion_status()` 

Add columns to a data frame of Student Unit Record (SUR) observations that indicate whether a student completed a degree, and if so, whether their completion was timely.

*Arguments*

- **`dframe`** &nbsp; Data frame of student unit record (SUR) observations keyed by student ID. Required variables are `mcid` and `timely_term`.

- **`midfield_degree`** &nbsp; Data frame of SUR degree observations keyed by student ID. Default is `degree`. Required variables are `mcid` and `term_degree`.

*Equivalent usage.*  &nbsp; The following implementations yield identical results,

```{r}
#| collapse: true
# Timely term required before completion status
w <- add_timely_term(DT, term)

# Required arguments in order and explicitly named
x <- add_completion_status(dframe = w, midfield_degree = degree)

# Required arguments in order, but not named
y <- add_completion_status(w, degree)

# Using the implicit default for the midfield_degree argument
z <- add_completion_status(w)

# Equality test between the data tables
all.equal(x, y)
all.equal(x, z)
```


*Output.* &nbsp; Adds the following columns to the data frame. 

- **`term_degree`** &nbsp; Character. Term in which a program is completed. Encoded YYYYT. NA indicates non-completion. 

- **`completion_status`** &nbsp; Character. Completion status: "timely", indicating degree completion no later than the timely completion term; "late", indicating completion after the timely completion term; and "NA" indicating non-completion.

The input `dframe` must have columns for ID and the timely completion term. We use `add_timely_term()` again, though alternatively we could have retained the `timely_term` variable in  earlier code chunks. 

```{r}
# Timely term required before completion status
DT <- add_timely_term(DT, term)

# Drop unnecessary columns
DT[, c("term_i", "level_i", "adj_span") := NULL]

# Add completion status and supporting variables
DT <- add_completion_status(DT, degree)

# Display the result
DT[]
```

Similar to the details described in the data sufficiency vignette, `add_completion_status()` accepts [Alternate source names](art-010-data-sufficiency.html#alternate-source-names) and uses [Silent overwriting](art-010-data-sufficiency.html#silent-overwriting) when existing columns have the same name as one of the added columns. 



### Closer look

Letâ€™s examine three specific observations to illustrate the sense of the results.

```{r}
# Student F
DT[mcid == "MID25783162"]
```

The student has a degree term, Spring 1997 (encoded `19963`) indicating successful completion. Their degree term does not exceed their timely completion term, Spring 1998 (encoded `19973`), so their completion status is "timely".

```{r}
# Student G
DT[mcid == "MID26696871"]
```

This student too has a degree term, Spring 2017 (encoded `20163`) indicating successful completion. Their degree term exceeds their timely completion term, Spring 2016 (encoded `20153`), so their completion status is "late". 

```{r}
# Student H
DT[mcid == "MID26697615"]
```

The student's degree term is NA, indicating they did not complete their program. Thus completion status is NA as well. 







## Common use cases 

### Completion summaries

If our research question requires us to count the frequency of observations by completion status, we can retain all observations and group and summarize.

```{r}
DT[, .N, by = c("completion_status")]
```

Or we might add a second grouping variable. 

```{r}
# Inner join 
x <- student[DT, on = c("mcid"), nomatch = NULL]
setkeyv(x, c("completion_status", "sex"))

# Display the result
x[, .N, by = c("completion_status", "sex")]
```





### Degrees earned

If we need to identify the programs in which students earned degrees, we add a column of degree codes from `degree` and retain selected columns. Rows with NA values indicate non-completion. 

```{r}
# Add CIP of degree earned with left-outer join
DT <- degree[DT, .(mcid, cip6, completion_status), on = c("mcid")]

# Display the result
DT[]
```

If our study requires us to extract timely graduates only, we use completion status as a filter. 

```{r}
# Extracting timely graduates only
DT[completion_status == "timely"]
```








### Filter by program

If we have a particular set of programs such as those developed in the case study vignettes, we can use an inner join to filter by CIP code, which removes the NA (non-completer) observations. 
 
```{r}
# Add program names and retain matching rows
DT <- study_programs[DT, on = c("cip6"), nomatch = NULL]

# Display the result
DT[]
```
 



## Closing

Starting with the student, term, and degree data tables, we filtered the data for data sufficiency and degree seeking. We explored the features of the `add_completion_status()` function and examined how the results might be used. Specific usage depends on the goal of the analysis. 






## References

<div id="refs"></div>






## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 


```{r}
#| eval: false

# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))

# Printing options for data.table
options(
  datatable.print.nrows = 55,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)

# Load data sets from midfielddata
data(student, term, degree, package = "midfielddata")

# Filter for data sufficiency
DT <- copy(term)
DT <- add_timely_term(DT, term)
DT <- add_data_sufficiency(DT, term)
DT <- DT[data_sufficiency == "include"]

# Filter for degree seeking
DT <- DT[, .(mcid)]
DT <- unique(DT)
DT <- DT[student, .(mcid), on = c("mcid"), nomatch = NULL]

# Add completion status
DT <- add_timely_term(DT, term)
DT <- add_completion_status(DT, degree)
DT[, c("term_i", "level_i", "adj_span") := NULL]

# Closer look
DT[mcid == "MID25783162"]
DT[mcid == "MID26696871"]
DT[mcid == "MID26697615"]

# Equivalent statements
x <- add_completion_status(dframe = DT, midfield_degree = degree)
y <- add_completion_status(DT, degree)
z <- add_completion_status(DT)
all.equal(x, y)
all.equal(x, z)

# Using degree data named something else
toy_DT <- toy_student[, .(mcid)]
toy_DT <- add_timely_term(toy_DT, toy_term)
toy_DT <- add_completion_status(toy_DT, toy_degree)
toy_DT[, c("term_i", "level_i", "adj_span") := NULL]

# Caution. Overwriting.
toy_DT <- toy_DT[, c("term_degree", "completion_status") := NULL]
toy_DT <- add_completion_status(toy_DT, toy_degree)

# Completion summaries
DT[, .N, by = c("completion_status")]
x <- student[DT, on = c("mcid"), nomatch = NULL]
setkeyv(x, c("completion_status", "sex"))
x[, .N, by = c("completion_status", "sex")]

# Degrees earned
DT <- degree[DT, .(mcid, cip6, completion_status), on = c("mcid")]
DT[completion_status == "timely"]

# Filter by program
DT <- study_programs[DT, on = c("cip6"), nomatch = NULL]
DT[, .N, by = c("completion_status", "program")]
```


```{r}
#| echo: false

# to change the CSS file
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding:     10px 20px;
    margin:      0 0 20px;
    border-left: 0px
}
caption {
    color:       #525252;
    text-align:  left;
    font-weight: normal;
    font-size:   medium;
    line-height: 1.5;
}
```

