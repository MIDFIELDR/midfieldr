---
title: "Multiway data, graphs, and tables"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multiway data, graphs, and tables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
resource_files:
  - ../man/figures/multiway-fig1-1.png
  - ../man/figures/multiway-fig1-dual-1.png
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = TRUE,
  warning = TRUE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/multiway-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

This article is written with novice R users in mind, so there is much detail that experienced users can skip.   

Packages used in this article: 

```{r message = FALSE}
library("midfieldr")
library("tidyverse")
library("seplyr")
library("knitr")
```

```{r echo=FALSE}
# used by my_session() 
pkg_names <- c("midfieldr", "tidyverse", "seplyr", "knitr")
```

## Introduction

Many persistence metrics can be organized as *multiway data* in which there is is one quantitative variable and two categorical variables. To quote Bill Cleveland [-@cleveland1993], 

> the quantitative variable is a response, and the goal is to study how it depends on the categorical variables, which are factors. What distinguishes multiway data is the cross-classification of the categorical variables; there is a value of the response for each combination of levels of the two categorical variables. 


## Preparing the data 

We'll use the [stickiness metric](stickiness.html) to illustrate multiway graphs and data tables. Stickiness is the ratio of the number of students graduating in a program to the number of students ever enrolled in that program [@stickiness2012]. 

`case_stickiness` is a sample dataset included with midfieldr: 

```{r}
# an example dataset
case_stickiness
```

The stickiness value `stick` is the quantitative variable we want. One  category is the academic `program` variable. The second category, `race_sex`,  will have to be constructed by combining the `race` and `sex` variables. 

We use:  

- `str_c()` to combine the two strings 
- `mutate()`  to add a new column 
- `select()` to select only the three columns needed for the multiway 

```{r}
# combine two variables into one
stickiness <- case_stickiness %.>%
  mutate(., race_sex = stringr::str_c(race, sex, sep = " ")) %.>%
  select(., program, race_sex, stick) %.>%
  glimpse(.)
```

Our `glimpse()` of the data frame shows that we have two categorical variables and one quantitative variable, exactly the form needed. 

## multiway_order()

`multiway_order()`  transforms the character variables `program` and `race_sex` into factors and orders the levels of the two factors by the relevant medians. 

```{r}
# convert the data to a multiway structure
stickiness <- multiway_order(stickiness) %.>%
  glimpse(.)
```

`glimpse()` shows that the two categorical variables are factors.

Optionally, using the `return_medians` argument, the function returns the median values used in ordering the factors. By arranging the rows of the data frame by `program` and `race_sex` factors, we can see that they are ordered by the medians.  

```{r}
# return the median stickiness value for both categories
df <- multiway_order(stickiness, return_medians = TRUE) %.>%
  arrange(., program, race_sex)
df
```

These values can be useful in discussion and for adding median reference lines to a graph.  

## A multiway dot plot  

We use conventional ggplot2 functions to create the multiway graphs. By previously ordering the levels of the factors, we have structured the data so that the rows and panels of the multiway graph are ordered by the appropriate medians. 

For the novice R user, a brief description of the ggplot2 functions: 

- `aes()` assigns `stick` to the x-axis and `race_sex` to the y-axis.  
- `facet_wrap()` conditions the plot by `program`, creating one panel (facet) per program.  
- `as.table = FALSE` lays the panels out like a plot with the highest value at the top.   
- `geom_point()` assigns point data markers. 
- `labs()` assigns axis labels.  
- `theme_midfield()` controls the appearance of the plot, based on a slightly edited  `theme_minimal()`.  

```{r fig1, fig.asp = 2/1.6}
ggplot(data = stickiness, aes(x = stick, y = race_sex)) +
  facet_wrap(~program, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

As Cleveland notes, "We can more effectively compare values within a panel than values between panels." This graph permits a direct visual comparison of how stickiness varies by race and sex for a particular major. .  

## The dual multiway dot plot 

The previous graph does not facilitate visual comparisons of members of the same race-sex group. As Cleveland says,

> Because of this asymmetry, it is often important to explore multiway data by as many multiway dot plots as there are categorical variables, with each variable assigned once to the levels [rows of the panels].

To create the *dual multiway* graph, we swap the roles of the rows and panels. Where before we had 

`y = race_sex` and `facet_wrap(~ program...` 

now we have 

`y = program` and `facet_wrap(~ race_sex...` 

```{r fig1-dual, fig.asp = 2.5/1.6}
ggplot(stickiness, aes(x = stick, y = program)) +
  facet_wrap(~race_sex, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

This graph permits a direct visual comparison of how stickiness varies by major for one group of students. 

## Creating a data table

When discussing the potential stories in multiway data, it is often convenient to have a data table at hand. Such tables facilitate discussion and are occasionally appropriate to include in a publication for editors or reviewers  who want to see the exact values underlying the data graphics. 

Starting with the example data, the first thing to do before tabulating is to reduce the significant figure to an easily-read number and arrange the rows to facilitate looking up a number. 

```{r}
stickiness_table <- case_stickiness %.>%
  mutate(., stick = round(stick, 2)) %.>%
  arrange(., program, sex, race)
```

In many cases we might stop here and print the table for discussion purposes. 

```{r results = "hide"}
kable(stickiness_table, caption = "Stickiness metric")
```

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kableExtra::kable(stickiness_table, format = "html", caption = "Stickiness metric") %.>%
  kableExtra::kable_styling(., font_size = 12)
```

Were to include a table in a publication, we might choose to  

- omit the grad and ever columns 
- recode the `program` variable to avoid repeating the term "Engineering" 
- capitalize the variable names 
- spread the data in wide format 

```{r}
stickiness_table <- stickiness_table %.>%
  select(., program, race, sex, stick) %.>%
  mutate(., program = str_replace(program, " Engineering", "")) %.>%
  select(.,
    "Program" = program,
    "Race" = race,
    "Sex" = sex,
    "Stickiness" = stick
  ) %.>%
  spread(., Program, Stickiness) %.>%
  arrange(., Sex, Race)
```

And print the table to our output document. 

```{r results = "hide"}
kable(stickiness_table, caption = "Stickiness metric")
```

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kableExtra::kable(stickiness_table, format = "html", caption = "Stickiness metric in Engineering") %.>%
  kableExtra::kable_styling(., font_size = 12)
```

## Session information 

```{r echo = FALSE, comment = NA}
# internal function for session information
my_session(pkg_names)
```

<br>
<a href="#top">&#9650; top of page</a>   

## References

<div id="refs"></div>

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a>   

