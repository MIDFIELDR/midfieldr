---
title: "Filter for feasible completion"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Filter for feasible completion}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
link-citations: yes
resource_files:
  - ../man/figures/feasible-completion-relationships-1.png
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = TRUE,
  warning = TRUE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/feasible-completion-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```





## Introduction

Persistence metrics often include a criterion that students complete their programs within $x$ years (typically 6 years, based on 150% of the "normal" time to completion). See, for example, [@ipeds2018]. 

In longitudinal research, this completion criterion requires special care. For student records near the upper limit of an institution's data range, a student's completion status can be ambiguous. Consider a case in which:

- a student matriculates in 2012 and graduates in 2017
- their institution's data range ends in 2016  

The student satisfies the completion criterion, but their recorded degree status is NA because their degree term exceeds the data range. 

Without special care, such students would add to the count of non-graduates, adversely and unfairly affecting the value of a persistence metric. Therefore, if completing their program is not feasible given the range of data available, students with a degree status of NA are excluded from the analysis.

Feasible completion terminology is illustrated in the figure. Definitions are given below. 

<br>

```{r relationships, echo = FALSE, fig.asp = 5/10}
yyyyt <- c(1988, 2005, 2010)
df <- data.frame(yyyyt = yyyyt, y = 1)

library("ggplot2")
callout_color <- "gray60"
callout_line_size <- 0.3
anno_size <- 3.5 # 3.5 approx 10 point
vert_baseline <- 1.07

ggplot(df, aes(x = yyyyt, y = y)) +

  # vertical dimension lines
  geom_segment(aes(x = 1988, xend = 1988, y = vert_baseline, yend = 1.55),
    color = callout_color, size = callout_line_size
  ) +
  annotate("text",
    x = 1988, y = 0.89, size = anno_size,
    label = "first record", hjust = 1, vjust = 0
  ) +
  annotate("text",
    x = 2005, y = 0.89, size = anno_size,
    label = "matriculation limit", hjust = 1, vjust = 0
  ) +
  geom_segment(aes(x = 2005, xend = 2005, y = vert_baseline, yend = 1.3),
    color = callout_color, size = callout_line_size
  ) +
  annotate("text",
    x = 2010, y = 0.89, size = anno_size,
    label = "data limit", hjust = 0, vjust = 0
  ) +
  geom_segment(aes(x = 2010, xend = 2010, y = vert_baseline, yend = 1.55),
    color = callout_color, size = callout_line_size
  ) +

  # horiz arrows
  annotate("text",
    x = 2000, 
    y = 1.55, 
    size = anno_size,
    label = "range of institution's data"
  ) +
  geom_segment(aes(x = 1988, xend = 2010, y = 1.5, yend = 1.5),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +
  annotate("text",
    x = 1992.5, 
    y = 1.26, 
    size = anno_size,
    # label = "entry terms for feasibility"
    label = "matriculate with\ncompletion feasible", 
    hjust = 0, 
    vjust = 0.5
  ) +
  geom_segment(aes(x = 1988, xend = 2005, y = 1.25, yend = 1.25),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +
  annotate("text",
    x = 2007.5, 
    y = 1.26, 
    size = anno_size,
    label = "x\nyears", 
    hjust = 0.5, 
    vjust = 0.5
  ) +
  geom_segment(aes(x = 2005, xend = 2010, y = 1.25, yend = 1.25),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +

  # geom_line(color = callout_color, size = callout_line_size) +
  geom_point(size = 2) +
  scale_x_continuous(limits = c(1980, 2020), breaks = seq(1980, 2020, 10)) +
  scale_y_continuous(limits = c(0.7, 1.7)) +
  labs(
    y = "",
    x = "Start of academic year",
    title = "A representative timeline for feasible completion"
  ) +
  theme_light() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```

<br>

term encoding
: midfielddata terms are encoded numerically  `YYYYT`, where `YYYY` is the year that starts the academic year and `T` is the term index: 1 (Fall), 2 (Winter, quarter systems), 3 (Spring), or 4-6 (summer sessions).

data range
: The span of terms for which student-record data are available, from the "first record" term to the "data limit" term. Varies by institution.

completion feasibility
: A student may complete their program within the data limit. 
  
matriculation limit 
: The last term a student can matriculate and feasibly complete their program. Defined as $x$ years (typically 6 years) before the data limit. Can be advanced by transfer credit hours.





<br>
<a href="#top">&#9650; top of page</a> 





## Subset IDs for feasible completion 

```{r message = FALSE}
# packages used in the vignette
library("midfieldr")
```

A vector of student IDs is required to begin the feasible completion analysis. We choose the set of students ever enrolled in the study programs as the largest possible pool.  

From earlier work in the case study, we have a built-in data set `exa_ever` of the `r length(exa_ever)` student IDs ever enrolled in our case study programs. 

```{r}
# identify the group of students
enrollees_id <- exa_ever

# examine the result
str(enrollees_id)
```

This vector of IDs is the input to `feasible_completion()`, which performs the subsetting for completion feasibility in one call. 

```{r}
# subset IDs for feasible completion
enrollees_fc <- feasible_completion(id = enrollees_id)

# examine the result
str(enrollees_fc)
```

In this instance, we started with `r length(enrollees_id)` enrollees. After applying the criteria for feasible completion, we retain `r length(exa_ever_fc)` students. These students either graduated (demonstrating the feasibility of completing their programs before the data limit) or they matriculated no later than their matriculation limits. 

For continuing work with this case study, these IDs are saved as a data set in midfieldr called `exa_ever_fc`. 




<br>
<a href="#top">&#9650; top of page</a> 





##  What the function is doing

The remainder of the vignette describes the inner workings of  `feasible_completion()`. 


### 1. Gather student degree status

We obtain the degree data for the enrollees using `get_status_degrees()` to subset the student degree data (`midfielddegrees` or equivalent) and return the student degree keyed by ID. The values of `degree` are character, e.g., "Bachelor of Science",  or NA for no degree. 

```{r}
# gather student data for feasible completion 
degree_data <- get_status_degrees(keep_id = enrollees_id)

# examine the result
str(degree_data)
```

Students with degrees have demonstrated that completing their programs before the data limits was feasible. We can extract their IDs (to be used later) and continue the completion feasibility study with the smaller non-graduate student subset. 

```{r}
# subset the grads 
grad_rows <- !is.na(degree_data$degree)
grads     <- degree_data[grad_rows, ]
grads_id  <- grads$id

# subset the nongrads
nongrads     <- degree_data[!grad_rows, ]
nongrads_id  <- nongrads$id

# examine the result
str(grads_id)
str(nongrads_id)
```





### 2. Gather transfer status of non-graduates

We call `get_status_transfers()` for the non-graduates to subset the student attributes data (`midfieldstudents` or equivalent) and return the student matriculation term and transfer credit hours keyed by ID. The values of 
`hours_transfer` are numerical or NA for no transfer hours. 

```{r}
# gather student data for feasible completion 
transfer_data <- get_status_transfers(keep_id = nongrads_id)

# examine the result
str(transfer_data)
```

Joining `transfer_data` to `nongrads` (by `id`) yields the complete student information we need. 

```{r}
# join the student data for feasible completion 
nongrads <- merge(nongrads, transfer_data, all.x = TRUE)

# examine the result
str(nongrads)
```








### 3. Gather institution data limits

`get_institution_limits()` provides the following information we need for feasible completion analysis:

- determines upper data limits from the term-attributes data (default is `midfieldterms`)
- calculates `matriculation limit = data limit - span` (default `span`  is 6 years) 

Some data limits are "rounded down" before computing matriculation limits. Summer term data limits are rounded to the preceding Spring; Winter term data limits (institutions on quarter systems) are rounded to the preceding Fall. 

```{r}
# gather institution data for feasible completion 
institution_limits <- get_institution_limits()

# examine the result
institution_limits
```



### 4. Gather institution hours per term

We determine the median number of credit-hours per term by institution. We use only students with degrees.  

```{r}
# for graduating students, find median hours per term 
hr_per_term <- get_institution_hours_term(keep_id = grads_id)
hr_per_term
```

And we join `hr_per_term` to `institution_limits` (by `institution`) to conclude our institution data gathering. 

```{r}
institutions <- merge(institution_limits, hr_per_term, all.x = TRUE)
institutions
```





### 5. Advance matriculation limit

Joining `nongrads` and `institution_limits` (by `institution`) yields the essential elements we need to advance an institution's matriculation limit by the term-equivalent of any transfer credit hours. 

```{r}
# join student and institution data for feasible completion
fc_data  <- merge(nongrads, institutions, all.x = TRUE)

# examine the result
str(fc_data)
```

Before converting transfer credit hours to their term equivalent, we set all NA values of `hours_transfer` to zero. 

```{r}
rows_to_zero <- is.na(fc_data$hours_transfer)
fc_data$hours_transfer[rows_to_zero] <- 0

# examine the result
str(fc_data)
```

Now we convert transfer credit hours to their term equivalent.  

```{r}
# estimate the term-equivalent of transfer credit hours 
numerator   <- fc_data$hours_transfer
denominator <- fc_data$median_hr_per_term
fc_data$terms_transfer <- floor(numerator / denominator)

# examine the result
str(fc_data)
```

There are several columns we are finished with that we can drop for clarity.

```{r}
# omit columns we are finished using 
fc_data$degree <- NULL
fc_data$data_limit <- NULL
fc_data$institution <- NULL
fc_data$hours_transfer <- NULL
fc_data$median_hr_per_term <- NULL

# examine the result
head(fc_data)
```

Students are typically required to complete at least the final 30-60 credits (about 2 years) in residence at their new institution to earn a degree. Thus for the feasible completion analysis, we limit the transfer terms to 4 or less. 

```{r}
rows_to_limit <- fc_data$terms_transfer > 4
fc_data$terms_transfer[rows_to_limit] <- 4
```

Next we perform some "term arithmetic" to advance the matriculation limit by the number of terms of credit hours transferred. `term_addition()` adds the number of terms T in the `add_col` argument to the terms YYYYT in the `term_col` argument. 

```{r}
fc_data <- term_addition(fc_data, 
                      term_col = "matric_limit", 
                      add_col = "terms_transfer")

str(fc_data)
```

### 6. Filter for feasible completion

Finally, se subset the non-graduates, retaining those whose matriculation term is no later than the matriculation limit.  

```{r}
rows_we_want <- fc_data$term_enter <= fc_data$matric_limit
nongrad_fc   <- fc_data[rows_we_want, ]

str(nongrad_fc)
```

We combine the IDs of these non-grads withe the IDs of the grads saved earlier. The result is the vector of IDs of students from the original pool for whom program completion is feasible. 

```{r}
nongrad_fc_id <- nongrad_fc$id
feasible_id   <- sort(unique(c(grads_id, nongrad_fc_id)))
str(feasible_id)
```

This result is identical to the result obtained earlier using `feasible_completion()`. 









## References

<div id="refs"></div>


## Appendix

### Complete script

```{r eval = FALSE}
# packages used in the vignette
library("midfieldr")


```



<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 
