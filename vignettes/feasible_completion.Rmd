---
title: "Subset for completion feasibility"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Subset for completion feasibility}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
resource_files:
  - ../man/figures/vignette-feasible-completion-fig1-1.png
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "../man/figures/vignette-feasible-completion-")
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
```

## Introduction

Persistence metrics often include a criterion that students complete their programs within $x$ years (typically 6 years, based on 150% of the "normal" time to completion). See, for example, [@IPEDS:2020]. 

In longitudinal research, this completion criterion requires special care. For student records near the upper limit of an institution's data range, a student's completion status can be ambiguous. Consider a case in which:

- a student matriculates in 2012 and graduates in 2017
- their institution's data range ends in 2016  

The student satisfies the completion criterion, but their recorded degree status is NA because their degree term exceeds the data range. 

Without special care, such students would add to the count of non-graduates, adversely and unfairly affecting the value of a persistence metric. Therefore, students with a degree status of NA are excluded from the analysis if completing their program is not feasible given the range of data available. 

Feasible completion terminology is illustrated in the figure. Definitions are given below. 

<br>
```{r fig1, echo = FALSE, fig.asp = 5/10}
yyyyt <- c(1988, 2005, 2010)
df <- data.frame(yyyyt = yyyyt, y = 1)

library("ggplot2")
callout_color <- "gray60"
callout_line_size <- 0.3
anno_size <- 3.5 # 3.5 approx 10 point
vert_baseline <- 1.07

ggplot(df, aes(x = yyyyt, y = y)) +

  # vertical dimension lines
  geom_segment(aes(x = 1988, xend = 1988, y = vert_baseline, yend = 1.55),
    color = callout_color, size = callout_line_size
  ) +
  annotate("text",
    x = 1988, y = 0.89, size = anno_size,
    label = "first record", hjust = 1, vjust = 0
  ) +
  annotate("text",
    x = 2005, y = 0.89, size = anno_size,
    label = "matriculation limit", hjust = 1, vjust = 0
  ) +
  geom_segment(aes(x = 2005, xend = 2005, y = vert_baseline, yend = 1.3),
    color = callout_color, size = callout_line_size
  ) +
  annotate("text",
    x = 2010, y = 0.89, size = anno_size,
    label = "data limit", hjust = 0, vjust = 0
  ) +
  geom_segment(aes(x = 2010, xend = 2010, y = vert_baseline, yend = 1.55),
    color = callout_color, size = callout_line_size
  ) +

  # horiz arrows
  annotate("text",
    x = 2000,
    y = 1.55,
    size = anno_size,
    label = "range of institution's data"
  ) +
  geom_segment(aes(x = 1988, xend = 2010, y = 1.5, yend = 1.5),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +
  annotate("text",
    x = 1992.5,
    y = 1.26,
    size = anno_size,
    # label = "entry terms for feasibility"
    label = "matriculate with\ncompletion feasible",
    hjust = 0,
    vjust = 0.5
  ) +
  geom_segment(aes(x = 1988, xend = 2005, y = 1.25, yend = 1.25),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +
  annotate("text",
    x = 2007.5,
    y = 1.26,
    size = anno_size,
    label = "x\nyears",
    hjust = 0.5,
    vjust = 0.5
  ) +
  geom_segment(aes(x = 2005, xend = 2010, y = 1.25, yend = 1.25),
    color = callout_color,
    size = callout_line_size,
    arrow = arrow(
      type = "closed",
      ends = "both",
      length = unit(2, "mm")
    ),
    arrow.fill = callout_color
  ) +

  # geom_line(color = callout_color, size = callout_line_size) +
  geom_point(size = 2) +
  scale_x_continuous(limits = c(1980, 2020), breaks = seq(1980, 2020, 10)) +
  scale_y_continuous(limits = c(0.7, 1.7)) +
  labs(
    y = "",
    x = "Start of academic year",
    title = "A representative timeline for feasible completion"
  ) +
  theme_light() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
```
<br>

data range
: The range of terms for which student-record data are available, from the "first record" term to the "data limit" term. Varies by institution.

completion feasibility
: A student may complete their program within the data limit. 
  
matriculation limit 
: The last term a student can matriculate and feasibly complete their program. Defined as $x$ years (typically 6 years) before the data limit. Can be advanced by transfer credit hours.


### This vignette uses

midfieldr functions 

- `feasible_subset()`

packages

```{r}
# packages used
library(midfieldr)

# print max 20 rows, otherwise 10 rows each head/tail
options(datatable.print.nrows = 20, datatable.print.topn = 10)
```

## How to use `feasible_subset()`

The first argument, `id`, is required. The remaining arguments all have default settings. The last three arguments accommodate using data sets other than those from midfielddata. Arguments after the ellipsis (...) must be named if used. 

```r
feasible_subset(id,
                ...,
                span,
                term_advance_max,
                data_students,
                data_terms,
                data_degrees)
```


- `id` character vector of student IDs
- `span`  number of years to define feasibility, default is 6 years
- `term_advance_max` maximum terms of transfer credit for advancing the matriculation limit, default is 4 terms (2 years)
- `data_students`  student attributes data set, `midfieldstudents` or equivalent
- `data_terms`  term attributes data set, `midfieldterms` or equivalent
- `data_degrees` degree attributes data set, `midfielddegrees` or equivalent

The primary input to `feasible_subset()` is a character vector of student IDs. To illustrate its use, we use the built-in data set `rep_ever` from the engineering case study as developed in the  *Compute the stickiness metric* vignette [(link)](compute_stickiness.html). 

View its help page by running

```r
? rep_ever
```

The data are loaded with midfieldr. 

```{r}
# view the example IDs
str(rep_ever)
```

This vector of IDs is the input to `feasible_subset()`, which performs the subsetting for completion feasibility.  

```{r}
# filter IDs for feasible program completion within data limit
feasible_id <- feasible_subset(rep_ever)

# examine the result
str(feasible_id)
```

In this instance, we started with `r length(rep_ever)` enrollees. After applying the criteria for feasible completion, we retain `r length(feasible_id)` students. These students either graduated (demonstrating the feasibility of completing their programs before the data limit) or they matriculated no later than their matriculation limits. 

## How `feasible_subset()` works

The remainder of the vignette describes the inner workings of  `feasible_subset()`, showing intermediate results at key stages. Its operation can be divided into 5 basic steps: 

1. Identify graduates and non-graduates by ID 
2. Obtain entering terms and transfer credit hours by ID 
3. Derive matriculation limit and median hours per term by institution 
4. Advance the matriculation limit by transfer credit hours 
5. Filter IDs for feasible completion 

The default data sets queried are from midfielddata, but if desired the arguments of `feasible_subset()` accommodate data sets other than those from  midfielddata. 

```{r include = FALSE}
# load all the fc intermediate results: fc01--fc08
load(system.file("extdata", "fc-vignette-data.rda", package = "midfieldr"))
```

### 1. Identify graduates and non-graduates by ID 

The first data accessed by `feasible_subset()` is `midfielddegrees`. The head and tail of that data are show here.

```{r echo = FALSE}
# degrees data set
fc01
```

The `degree` column is re-coded so that the values are either `grad` or `nongrad`. 

```{r echo = FALSE}
# re-coded degree column
fc02
```

In this step, we use all students in the data set so that later we can use all graduates (not just those in the study) for determining median credit hours per term by institution. 

### 2. Obtain entering terms and transfer credit hours by ID 

The `midfieldstudents` data are accessed next to obtain the entering term and transfer credit hours by student ID for the students in the study only. 

```{r echo = FALSE}
# student matriculation information
fc03
```

### 3. Derive matriculation limit and median hours per term by institution 

The `midfieldterms` data are accessed to obtain the data limits by institution. The `max_term` column is the result of a group and summarize operation.  

```{r echo = FALSE}
# institution data limit
fc04
```

The `span` number of years is subtracted from the maximum term to create the initial matriculation limit. 

```{r echo = FALSE}
# initial matriculation limit
fc05
```

To check the term addition represented here, consider Institution M. The span is 6 years (12 terms) and the last term in the data set is `20096` or summer of 2009-10 academic year. The algorithm rounds down to the spring term `20093` and subtracts the span. The six academic years ending in the Spring 2009-10 are: 2004-05, 2005-06, 2006-07, 2007-08, 2008-09, and 2009-10. Thus the matriculation limit is Fall of 2004, encoded `20041`. 

In the final data query, the function filters `midfieldterms` by the IDs of all graduates in the data set, an ID vector we obtained in the first step. The function then determines the median number of credit hours per term by institution for successful (i.e., graduating) students.  

Joining these results with the previous findings yields the data frame needed to subset for feasible completion.  

```{r echo = FALSE}
# data collection complete
fc06
```

### 4. Advance the matriculation limit by transfer credit hours 

Transfer credit hours are converted to an equivalent number of "transfer terms" by dividing by the median hours per term. The result is capped (default is 4 terms or 2 years) to account for the common institutional policy that the final two years of an undergraduate degree be earned at the degree-granting institution. 

Transfer students' matriculation limits are advanced by the number of transfer terms. The printout shows two students (lines 8 and 10,132) whose matriculation term exceeds the matriculation limit, exemplifying students who are removed from the analysis in the next step. 

```{r echo = FALSE}
# matriculation limit advanced by transfer credit
fc07
```
  
### 5. Filter IDs for feasible completion 

This final data frame is ready for subsetting for feasible completion. All graduates are retained. Non-graduates are retained if their term of entry is no later than their matriculation limit. 


```{r echo = FALSE}
# subset complete for feasible completion
fc08
```

The final output of the function is the ID column from this data frame.  

```{r echo = FALSE}
# resulting ID vector
str(fc08$id)
```

This vector is identical to `feasible_id` described in the first part of the vignette.

## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r eval = FALSE}
# packages used
library(midfieldr)

# part 1:  How to use feasible_subset()
feasible_id <- feasible_subset(rep_ever)

# part 2:  How feasible_subset() works
# no reproducible code
```

