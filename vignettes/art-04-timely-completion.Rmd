---
title: "Timely completion"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Timely completion}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
resource_files:
  - ../man/figures/art-04-timely-completion-fig1-1.png
---

```{r include = FALSE}
knitr::opts_chunk$set(fig.path = here::here("man/figures", 
                                            "art-04-timely-completion-"))
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
asp_ratio_mw <- function(data, categories) {
  cat1 <- categories[1] # panels
  cat2 <- categories[2] # rows
  nlevel1 <- nlevels(data[, get(cat1)])
  nlevel2 <- nlevels(data[, get(cat2)])
  r <- nlevel1 * nlevel2
  q <- 32
  asp_ratio1 <- (r + 2 * nlevel1) / q
  asp_ratio2 <- (r + 2 * nlevel2) / q
  ratios <- c(asp_ratio1, asp_ratio2)
}
```




## Introduction

Students generally expect to complete a program within some span of years after entry. Institutions typically use a 6 year span, based on the IPEDS convention of using 150% of the "normal time" at a 4-year institution to define gradation rate. 

However, the span over which program completion might be considered "timely" is highly dependent on the choices a student makes such as transferring  institutions or changing majors. 

For example, the figure illustrates the history of two students who enter in Fall 2010 and graduate in Spring 2015. We assume a basis of 6 years for timely completion. 

- Student A is a first-time-in-college student with a timely completion (*TC*) term of Spring 2016. Their completion is timely because their degree term comes before their *TC* term.

- Student B is a transfer student, entering as a junior. Having already satisfied 2 years of program requirements, their *TC* term is Spring 2014. Their completion is not timely because their degree term comes after their *TC* term.


<br>
```{r fig1, echo = FALSE, fig.asp = 5/10}
library("ggplot2")
library("data.table")
callout_color     <- "gray60"
callout_line_size <- 0.3
anno_size         <- 3.5 # 3.5 approx 10 point
vert_baseline     <- 1.07

y1    <- 1.5
y2    <- 1.7
y_lim <- c(1.3, 1.8)

x1    <- 1990
x2    <- 1993
x3    <- 1994
x4    <- 1995
x_lim <- c(x1 - 1.5, x4 + 1.5)

# arrows
df_arrow <- wrapr::build_frame(
  "x", "x_end", "y" |
    x1, x4, y2 |
    x1, x2, y1
)
setDT(df_arrow)
df_arrow[, x_mid := (x + x_end) / 2]

# dimension lines
del <- 0.03
dim_lines <- wrapr::build_frame(
  "x", "y", "y_end" |
    x1, y1, y2 |
    x2, y1, y1 |
    x4, y2, y2 |
    x3, y1, y2
)
setDT(dim_lines)
dim_lines[, `:=` (y = y - 2*del, y_end = y_end + del)]

# grad markers
grad <- wrapr::build_frame(
  "x", "y" |
    x3, y1 |
    x3, y2
)

ggplot(data = df_arrow) +
  scale_x_continuous(limits = x_lim, 
                     breaks = c(1990, 1993, 1994, 1995), 
                     labels = c("Fall 2010", "Spr 14", "Spr 15", "Spr 16")) +
  scale_y_continuous(limits = y_lim) +
  labs(
    y = "",
    x = "Term",
    title = "Illustrating timely completion"
  ) +
  theme_light() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  # label start of student row
  annotate("text",
           x = df_arrow$x - 0.6,
           y = df_arrow$y,
           size = anno_size,
           label = c("student A", "student B"), 
 
           vjust = 0.5, 
           hjust = 1
  ) +
  # label end of student row
  # annotate("text",
  #          x = 1995.2,
  #          y = df_arrow$y,
  #          size = anno_size,
  #          label = c("timely", 
  #                    "not timely"),
  #          vjust = 0.5, 
  #          hjust = 0
  # ) +
  # arrows
  geom_segment(aes(x = x, xend = x_end, y = y, yend = y),
               color = callout_color,
               size = callout_line_size,
               arrow = arrow(
                 type = "closed",
                 ends = "both",
                 length = unit(2, "mm")
               ),
               arrow.fill = callout_color
  ) +
  # label arrows
  annotate("text",
           x = df_arrow$x_mid,
           y = df_arrow$y,
           size = anno_size,
           label = "TC span",
           vjust = -0.5
  ) +
  # dimension lines
  geom_segment(data = dim_lines, 
               aes(x = x, xend = x, y = y, yend = y_end),
               color = callout_color,
               size = callout_line_size, 
               linetype = c(1, 1, 1, 2)
  ) +
  # label lines
  annotate("text",
           x = dim_lines$x,
           y = dim_lines$y,
           size = anno_size, 
           label = c("entry term",
                     "TC term",
                     "TC term",
                     "degree term"), 
           vjust = 1,
           hjust = c(-0.1, 1.1, 1.1, -0.1)
  ) +
  # grad points
  geom_point(data = grad, aes(x = x, y = y), 
             size = 2)
```

entry term
: Term in which a student enters the institution from which they earn their first degree. If no degree, the term in which a student enters the last institution in their record. 

timely completion span (TC span)
: Span of years after entry over which program completion would be considered timely. Depends on the heuristic used to evaluate a student's history in the data record. 

timely completion term (TC term)
: Last term for which program completion would be considered timely. The end of the TC span. 

degree term 
: Term in which a student earns their first degree by completing a program. 


### This vignette uses

midfieldr functions 
 
- `()` 

packages

```{r}
# packages used
library("midfieldr")
library("midfielddata")
library("data.table")
library("ggplot2")

# load data tables from midfielddata
data(student, term, degree)

# optional code to control data.table printing
options(datatable.print.nrows = 10, datatable.print.topn = 5)
```





## Estimating the timely completion term

- Simple heuristic: 6 years minus level at entry
- Better: wold account for students like me, transfer, level, switchers




## Applying the timely completion term

- Untimely graduation? Grad reclassified as nongrad
- TC exceeds data limit? Omit students from study 





## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

