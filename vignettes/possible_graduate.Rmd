---
title: "Possible to graduate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Possible to graduate}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
resource_files:
  - ../man/figures/stickiness-fig1-1.png
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = TRUE,
  warning = TRUE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/grad6-possible-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

## Introduction

Students for whom graduation in 6 years is not possible must be excluded from the counts used in many persistence metrics. We refer to this as the "possible to graduate in 6 years" condition (or *pos-grad-6* for short). 

For example, suppose a first-time-in-college, first-year student starts in the Fall of 2010. If 2011 were the last term for which we have data from that institution, then the student's graduation status cannot be known. It follows that this student must be excluded from a count of non-graduates if that count affects the persistence metric, e.g., graduation rate.  

Care must be taken, then, in the first 6-year span and in the final 6-year span of an institution's data to exclude students for whom *pos-grad-6* is false. And different institutions have provided data over different spans of years. 


## Examine the data 

```{r}
library("tidyverse")
library("midfielddata")
library("midfieldr")
```

```{r echo=FALSE}
# used by my_session() 
pkg_names <- c("midfieldr", "midfielddata", "tidyverse")
```

We want `midfieldstudents` for their starting term and transfer status; ``midfieldterms` for their first and last recorded terms, standing, and level; and `midfielddegrees` for the term they are awarded a degree if any.  

```{r}
students <- midfieldstudents %>% 
	select(id, institution, term_enter, transfer)

terms <- midfieldterms %>% 
	select(id, institution, term, level, standing)

degrees <- midfielddegrees %>% 
	select(id, institution, term_degree)
```

Review

```{r}
glimpse(students)
glimpse(terms)
glimpse(degrees)
```

Using terms, find the min and max terms in the data for each institution

```{r}
options(tibble.print_min = 12L)
this_group <- group_by(terms, institution)
inst_span  <- summarize(
	this_group, 
	inst_min = min(term), 
	inst_max = max(term)
	) %>% 
	arrange(inst_min)

inst_span
```

For the 6-year span at the end of an institution's data span, all graduates can be counted---the non-graduates must be checked for pos-grad-6. 

Separate grads from non-grads. 

```{r}
pos_grad6_id <- degrees %>% 
	filter(!is.na(term_degree)) %>% 
	select(id)

non_grads <- degrees %>% 
	filter(is.na(term_degree)) %>% 
	unique()
```

Confirm that the student IDs are unique. 

```{r}
glimpse(pos_grad6_id)
length(unique(pos_grad6_id$id))

glimpse(non_grads)
length(unique(non_grads$id))
```

Join the student's entering term and transfer status and the institution's last term with the non-grads. 

```{r}
non_grads <- non_grads %>% 
	left_join(., students, by = c("id", "institution")) %>% 
	left_join(., inst_span, by = "institution") %>% 
	select(id, institution, transfer, inst_max, term_enter) %>% 
	mutate(delta = inst_max - term_enter)

non_grads

sort(unique(non_grads$delta))
```
 
If the $\Delta \geq 60$ then clearly it was possible for a student to graduate in 6 years. Add the keepers to the pos-grad-6 set of IDs.

```{r}
keepers <- non_grads %>% 
	filter(delta >= 60) %>% 
	select(id) 

pos_grad6_id <- bind_rows(pos_grad6_id, keepers)
glimpse(pos_grad6_id)
```

The group of non-grads that remains needs further study

```{r}
study_group <- non_grads %>% 
		filter(delta < 60)

study_group
```

Let's start by separating transfers and non-transfers. Non-transfers with $\Delta < 60$ will be assumed to not satisfy pos-grad-6. Their IDs will be excluded from further analysis. 

```{r}
non_transfer <- study_group %>% 
	filter(transfer == "N")

exclude_id <- non_transfer
exclude_id
```

For the transfer students, the length of time from their entering term to the last term in the institution data depends on their entering status. Join level and standing from terms data. 
 
```{r}
transfer <- study_group %>% 
	filter(transfer == "Y") %>% 
	left_join(., terms, by = c("id", "institution")) %>% 
	select(id, delta, term_enter, term, level, standing) 

transfer
```

Transfers meeting any of these criteria satisfy the pos-grad-6 condition. 

- level is Freshman and $\Delta >= 55$ 
- level is Sophomore and $\Delta >= 45$ 
- level is Junior and $\Delta >= 35$ 
- level is Senior and $\Delta >= 25$ 

```{r}
keepers <- transfer %>% 
	filter((level == "Freshman"   & delta > 50) | 
				 	(level == "Sophomore" & delta > 40) |
				 	(level == "Junior"    & delta > 30) |
				 	(level == "Senior"    & delta > 20)
				 )

keepers
```



## Issue bin


By institution, last term_enter that a student could matriculate and have 6 years’ worth of data:


- Institution A, Institution E, Institution K, Institution H – 19981  
- Institution F, Institution G – 19991  
- Institution B, Institution M, Institution J – 20041  
- Institution C, Institution D – 20101  
- Institution L – 20111  


## Session information 

```{r echo = FALSE, comment = NA}
# internal function for session information
my_session(pkg_names)
```

<br>
<a href="#top">&#9650; top of page</a>   

## References

<div id="refs"></div>

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="index.html"   >&#9665; vignettes index </a>  
<a href="../index.html">&#9665;       main page </a> 
