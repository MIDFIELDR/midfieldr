---
title: "Data sufficiency"
author: "Richard Layton"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Data sufficiency}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: | 
resource_files: |
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
    fig.path = "../man/figures/art-010-data-sufficiency-", 
    fig.width = 6,
    fig.asp = 1 / 1.6,
    out.width = "70%",
    fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
```

The time span (or range) of MIDFIELD data varies by institution. At the upper and lower limits of a data range, a potential for false counts exists when a metric (such as graduation rate) requires knowledge of timely program completion.  For such metrics, student records that produce problematic results are nearly always excluded from study. 

## Definitions

data range

: The overall span of academic terms of student unit record data provided by an institution. The lower limit is the first non-summer term; the upper limit is the last non-summer term.   

timely completion term  

: The last term in which a student's program completion would be considered timely. In many cases the timely completion (TC) term is 6 years after admission. The TC term can be adjusted to account for transfer credits. (Currently, we do not include an adjustment for co-ops.)

data sufficiency criterion

: Student records are limited to those for which available data are sufficient to assess timely completion without biased counts of completers or non-completers. 




## Upper-limit data sufficiency

For students admitted too near the upper limit of their institutionâ€™s data range, the available data cover an insufficient number of years to know if completion is timely. To illustrate, in the figure we compare two students admitted in different terms with representative time spans shown for timely completion. In this scenario, we assume institution data is available from 1986 to 1996.

<br>

![](../man/figures/art-010-data-sufficiency-upper.png){width="80%"}

<br>

Student A

: Student A enters in 1988 with a timely completion (TC) term in 1994.  In both of the following cases, the data sufficiency criterion is satisfied and the records are included in a study.

- A-1: First time in college (FTIC), so we know their first term is their entry term (i.e., they are not a continuing student) and we can determine their TC term.
- A-2: Transfer student, and we know their first term in a MIDFIELD institution. We have no knowledge of how much time was spent accumulating their pre-MIDFIELD credit hours, but we can estimate a TC term with respect to their MIDFIELD entry level. 

Student B

: Student B enters in 1993 with a TC term in 1998, two years beyond the range of the data. We have several possible cases,  

- B-1: Before the data limit, the student completes their program (timely and known)
- B-2: Before the data limit, the student leaves the data base (untimely and known)
- B-3: After the data limit, the student completes before their TC term (timely but unknown)
- B-4: After the data limit, the student completes after their TC term  or fails to complete  (untimely and unknown)     

Because of unknown outcomes in cases B-3 and B-4, including case B-1 and B-2 invariably produces a miscount of completers and non-completers. Thus the criterion is not satisfied and student B records are excluded from the study.




## Lower-limit data sufficiency

To determine data sufficiency record exclusions at the lower limit of the data range, we compare a student's first term (non-summer) to the first term of the data range (also non-summer). When these two terms are identical, the complete unit record is excluded. We illustrate with the three scenarios described below. 

<br>

![](../man/figures/art-010-data-sufficiency-lower.png){width="80%"}

<br>

Student C

: Student C makes their first appearance in the database in a term following the data lower limit. The conditions for student C (FTIC or transfer) are identical to those for student A, thus student C is included in a study. 

Student D

: Student D enters the institution before the lower limit of the data range (a "continuing" student) or they enter the institution at the lower limit precisely.  

- D-1: If student D is continuing, regardless of status (FTIC or transfer), making an estimate of their TC term invariably leads to false counts because we have no knowledge of how much time was spent accumulating credit hours at their MIDFIELD institution before the lower data limit. Including D-1 also produces false counts because of student E (discussed below). 
- D-2: If student D is not continuing, that is, their first time entry to a MIDFIELD institution is at the lower data limit (here, 1986), we would include them in a study if we could. Unfortunately, we cannot distinguish them from continuing students. Having to exclude D-1 inherently excludes D-2 as well. 

Student E

: Student E enters the institution at the same time as continuing student D but leaves the database before the data lower limit term.

- E-1: Student E did not timely-complete their program. In this case, if we include student D our count of *non-completers* is low (E-1 cases are missing), resulting in an inflated ratio of completers to non-completers.
- E-2: Student E did timely-complete their program. Here, if we include student D our count of *completers* is low (E-2 cases are missing), resulting in a diminished ratio of completers to non-completers. 

The balance of these two effects is unknowable. Since student E cannot possibly be included, Student D must also be excluded.





## Method

The data sufficiency criterion is applied when a metric requires counting the number of students who complete their programs in a timely fashion. Specific student unit records at the upper and lower limits of an institution's data range must be excluded to prevent false counts due to insufficient data. 

The method for applying the data sufficiency criterion is to exclude observations that 

- are present in the non-summer lower limit of the institution data range 
- have a timely completion term that exceeds the upper limit of the data range

This is the method implemented by `add_data_sufficiency()`. 



## Begin analysis with `term`

Of the four MIDFIELD data tables, `course` and `term` are the most inclusive, with observations of all students enrolled in a course in a term. Since `term` is the smaller of the two, we generally start an analysis with the term data frame. 

If you are writing your own script to follow along, we start with these packages: 

```{r}
# set echo for example
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

 

**Importing.** Load the midfielddata data table. Copy the `term` data set to create the working data frame (`DT`), leaving `term` unaltered for later use. 

```{r}
# Load data set from midfielddata
data(term)

# Create a working data frame
DT <- copy(term)
str(DT)
```

The result has `r nrow(DT)` observations. We will usually note the number of observations as they change. 

To apply the data sufficiency criterion, two variables are required: a student's ID and their timely completion term. Though not required for data sufficiency, most studies require that we also retain the CIP code of the students' programs. 

**Filtering.** At this point, many studies require at a minimum the student ID and their program CIP. 

```{r}
# Retain the minimum number of columns
DT <- DT[, .(mcid, cip6)]
```

In this form, the data frame will have duplicate rows for the multiple terms in which a student is enrolled in a program. We filter for unique combinations of ID and program CIP code. 

```{r}
DT <- unique(DT)
DT[]

# Count unique IDs
length(unique(DT$mcid))
```

The result has `r nrow(DT)` observations of `r length(unique(DT$mcid))` unique students. The number of unique students is smaller than the number of observations because some students change programs over their course of study. 

## Timely completion term

Starting with a data frame of Student Unit Record (SUR) observations (like `DT` above) that includes an ID variable, we add a timely completion term column using `add_timely_term()`. Its arguments are: 

`dframe`

: Data frame of student unit record (SUR) observations keyed by student ID. Required variable (column) is `mcid`.

`midfield_term`	

: Data frame of SUR term observations keyed by student ID. Default is `term`. Required variables (columns) are `mcid`, `term`, and `level`. 

`span`	

: Optional integer scalar, number of years to define timely completion. Commonly used values are are 100%, 150%, and 200% of `sched_span`. Default 6 years.

`sched_span`

: Optional integer scalar, the number of years an institution officially schedules for completing a program. Default 4 years.

The function adds four columns to the SUR data frame: the `timely_term` result  plus three supporting variables:  

- `term_i` is the initial term of a student's longitudinal record, encoded YYYYT 
- `level_i` is the student level (01 Freshman, 02 Sophomore, etc.) in their initial term
- `adj_span` is the integer span of years for timely completion adjusted for a student's initial level

```{r}
# Display timely term and supporting variables 
add_timely_term(DT, midfield_term = term)
```

Use the first row to check the results. The student's initial term is Fall 1991 (encoded `19911`) and their initial level is `01 Freshman`. The number of years to timely completion is 6 years, that is, academic years 1991--92, 92--93, 93--94, 94--95, 95--96, 96--97. Thus their timely completion term is Spring 1997 (encoded `19963`) which agrees with the result shown. 

In the next-to-last row, a student's initial term is Spring 2017 (encoded `20163`) and their initial level is `04 Senior` from which we infer they have completed three years of their program, yielding an adjusted span of 3 years. Those three years would encompass terms `20163`--`20171`, `20173`--`20181`, and `20183`--`20191`, yielding a timely completion term of Fall 2019 (encoded `20191`) as shown. 

In usage, the following implementations yield identical results, 

```{r}
#| collapse: true
# Required arguments in order and explicitly named 
x <- add_timely_term(dframe = DT, midfield_term = term)

# Required arguments in order, but not named   
y <- add_timely_term(DT, term)

# Using the implicit default for the midfield_term argument
z <- add_timely_term(DT)

# Equality test between two data tables
all.equal(x, y)
all.equal(x, z)
```

If your term data set is named something other than `term`, the second argument is required. For example, using the "toy" data sets bundled with midfieldr and used in function examples, 

```{r}
add_timely_term(toy_student[, .(mcid)], toy_term)
```

In the vignettes, I will typically write the following to remind the user which of the midfielddata data sets is bing called upon. 

```{r}
DT <- add_timely_term(DT, term)
```

You can view the function help page by running in the Console, 

    # Run in Console to view help page
    ? add_timely_term()
