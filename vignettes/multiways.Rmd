---
title: "Multiway data and graphs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multiway data and graphs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: ../inst/REFERENCES.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE, 
  fig.width = 6, 
  fig.asp = 1/1.6, 
  out.width = "70%",  
  fig.align = "center"
)

knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 10L, tibble.print_max = 10L)
```


```{r message = FALSE}
library(midfieldr)
library(dplyr)
library(ggplot2)
library(tidyr)
```


Stickiness data can be organized as *multiway data.* There is one quantitative variable, stickiness, and two categorical variables, program and the students' race-sex group. To quote Bill Cleveland [-@cleveland1993], 

> the quantitative variable is a response, and the goal is to study how it depends on the categorical variables, which are factors. What distinguishes multiway data is the cross-classification of the categorical variables; there is a value of the response for each combination of levels of the two categorical variables. 

In this case, there is one value of stickiness for each combination of program and student race-sex group. 

Before computing medians and ordering the data, we select the populations we are interested in. For example, we might omit students for whom the "race" designation is ambiguous. This step could have been taken earlier, but must be taken (if at all) before using `multiway_order()`. 

```{r}
# stickiness is an example dataset
glimpse(case_stickiness) 

stickiness <- case_stickiness %>% 
	filter(!race %in% c("Unknown", "International", "Other"))
```

Save this version of the data for later table printing.

```{r}
table_stickiness <- stickiness
```

We combine race and sex into a single variable using `str_c()`  from the stringr package. This is necessary to create the multiway data structure required by `multiway_order()`.

```{r}
# combine two variables into one
stickiness <- stickiness %>% 
	mutate(race_sex = stringr::str_c(race, sex, sep = " ")) %>% 
	select(program, race_sex, stick)

glimpse(stickiness)
```

Our `glimpse()` of the data frame shows that we have two categorical variables and one quantitative variable, exactly the form needed. 

`multiway_order()`  transforms the character variables `program` and `race_sex` into factors and orders the levels of the two factors by the relevant medians. 

```{r echo = FALSE}
library(forcats)
multiway_order <- function(df) {
	stopifnot(is.data.frame(df))
	
	# obtain type of variables to distinguish numeric from other
	var_class <- purrr::map_chr(df, class)
	
	# must have only three variables
	var_len <- max(seq_along(var_class))
	stopifnot(exprs = {var_len == 3})
	
	# only one numeric value
	value_idx <- var_class[var_class == "numeric"]
	value_len <- max(seq_along(value_idx))
	stopifnot(exprs = {value_len == 1})
	
 # two categorical variables, either character or factor
	cat_idx <- var_class[var_class == "character" | var_class == "factor"]
	cat_len <- max(seq_along(cat_idx))
	stopifnot(exprs = {cat_len == 2})
	
	# names of the 3 variables as symbols 
	# are used in grouping, summarizing, and joining
	cat1  <- rlang::sym(names(cat_idx)[[1]])
	cat2  <- rlang::sym(names(cat_idx)[[2]])
	value <- rlang::sym(names(value_idx)[[1]])

	# determine medians grouped by first category
  medians <- df %>%
  	dplyr::group_by(!!cat1) %>%
  	dplyr::summarize(med = median(!!value, na.rm = TRUE)) %>%
  	dplyr::ungroup()
  
  # create first factor and order by the median values
  df <- dplyr::left_join(df, medians, by = dplyr::quo_name(cat1)) %>% 
  	dplyr::mutate(!!cat1 := forcats::fct_reorder(!!cat1, med))%>% 
  	dplyr::select(-med)
 
  # determine medians grouped by first category
  medians <- df %>%
  	dplyr::group_by(!!cat2) %>%
  	dplyr::summarize(med = median(!!value, na.rm = TRUE)) %>%
    dplyr::	ungroup() 
  
  # create second factor and order by the median values
  df <- dplyr::left_join(df, medians, by = dplyr::quo_name(cat2)) %>% 
  	dplyr::mutate(!!cat2 := forcats::fct_reorder(!!cat2, med))%>% 
  	dplyr::select(-med)
}
```

```{r}
# convert the data to a multiway structure
stickiness <- multiway_order(stickiness)

glimpse(stickiness)
```

`glimpse()` shows that the two categorical variables are factors. To see the order of the levels of the new factors,

```{r echo = FALSE}
# quietly extract the dimensions of the two categories
n_cat1 <- max(seq_along(unique(stickiness[["program"]])))
n_cat2 <- max(seq_along(unique(stickiness[["race_sex"]])))
```

```{r}
# programs ordered by median stickiness from least to most
levels(stickiness[["program"]])
```

Thus, comparing just these majors, `r levels(stickiness[["program"]])[1]` is the least sticky and `r levels(stickiness[["program"]])[n_cat1]` the most sticky.  

```{r}
# race-sex groups ordered by median stickiness from least to most
levels(stickiness[["race_sex"]])
```

Among the student groups, `r levels(stickiness[["race_sex"]])[1]` is the least sticky and `r levels(stickiness[["race_sex"]])[n_cat2]` the most sticky. 

The data are ready for graphing. 

## Graphing the multiway

We use conventional ggplot2 functions to create the multiway graphs. 

By previously ordering the levels of the factors, we have structured the data so that the rows and panels of the multiway graph are ordered by the appropriate medians. 

```{r fig.asp = 2/1.6}
ggplot(stickiness, aes(x = stick, y = race_sex)) +
	facet_wrap(~ program, ncol = 1, as.table = FALSE) +
	geom_point(na.rm = TRUE) +
	labs(x = "Stickiness", y = "") +
	midfield_theme() 
```

## Graphing the dual multiway

```{r fig.asp = 1.4/1.6}
ggplot(stickiness, aes(x = stick, y = program)) +
	facet_wrap(~ race_sex, ncol = 2, as.table = FALSE) +
	geom_point(na.rm = TRUE) +
	labs(x = "Stickiness", y = "") +
	midfield_theme() 
```

## Sharing the printed data

```{r results = "hide"}
df <- table_stickiness %>% 
	mutate(stick = round(stick, 2)) %>% 
	mutate(program = stringr::str_replace(program, "Engineering", "")) %>% 
	select("Sex" = sex, "Race" = race, program, stick) %>% 
	spread(program, stick) %>% 
	arrange(Sex, Race)
knitr::kable(df)
```

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kableExtra::kable(df, "html") %>% kableExtra::kable_styling(font_size = 12)
```

## References
