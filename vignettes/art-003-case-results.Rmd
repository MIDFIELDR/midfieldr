---
title: "Case study: Results"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Case study: Results}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: |
  @Dowle+Srinivasan:2021:data.table,
  @Wickham:2016:ggplot2
resource_files: 
  - man/figures/art-003-case-results-fig-stickiness-01-1.png
  - man/figures/art-003-case-results-fig-stickiness-02-1.png
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
  fig.path = "../man/figures/art-003-case-results-",
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
```

Part 2 of a case study in three parts, illustrating how we work with longitudinal Student Unit Records (SUR). 

1. [Goals.](art-001-case-goals.html) Briefly describe the study.   

2. [Data.](art-002-case-data.html) Transforming the data to yield the observations of interest.

3. Results (this page). Calculating summary statistics and metrics and displaying the results. 


## Method 

Our goal in this segment is to group and summarize the observations we saved previously, calculate the stickiness metric, and display the results. 

*Caveat.*  &nbsp; The data in ‘midfielddata’ are practice data, suitable for learning to work with Student Unit Records (SURs) generally. Unlike the MIDFIELD research database, the data tables in ‘midfielddata’ are not research data; they are not suitable for drawing inferences about program attributes or student experiences.



## Load practice data

*Start a script*. If you are writing your own script to follow along, we use these packages in this vignette:

```{r}
# Case study: Results
# midfieldr vignette

# Packages
library("midfieldr")
library("data.table")
library("ggplot2")

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

*Prepared data.* `study_observations`, included with midfieldr, contains post-processed observations of students ever enrolled in, and students  graduating from, the case study programs as developed in [Case study: Data](art-002-case-data.html).

```{r}
# View prepared data
study_observations
```

## Group and summarize

*Copying.* Prevents operations on `DT` from affecting `study_observations` by reference [@data.table-reference-semantics].

```{r}
# Working data frame
DT <- copy(study_observations)

# Display the result
DT[]
```

To calculate stickiness, we want to count the number of students ever enrolled in each of our programs and the number of students graduating from the programs, grouped by race/ethnicity and sex.

These grouping variables are columns in the data set (`race`, `sex`, `program`, and `group`)---a structure we designed to support this specific  analytical goal. We can now group and summarize in one line of code. 

```{r}
# Group and summarize
DT <- DT[, .N, by = c("group", "program", "race", "sex")]

# Display the result
DT[]
```




## Compute metric

Stickiness is the ratio of the number of graduates to the number of students ever enrolled in a program. To be able to divide `grad / ever` we would like these two values to be in the same row. The `dcast()` function accomplishes that for us. 

This operation is essentially a transformation from block records to row records---a process known by a number of different names, e.g., pivot, crosstab, unstack, spread, or widen [@Mount+Zumel:2019:fluid-data].  This step  leaves the graphing variables (program, race/ethnicity, and sex) in place. 

```{r}
# Transform to row-record form
DT <- dcast(DT, program + sex + race ~ group, value.var = "N", fill = 0)

# Display the result
DT[]
```

We calculate percent stickiness. 

```{r}
# Compute the metric
DT[, stick := round(100 * grad / ever, 1)]
setkey(DT, NULL)

# Display the result
DT[]
```

*Verify built-in data.* To avoid deriving this data frame each time it is needed in other vignettes, the same information is provided in the `study_results` data frame included with midfieldr. Here we verify that the two data frames are identical. 

```{r}
#| collapse: true

# Demonstrate equivalence
same_content(DT, study_results)
```



## Prepare for dissemination

We take several additional steps to prepare the data for dissemination in  tables or charts.  

*Filtering.* To preserve the anonymity of the people involved, we remove observations with 10 or fewer graduates.   

```{r}
# Preserve anonymity
DT <- DT[grad >= 10]

# Display the result
DT[]
```

*Filtering.* Let us assume that our study focuses on "domestic" students of known race/ethnicity. In that case, we omit observations labeled "International" and Other/Unknown". 

```{r}
# Filter by study design
DT <- DT[!race %chin% c("International", "Other/Unknown")]

# Display the result
DT[]
```

*Creating variables.* We have found it useful to report such data with a variable that combines race/ethnicity and sex. 

```{r}
# Create a variable
DT[, people := paste(race, sex)]
DT[, c("race", "sex") := NULL]
setcolorder(DT, c("program", "people"))

# Display the result
DT[]
```

*Recoding values.* Readers can more readily interpret our charts and tables if the programs are unabbreviated. 

```{r}
# Recode values for charts and tables
DT[, program := fcase(
  program %like% "CE", "Civil",
  program %like% "EE", "Electrical",
  program %like% "ME", "Mechanical",
  program %like% "ISE", "Industrial/Systems"
)]

# Display the result
DT[]
```

With one quantitative variable (stickiness) for every combination of the levels of two categorical variables (program and race/ethnicity/sex), these data are *multiway data* [@Cleveland:1993]. How one orders the categorical variables is critical for visualizing effects. 

*Conditioning.* Convert the two categorical variables to ordered factors to support the ordering of rows and panels in the chart. We use the midfieldr `order_multiway()` function. 

```{r}
# Convert categorical variables to factors
DT <- order_multiway(DT,
  quantity = "stick",
  categories = c("program", "people"),
  method = "percent",
  ratio_of = c("grad", "ever")
)

# Display the result
DT[]
```


The column `program_stick` determines the order of the programs in the chart; `people_stick` determines the order of the race/ethnicity/sex groupings; the values in `stick` are the quantitative values to be graphed. 




## Charts

In the first multiway chart, the rows are programs and panels are people, facilitating comparisons of different program for a single group. Rows and panels are both ordered from bottom to top in order of increasing stickiness. 

```{r}
#| label: fig-stickiness-01
#| fig-asp: 1.2

ggplot(DT, aes(x = stick, y = program)) +
  facet_wrap(vars(people), ncol = 1, as.table = FALSE) +
  geom_point() +
  labs(x = "Stickiness (%)", y = "")
```

Alternatively, we can consider the dual chart, swapping the roles of the panels and rows.  Here the rows are people and panels are programs, facilitating comparisons of different people within a program.  Over many years of publishing research using MIDFIELD data, placing people on the rows of the multiway chart has been perhaps our most frequently used design. 

```{r}
#| label: fig-stickiness-02
#| fig-asp: 1

ggplot(DT, aes(x = stick, y = people)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point() +
  labs(x = "Stickiness (%)", y = "")
```

The chart illustrates the importance of ordering the rows and panels. We would conclude that Industrial/Systems Engineering is the stickiest program of the four, followed by Civil, Mechanical, and Electrical in descending order. 

Because rows are ordered, one expects a generally increasing trend within a panel. A response greater or smaller than expected creates a visual asymmetry. For example, Asian Female students are asymmetrically higher in Mechanical Engineering but asymmetrically lower in Industrial/Systems Engineering. 




## Tables

Data tables are often needed for publication. In this example, we format the data in a conventional row-record form with the groups of people in the first column labeling the rows and the program names labeling the remaining columns. 

```{r}
# Select the columns I want for the table
tbl <- DT[, .(program, people, stick)]

# Change factors to characters so rows/columns can be alphabetized
tbl[, people := as.character(people)]
tbl[, program := as.character(program)]

# Transform from block records to row records
tbl <- dcast(tbl, people ~ program, value.var = "stick")

# Edit one column header
setnames(tbl, old = "people", new = "People", skip_absent = TRUE)
```

Groups with numbers below our reporting threshold are denoted NA or omitted. 

```{r}
#| echo: false

tbl |>
  kableExtra::kbl(
    align = "lrrrr",
    caption = "Table 1: Program stickiness (%)"
  ) |>
  kableExtra::kable_paper(lightable_options = "basic", full_width = TRUE) |>
  kableExtra::row_spec(0, background = "#c7eae5") |>
  kableExtra::column_spec(1:5, color = "black", background = "white")
```





## Closing

Starting with the prepared data (the case study observations), we compute longitudinal stickiness for four programs (Civil, Electrical, Industrial/Systems, and Mechanical Engineering) grouped by program, race/ethnicity, and sex. 

Pre-dissemination results are written to file for possible later use. We filter selected records and create a data table and charts for dissemination. 


## References

<div id="refs"></div>







## Appendix

### Complete script

The case study code chunks are collected below in a single, condensed script. 

```{r}
#| eval: false

# Packages
library("midfieldr")
library("data.table")
library("ggplot2")

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)

# Copy the case study observations
DT <- copy(study_observations)

# Group and summarize
DT <- DT[, .N, by = c("group", "program", "race", "sex")]

# Compute the metric
DT <- dcast(DT, program + sex + race ~ group, value.var = "N", fill = 0)
DT[, stick := round(100 * grad / ever, 1)]

# Prepare for dissemination
DT <- DT[grad >= 10]
DT <- DT[!race %chin% c("International", "Other/Unknown")]
DT[, people := paste(race, sex)]
DT[, c("race", "sex") := NULL]
setcolorder(DT, c("program", "people"))
DT[, program := fcase(
  program %like% "CE", "Civil",
  program %like% "EE", "Electrical",
  program %like% "ME", "Mechanical",
  program %like% "ISE", "Industrial/Systems"
)]

# Convert categorical variables to factors
DT <- order_multiway(DT,
  quantity = "stick",
  categories = c("program", "people"),
  method = "percent",
  ratio_of = c("grad", "ever")
)

# Chart 1
ggplot(DT, aes(x = stick, y = program)) +
  facet_wrap(vars(people), ncol = 1, as.table = FALSE) +
  geom_point() +
  labs(x = "Stickiness (%)", y = "")

# Chart 2
ggplot(DT, aes(x = stick, y = people)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point() +
  labs(x = "Stickiness (%)", y = "")

# Table
tbl <- DT[, .(program, people, stick)]
tbl[, people := as.character(people)]
tbl[, program := as.character(program)]
tbl <- dcast(tbl, people ~ program, value.var = "stick")
setnames(tbl, old = "people", new = "People", skip_absent = TRUE)
```


```{r}
#| echo: false

# to change the CSS file
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding:     10px 20px;
    margin:      0 0 20px;
    border-left: 0px
}
caption {
    color:       #525252;
    text-align:  left;
    font-weight: normal;
    font-size:   medium;
    line-height: 1.5;
}
```
