---
title: "Tabulating data"
author: "Richard Layton"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/ieee-with-url.csl
vignette: >
  %\VignetteIndexEntry{Tabulating data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: | 
resource_files: |
---


```{r setup, include = FALSE}
source("article-preamble.R")
set_fig_path("art-060-tabulating-data-")
```


## Introduction 

Data for analysis and graphing are often laid out in "block record" or "long" form with every key variable and response variable in their own columns  [@Mount+Zumel:2019:fluid-data]. We use this form regularly, for example, in preparing data for graphing using the ggplot2 package. However, the "row-record" or "wide" format is generally preferred for data tables in publications or for sharing with research collaborators. 

To illustrate the difference, consider the following small subset of the `study_stickiness` data. The first two columns are keys that uniquely identify rows and the third column is a response or "payload" column containing data. Database designers call this a "denormalized" form; many R users would recognize it as the so-called "tidy" form [@Wickham+Grolemund:2017].



```{r echo = FALSE}
# Simple, short case to illustrate
library("midfieldr")
library("midfielddata")
suppressMessages(library("data.table"))
DT <- copy(study_stickiness)
DT <- DT[program %chin% c("Civil", "Electrical", "Mechanical")]
DT <- DT[race_sex %chin% c("Asian Female", "Black Female", "White Female")]
DT <- DT[, .(race_sex, program, stick)]
DT <- DT[order(race_sex, program)]

long_data <- copy(DT)
wide_data <- copy(DT)
wide_data <- dcast(wide_data, race_sex ~ program, value.var = "stick")

kable2html(long_data, caption = "Table 1. Block-record form")
```
<br>

The same data are shown in row-record form in the table below. The leftmost column is still a key; the new column names contain the values of the second key; and the cells at the row-column intersections contain the response. We have lost the labels for the second key (`program`) and the response (`stick`), though the table caption includes the "stickiness" label to identify the cell content. 


```{r echo = FALSE}
kable2html(wide_data, caption = "Table 2. Row-record form")
```
<br>

Depending on your software background, you may have encountered a block-record/row-record transformation using any of these function pairs---a list adapted from [@Mount+Zumel:2019:fluid-data].  

- pivot / anti-pivot or crosstab / shred (databases)
- pivot_to_rowrecs / unpivot_to_blocks (cdata)
- reshape "wide" / reshape "long" (R)
- pivot_wider / pivot_longer (tidyr)
- pivot / unpivot (Microsoft Excel)
- dcast / melt (data.table)
- cast / melt (reshape2)

Because we work so often with multiway data (two keys, one response), the transformation between forms is easily accomplished using the data.table functions `dcast()` and `melt()`. For more complicated transformations---with multiple response variables for example---we recommend the cdata package [@Mount+Zumel:2020:cdata]. 
 
### In this vignette

Using the `study_student` and `study_stickiness` data sets included with midfieldr, we: 

- Illustrate the block-record form using multiway data. 
- Transform multiway block records to row records.
- Transform multiway row-records to block-records. 
- Create a two-way frequency table with row and column totals. 





## Block-record form 

If you are writing your own script to follow along, we start with these packages: 

```{r}
# packages used
library("midfieldr")
library("janitor")

# optional code to control data.table printing
options(
  datatable.print.nrows = 10,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

In this example, we use the case study longitudinal stickiness results from the case study. View the data help page by running 

``` r
? study_stickiness
```

These data are currently laid out in block-record form, where the `race_sex` key and the `program` key are both in their own columns and the response, stickiness, is in its own column. 

Before tabulating the data, we impose the same constraints we did in the case study by omitting: observations with fewer than 10 students ever enrolled; Native American students because of their small numbers in all but one program; and ambiguous values for race/ethnicity (International and Other/Unknown).  

```{r}
# Copy to avoid update by reference
block_form <- copy(study_stickiness)

# Omit before presenting
block_form <- block_form[ever >= 10]
block_form <- block_form[!race_sex %ilike% c("International|Other|Native")]

# Examine the result
block_form
```

We limit the data table to the three multiway variables. 

```{r}
# Three columns
block_form <- block_form[, .(program, race_sex, stick)]

# examine the result
block_form
```

Following is an HTML version of the data table in block-record form. 

```{r echo = FALSE}
kable2html(block_form, caption = "Table 3. Stickiness in block-record form")
```


## Transform block-records to row-records 

If in the row-record form we want rows and columns ordered alphabetically, we convert factors to characters. 

```{r}
# create a new memory location
row_form <- copy(block_form)

# convert factors to characters
row_form[, race_sex := as.character(race_sex)]
row_form[, program := as.character(program)]
```

Use `dcast()` to reshape the data frame from block-record form to row-record form. 

```{r}
# reshape
row_form <- dcast(row_form, race_sex ~ program, value.var = "stick")

# examine the result
row_form
```

We can edit the column names for presentation, 

```{r}
setnames(row_form,
  old = c("race_sex"),
  new = c("Race/Ethnicity/Sex")
)
```

Following is an HTML version of the data table in row-record form.   

```{r echo = FALSE}
kable2html(row_form, caption = "Table 4. Stickiness in row-record form")
```



### Exercise

1. Create a table of `study_grad_rate` data similar to the table above. 



## Transform row-records to block-records

As Mount and Zumel state, "For coordinatized data, different layouts of rows and columns are demonstrably equivalent."---if the keys provide invariant "coordinates" to the data values, then one form is readily transformed to another. 

In this example (again, a simple example with two coordinates and one response), we can use `melt()` to transform row records to block records. Note that we can re-establish the key label `program` and the response label `stick`. 

```{r}
melt(row_form,
  id.vars = "Race/Ethnicity/Sex",
  measure.vars = c("Civil", "Electrical", "Industrial", "Mechanical"),
  variable.name = "program",
  value.name = "stick"
)
```

Working with student unit record data, `melt()` is particularly useful if a colleague provides you with data in row-record form and you need to transform it to block record for analysis or graphing. Again, for transformations with multiple response variables, we recommend the cdata package [@Mount+Zumel:2020:cdata].


## Tables with totals

Another commonly-encountered table in student unit record research is a summary table of the numbers of students in different groups. For this example, we use the `study_student` data. View its help page by running

``` r
? study_student
```

If we focus on two categories, e.g., `program` and `race_sex`, the frequency of occurrences of the combinations of the levels of the two categories is a two-way frequency table. 

```{r}
# Create a new memory location
DT <- copy(study_student)

# View the data
DT
```

We join the race/ethnicity and sex variables to construct our usual categories, 
```{r}
# Merge the groups as usual
DT[, race_sex := paste(race, sex)]

# Subset the same populations as above
DT <- DT[!race_sex %ilike% c("International|Other|Native")]
```

Counting by the two grouping variables yields the frequency of the combinations of levels and omits the other columns. 

```{r}
DT <- DT[, .N, by = c("program", "race_sex")]

# omit small populations
DT <- DT[N >= 10]

# Examine the result
DT
```

Reshaping from block-record to row-record form creates the two-way frequency table. 

```{r}
DT <- dcast(DT, race_sex ~ program, value.var = "N")

# Examine the result
DT
```

With data of this sort, readers often wish to see row and column totals. The janitor package has the `adorn_totals()` function to do just that. You can sum rows, columns, or both. 

```{r}
DT <- adorn_totals(DT, where = c("row", "col"), na.rm = TRUE)

DT
```

Following is an HTML version of these data. 

```{r echo = FALSE}
setnames(DT,
  old = c("race_sex"),
  new = c("Race/Ethnicity/Sex")
)
kable2html(DT, caption = "Table 5. Two-way frequency table with totals")
```





## References

<div id="refs"></div>






## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r eval = FALSE}
# packages used
library("midfieldr")
library("janitor")

# optional code to control data.table printing
options(
  datatable.print.nrows = 10,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)

# Block-record form
block_form <- copy(study_stickiness)
block_form <- block_form[ever >= 10]
block_form <- block_form[!race_sex %ilike% c("International|Other|Native")]
block_form <- block_form[, .(program, race_sex, stick)]

# Transform block-records to row-records
row_form <- copy(block_form)
row_form[, race_sex := as.character(race_sex)]
row_form[, program := as.character(program)]
row_form <- dcast(row_form, race_sex ~ program, value.var = "stick")
setnames(row_form,
  old = c("race_sex"),
  new = c("Race/Ethnicity/Sex")
)

# Transform row-records to block-records
melt(row_form,
  id.vars = "Race/Ethnicity/Sex",
  measure.vars = c("Civil", "Electrical", "Industrial", "Mechanical"),
  variable.name = "program",
  value.name = "stick"
)

# Tables with totals
DT <- copy(study_student)
DT[, race_sex := paste(race, sex)]
DT <- DT[!race_sex %ilike% c("International|Other|Native")]
DT <- DT[, .N, by = c("program", "race_sex")]
DT <- DT[N >= 10]
DT <- dcast(DT, race_sex ~ program, value.var = "N")
DT <- adorn_totals(DT, where = c("row", "col"), na.rm = TRUE)
```






```{r echo = FALSE}
# to change the CSS file for block quotes
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 12px;
    border-left: 0px solid
}
```



