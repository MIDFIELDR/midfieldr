---
title: "Tabulating data"
author: "Richard Layton"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/ieee-with-url.csl
vignette: >
  %\VignetteIndexEntry{Tabulating data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: | 
resource_files: |
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = here::here(
  "man/figures",
  "art-060-tabulating-data-"
))
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
asp_ratio_mw <- function(data, categories) {
  cat1 <- categories[1] # panels
  cat2 <- categories[2] # rows
  nlevel1 <- nlevels(data[, get(cat1)])
  nlevel2 <- nlevels(data[, get(cat2)])
  r <- nlevel1 * nlevel2
  q <- 32
  asp_ratio1 <- (r + 2 * nlevel1) / q
  asp_ratio2 <- (r + 2 * nlevel2) / q
  ratios <- c(asp_ratio1, asp_ratio2)
}
```

## Introduction 

Data tables are useful in discussions with one's research team and are often included in publications for readers who want to see the values underlying the data graphics. 
 
### Outline

- Practice tabulating multiway data  

### In this vignette

midfieldr functions 
 
- `condition_multiway()` 

packages

```{r}
# packages used
library("midfieldr")
library("midfielddata")

library("ggplot2")
library("janitor")
library("data.table")
```

We can control how a data.table is printed to the screen with the following options.  

```{r}
# optional code to control data.table printing
options(
  datatable.print.nrows = 10,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

## Tabulating data

In this example, we use the case study longitudinal stickiness results from the case study. View the data help page by running 

``` r
? study_student
```

These data are currently laid out in "block record" form [@Mount+Zumel:2019:fluid-data], where the `race_sex` key and the `program` key are both in columns and the response, stickiness, is in the last column. This layout is also called "tidy data"  [@Wickham+Grolemund:2017]. 

The graphing package we use, ggplot2, is designed to work most effectively with block-record data, thus the block-record ("long") form is the default layout in midfieldr. 

Before tabulating the data, we impose the same constraints we did in the case study by omitting: observations with fewer than 10 students ever enrolled; ambiguous values for race/ethnicity (International and Other/Unknown); and Native American students in this case they are absent from all but one discipline.  

```{r}
# Copy to avoid update by reference 
DT <- copy(study_stickiness)

# Omit before presenting
DT <- DT[ever >= 10]
DT <- DT[!race_sex %ilike% c("International|Other|Native")]
```


```{r echo = FALSE}
kable2html(DT, caption = "Table 1: Stickiness (block records)")
```
<br>

However, the visual convention preferred by publishers and readers is a row-record ("wide") form, as illustrated by Table 2. The `race_sex` key is in the left column and the `program` key is in the column names. The stickiness findings lie at the row-column intersections. Note that in this form, NA observations are explicitly shown. 

```{r echo = FALSE}
temp <- copy(DT)
temp[, race_sex := as.character(race_sex)]
temp[, program := as.character(program)]
temp <- dcast(temp, race_sex ~ program, value.var = "stick")
setnames(temp, old = "race_sex", new = "Race/Ethnicity/Sex")
kable2html(temp, caption = "Table 2: Stickiness (row records)")
```

Depending on your software background, you may have encountered a block-record/row-record transformation using any of these function pairs---a list adapted from [@Mount+Zumel:2019:fluid-data].  

- pivot / anti-pivot or crosstab / shred (databases)
- pivot_to_rowrecs / unpivot_to_blocks (cdata)
- reshape "wide" / reshape "long" (R)
- pivot_wider / pivot_longer (tidyr)
- pivot / unpivot (Microsoft Excel)
- dcast / melt (data.table)
- cast / melt (reshape2)

In our example, we use `dcast()` from the data.table package to reshape the data for publication. We start by limiting the significant figures of floating-point numbers. 

```{r}
# Copy to prevent update by reference 
block_form <- copy(DT)

# limit significant digits
block_form[, stick := round(stick, 2)]
```

If in the final result we want rows and columns ordered alphabetically, we convert factors to characters. 

```{r}
# create a new memory location
row_form <- copy(block_form)

# convert factors to characters
row_form[, race_sex := as.character(race_sex)]
row_form[, program := as.character(program)]
```

`dcast()` is used to reshape the data frame from block-record form to row-record form. 

```{r}
# reshape
row_form <- dcast(row_form, race_sex ~ program, value.var = "stick")

# examine the result
row_form
```

We can edit the column names for presentation, 

```{r}
setnames(row_form, 
         old = c("race_sex"), 
         new = c("Race/Ethnicity/Sex"))
```


This result is the source for Table 2, repeated below. 

```{r echo = FALSE}
kable2html(temp, caption = "Table 2: Stickiness (row records)")
```


Other good tools for reshaping are provided in packages such as `reshape()` in base R, cdata  [@Mount+Zumel:2020:cdata], and tidyr [@Wickham+Henry:2020:tidyr]. 


### Exercise

1. Create a table of `study_grad_rate` data similar to the table above. 







## Tables with totals

When data have not been summarized, as in the `study_student` data set for example, 

```{r}
study_student
```

and what we want is a count of students by group, the result is a frequency table. The janitor package has convenient functions for creating frequency tables and adding row and column totals.

```{r}
# To access the tabyl() and adorn_total() functions
library("janitor")

# Create a new memory location
DT <- copy(study_student)
```

We join the race/ethnicity and sex variables to construct our usual categories, 

```{r}
# Merge the groups as usual
DT[, race_sex := paste(race, sex)]

# Subset the same populations as above
DT <- DT[!race_sex %ilike% c("International|Other|Native")]

# Examine the result
DT
```

```{r}
tmp <- DT[, .N, by = c("program", "race_sex")]
tmp

# omit small populations
tmp <- tmp[N >= 10]
tmp

tmp <- dcast(tmp, race_sex ~ program, value.va = N)
tmp
```






```{r}
tmp <- adorn_totals(tmp, where = c("row", "col"), na.rm = TRUE)
setnames(tmp, 
         old = c("race_sex"), 
         new = c("Race/Ethnicity/Sex"))
tmp
```



Use `tabyl()` to create the two-way frequency table of counts,  

```{r}
# Create the two-way frequency table
DT <- tabyl(DT, race_sex, program)

# Examine the result
DT
```

Use `adorn_totals()` to add row totals, column totals, or (as shown here) both, 

```{r}
# Add row and column totals
DT <- adorn_totals(DT, where = c("row", "col"))

# Examine the result
DT
```

And edit the column name

```{r}
setDT(DT)
setnames(DT, 
         old = c("race_sex"), 
         new = c("Race/Ethnicity/Sex"))
DT
```

The presentation verion:


```{r echo = FALSE}
kable2html(DT, caption = "Table 3: Number of students (with totals)")
```







## References

<div id="refs"></div>






## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r eval = FALSE}
# packages used
library("midfieldr")
library("data.table")
library("ggplot2")

# optional code to control data.table printing
options(
  datatable.print.nrows = 10,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

```{r echo = FALSE}
# to change the CSS file for block quotes
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 12px;
    border-left: 0px solid
}
```



