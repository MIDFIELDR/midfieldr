---
title: "Case study stickiness"
author: "Richard Layton"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/ieee-with-url.csl
vignette: >
  %\VignetteIndexEntry{Case study stickiness}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
nocite: | 
resource_files: 
  - ../man/figures/art-006-case-study-stickiness-fig1-1.png
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = here::here(
  "man/figures",
  "art-006-case-study-stickiness-"
))
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
asp_ratio_mw <- function(data, categories) {
  cat1 <- categories[1] # panels
  cat2 <- categories[2] # rows
  nlevel1 <- nlevels(data[, get(cat1)])
  nlevel2 <- nlevels(data[, get(cat2)])
  r <- nlevel1 * nlevel2
  q <- 32
  asp_ratio1 <- (r + 2 * nlevel1) / q
  asp_ratio2 <- (r + 2 * nlevel2) / q
  ratios <- c(asp_ratio1, asp_ratio2)
}
```

## Introduction

We continue the case study, a tour of a typical workflow with student unit record data. Again, for the sake of brevity we focus on the logic of the analysis and leave the detailed discussion of functions and arguments to later vignettes. 

Assuming you completed the introduction to the four data tables (in [Getting started](art-000-getting-started.html)), the case study has four parts:

- [Case study programs](art-002-case-study-programs.html)
- [Case study students](art-004-case-study-students.html)
- *Case study stickiness* &#11160; You are here.
- [Case study graduation rate](art-006-case-study-grad-rate.html)

Longer, related vignettes with detailed discussions of methods and functions include:  


- [Data sufficiency](art-020-data-sufficiency.html)
- [Timely completion](art-030-timely-completion.html){target="_blank"} 
- [Multiway graphs](art-050-multiway-graphs.html){target="_blank"} 

### In this vignette

Starting with the `study_student` data frame from the previous vignette ([Case study students](art-004-case-study-students.html){target="_blank"}), we:

- Apply the timely completion criterion 
- Tally students ever enrolled in a program by race/ethnicity, and sex
- Tally students completing a program by race/ethnicity, and sex
- Compute and graph the stickiness 
- Save the results
 
*Longitudinal stickiness* is the ratio of the number of students graduating in a program to the number of students ever enrolled in that program after accounting for the data sufficiency and timely completion  criteria  [@Ohland+Orr+others:2012]. Stickiness measures the extent to which a program succeeds in its basic goal of graduating the students it admits, without regard to how or when a student is admitted to a program---the metric includes students who begin college part-time, enroll mid-year, switch majors, or transfer, in addition to first-time-in-college students. 


We use the following midfieldr functions

- [`add_completion_timely()`](../reference/add_completion_timely.html)
- [`condition_multiway()`](../reference/condition_multiway.html)

The vignette output is the data frame `study_stickiness`. 





## Apply the timely completion criterion 

If you are writing your own script to follow along, we start with these packages: 

```{r}
# packages used
library("midfieldr")
library("midfielddata")
library("data.table")
library("ggplot2")

# optional code to control data.table printing
options(
  datatable.print.nrows = 10,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)

# load data tables from midfielddata
data(degree)
```




We gathered the eligible students for the case study programs in the previous case study vignettes.  The data are saved in the `study_student` data set that loads with midfieldr. View its help page by running

```r  
? study_student
```

Review the data. The data sufficiency criterion has been applied. As usual, we use assign our working data frame to `DT`. 

```{r}
# Create a new memory location to avoid updating by reference
DT <- copy(study_student)

# Examine the result
DT
```

Before we can count the number of graduates, we have to assess whether graduates complete their program in a timely manner. A student graduating later than their timely-completion term are grouped with non-graduates for purposes of computing a persistence metric.

The `add_completion_timely()` function requires that the input data frame has a `timely_term` column---which ours does. The function accesses the `degree` data to determine the term  of a student's first degree and reports whether the degree term (if any) satisfies the timely completion criterion. 

```{r}
DT <- add_completion_timely(DT, midfield_degree = degree)
DT
```


## Summarize by group 

We count the number of students ever enrolled and the number of graduates in separate steps, then join the results. 

First we assign the grouping variables to be used for grouping, summarizing, and joining. 

```{r}
grouping_variables <- c("program", "race", "sex")
```

We count the enrollees and assign the result to the new `ever` column. 

```{r}
ever_enroll <- copy(DT)
ever_enroll <- ever_enroll[, .(ever = .N), by = grouping_variables]
ever_enroll
```

Before counting graduates, we subset for those satisfying the timely-completion criterion. 

```{r}
graduate <- copy(DT)
graduate <- graduate[completion_timely == TRUE]
graduate
```

We count the graduates and assign the result to the new `grad` column. 

```{r}
graduate <- graduate[, .(grad = .N),  by = grouping_variables]
graduate
```

Now we join the two data frames, setting `all.x = TRUE` to retain all rows of both `ever_enroll`. 

```{r}
DT <- merge(ever_enroll,
            graduate,
            by = grouping_variables,
            all.x = TRUE)
DT
```



## Condition the results

If the `graduate` data had fewer rows than the `ever_enroll` data, the `merge()` we did introduces some NA values in the `grad` column. 

```{r}
# Any NA in grad?
sum(is.na(DT$grad))
```

Those NA values are better encoded as zeros.

```{r}
DT <- DT[is.na(grad), grad := 0][]
DT
```

Before computing stickiness, we omit populations of 10 or less to protect their identity. 

```{r}
DT <- DT[ever > 10]
DT
```



## Compute stickiness


```{r}
DT[, stick := round(100 * grad / ever, 1)]
DT <- DT[order(program, sex, race)]
DT

all.equal(DT, study_stickiness)
```



## Graph the results

```{r}
# data preparation
mw <- DT[!race %chin% c("International", "Other/Unknown")]
mw

mw <- mw[, .(program, race_sex = paste(race, sex), stick)]
mw

mw <- condition_multiway(mw, details = TRUE)
mw
```

```{r echo = FALSE}
asp_ratio <- asp_ratio_mw(mw, categories = c("program", "race_sex"))
```

```{r fig1, fig.asp = asp_ratio[1]}
# creating a multiway graph
ggplot(data = mw, aes(x = stick, y = race_sex)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_vline(aes(xintercept = med_program),
    linetype = 2
  ) +
  geom_point(na.rm = TRUE) +
  labs(
    x = "Stickiness",
    y = "",
    title = "Practice data (not for research)",
    caption = "Source: midfielddata"
  )
```






## References

<div id="refs"></div>










## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script.

```{r eval=FALSE}
# packages used
library("midfieldr")
library("midfielddata")
library("data.table")
library("ggplot2")
```




