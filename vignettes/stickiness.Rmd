---
title: "Stickiness metric"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stickiness metric}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
resource_files:
  - ../man/figures/stickiness-fig1-1.png
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = TRUE,
  warning = TRUE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/stickiness-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

Longitudinal "stickiness" is the ratio of the number of students graduating in a program to the number of students ever enrolled in that program [@stickiness2012]. 

Thus the stickiness metric accounts for all students a program had the most immediate opportunity to retain and graduate---the students were, after all, enrolled in the program at one time. 

We typically group stickiness results by program, sex, and "race" as defined by the participating US institutions. 

## Getting started 

```{r message = FALSE}
# packages used
library(midfieldr)
library(seplyr)
library(tidyverse)
```

In this article, we show you how to use midfieldr functions to compute program stickiness. Our workflow is: 

- select the programs 
- count the students ever enrolled
- count the students graduating  
- compute stickiness 
- create a multiway graph  


## Select the programs to study

For this example, we compare the stickiness of four engineering programs: Civil, Electrical, Industrial, and Mechanical. Their 4-digit CIP codes (1408, 1410, 1419, 1435) were found by keyword search as illustrated in [Selecting CIP codes](cip_filter.html).

We use `cip_filter()` to obtain the relevant program codes. You can open the help page by running `?cip_filter()`.

```{r}
# four data frames of cip codes and names
cve <- cip_filter(cip, series = "^1408")
ele <- cip_filter(cip, series = "^1410")
mce <- cip_filter(cip, series = "^1419")
ise <- cip_filter(cip, series = "^1435")
```

Next we will use `cip_label()` to assign program names to the distinct programs we want to compare. One possibility is to use the 4-digit program names already available in the data. To view those names:    

```{r}
# view 4-digit program names
unique(cve[["cip4name"]])
unique(ele[["cip4name"]])
unique(mce[["cip4name"]])
unique(ise[["cip4name"]])
```

The 4-digit names for Civil, Mechanical, and Industrial Engineering are satisfactory; we'll assign the default names to these programs using the `program = "cip4name"` argument in `cip_label()`. For other options, see the help page by running  `?cip_label()`  

```{r}
# label the programs with the default 4-digit names
cve <- cip_label(cve, program = "cip4name")
mce <- cip_label(mce, program = "cip4name")
ise <- cip_label(ise, program = "cip4name")
```

The Electrical Engineering program name is somewhat verbose; we'll assign a custom label to this program as follows: 

```{r}
# label the program with a custom name
ele <- cip_label(ele, program = "Electrical Engineering")
```

We use `bind_rows()`, a [dplyr](http://dplyr.tidyverse.org) function, to bind the individual data frames into one data frame. 

```{r}
cip_group <- bind_rows(cve, ele, mce, ise)
```

Examine the result: there are a total of `r length(uniques(cip_group[["cip6"]]))` CIP codes for these programs. We have 7 columns: 6 from the `cip` dataset and the one `program` column of labels we added using `cip_label()`. 

```{r echo = -1}
options(tibble.print_min = 12L)
# check the result
cip_group
```

When searching the midfielddata datasets for students in these programs, our search functions use the 6-digit CIP codes in the `cip6` variable. To confirm that the search terms are what we expect, we can extract and view the `r length(uniques(cip_group[["cip6"]]))` unique codes. 

```{r}
unique(cip_group[["cip6"]])
```

## gather_ever()  

`gather_ever()` has one argument, a data frame with at least two character variables:  `cip6` and `program`. The function extracts from the `midfieldterms` dataset all students ever enrolled in the programs in `cip6`. Open the help page by running `?gather_ever()`.

```{r}
# extract unique students from midfieldterms
students <- gather_ever(cip_group)
```

Use `glimpse()` (a [tibble](http://tibble.tidyverse.org) function) to view the result to check the number of observations and to view the first few values of each variable. We see that we have 10846 students ever enrolled in these programs. 

```{r}
# check the result
glimpse(students)
```

## race_sex_join() 

`race_sex_join()` accepts any data frame with the MIDFIELD student `id` variable and joins the student race and sex from the `midfieldstudents` data to these data. 

```{r}
students <- race_sex_join(students)

# check the result
glimpse(students)
```

If the argument to `race_sex_join()` already includes a `sex` or `race` column, that column (or columns) is returned unchanged. Open the help page by running `?race_sex_join()`.

## Count the numbers of students ever enrolled

We use `group_summarize()` (an [seplyr](https://winvector.github.io/seplyr/) function) to group and count the numbers of students ever enrolled in our programs.  All variables in `students` not used as grouping variables are quietly dropped. The assigned count variable is `ever`.  

```{r}
# select the variables for grouping
grouping_variables <- c("program", "race", "sex")

# count the numbers of students ever in a program
ever_enrolled <- students %>%
  group_summarize(., grouping_variables, ever = n())

# check the result
ever_enrolled
```

## gather_grad() 

`gather_grad()` extracts a subset of the `midfielddegrees` data containing the  unique students ever graduating from the programs listed in `cip_group ` and joins our user-defined `program` labels to these data. 

Similar to gathering the ever enrolled students, we can chain these functions together in one code chunk. Here, the assigned count variable is `grad`.   Open the help page by running `?gather_grad()`.

```{r}
# count students graduating from programs
graduated <- gather_grad(cip_group) %>%
  race_sex_join(.) %>%
  group_summarize(., grouping_variables, grad = n())

# check the result
graduated
```

## Tally stickiness

To compute stickiness, we use `left_join()` (a dplyr function) to join `graduated` to `ever_enrolled` by program, race, and sex.  

```{r}
stickiness <- left_join(ever_enrolled, graduated, by = grouping_variables)

stickiness
```

We suggest omitting observations with 5 or fewer students ever enrolled. 

```{r}
stickiness <- stickiness %>%
  filter(., ever > 5)
```

Finally, we create `stick`, the ratio of `grad` to `ever`. Stickiness is reported as a fraction between 0 and 1. 

```{r echo = -1}
options(tibble.print_min = 10L)
# tally stickiness
stickiness <- stickiness %>%
  mutate(., stick = round(grad / ever, 3))

# check the result
stickiness
```

## multiway_order() 

Before structuring the data for graphing, we select the populations we are interested in. For example, we might omit students for whom the "race" designation is ambiguous. This step could have been taken earlier, but must be taken (if at all) before using `multiway_order()`. 

We use `filter()` (a [dplyr](http://dplyr.tidyverse.org) function) to keep all rows except those in which race is Unknown, International, or Other.  

```{r}
stickiness_multiway <- stickiness %>%
  filter(., !race %in% c("Unknown", "International", "Other")) %>%
  filter(., !sex %in% "Unknown")
```

This example has no "Unknown" values in `sex`, but the larger data set does. For completeness, I've also filtered to remove those observations.   

We structure the stickiness results as *multiway* data by combining student race and sex into a single `race_sex` variable. The [Multiway](multiway.html) article explains multiway data and graphs in detail. 

We use: 

- `mutate()` (a [dplyr](http://dplyr.tidyverse.org) function) to create a new variable 
- `str_c()` (a [stringr](http://stringr.tidyverse.org) function) to combine the race and sex strings 
- `select()` (a [dplyr](http://dplyr.tidyverse.org) function) to keep three variables only 

```{r}
# create the race_sex variable
stickiness_multiway <- stickiness_multiway %>%
  mutate(., race_sex = str_c(race, sex, sep = " ")) %>%
  select(., program, race_sex, stick)

# check the result
stickiness_multiway
```

`multiway_order()` converts the character variables `program` and `race_sex` into *factors* and orders the levels of the two factors by the relevant stickiness medians. `glimpse()` shows that the two categorical variables are now factors. Open the help page by running `?multiway_order()`.

```{r}
# convert the data to a multiway structure
stickiness_multiway <- multiway_order(stickiness_multiway)

# check the result
stickiness_multiway
```

## Graphing the multiway

By using `multiway_order()` to condition the data, the rows and panels of the multiway graph will be ordered by the appropriate medians. We use conventional ggplot2 functions applied to the `stickiness` data frame: 

- `stick` is the quantitative x-variable 
- `race_sex` is the y-variable forming the rows of the panels 
- `program` in `facet_wrap()` conditions the panels  
- `as.table = FALSE` places the panels in ascending order from bottom to top 
- `geom_point()` creates the data markers; any NA values are removed by `na.rm = TRUE` 
- `labs()` assign axis labels 

```{r fig1, fig.asp = 2/1.6}
ggplot(stickiness_multiway, aes(x = stick, y = race_sex)) +
  facet_wrap(~program, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

We also apply our own `theme_midfield()` to edit the visual properties of the graph: axes, legends, panels, strips, etc. Open the help page by running

```r
?theme_midfield()
```

## Complete script

For reference, the complete script for this example is collected below.  

```{r eval = FALSE}
# packages used
library(midfieldr)
library(seplyr)
library(tidyverse)

# collect CIP information for 4 programs and combine into one data frame
cve <- cip_filter(cip, series = "^1408") %>%
  cip_label(., program = "cip4name")
ele <- cip_filter(cip, series = "^1410") %>%
  cip_label(., program = "Electrical Engineering")
mce <- cip_filter(cip, series = "^1419") %>%
  cip_label(., program = "cip4name")
ise <- cip_filter(cip, series = "^1435") %>%
  cip_label(., program = "cip4name")
cip_group <- bind_rows(cve, ele, mce, ise)

# assign grouping variables for summarizing and joining
grouping_variables <- c("program", "race", "sex")

# count students ever enrolled
ever_enrolled <- gather_ever(cip_group) %>%
  race_sex_join(.) %>%
  group_summarize(., grouping_variables, ever = n())

# count students graduating
graduated <- gather_grad(cip_group) %>%
  race_sex_join(.) %>%
  group_summarize(., grouping_variables, grad = n())

# tally stickiness, by group
stickiness <- left_join(ever_enrolled, graduated, by = grouping_variables) %>%
  filter(., ever > 5) %>%
  mutate(., stick = round(grad / ever, 3))

# prepare data for graph
stickiness_multiway <- stickiness %>%
  filter(., !race %in% c("Unknown", "International", "Other")) %>%
  filter(., !sex %in% "Unknown") %>%
  mutate(., race_sex = str_c(race, sex, sep = " ")) %>%
  select(., program, race_sex, stick) %>%
  multiway_order(.)

# graph
ggplot(stickiness_multiway, aes(x = stick, y = race_sex)) +
  facet_wrap(~program, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```


## References
