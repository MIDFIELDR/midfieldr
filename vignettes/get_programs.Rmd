---
title: "Gather programs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gather programs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/chicago-author-date.csl
link-citations: yes
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = TRUE,
  warning = TRUE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/get-programs-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

## Introduction 

The case study programs are Civil, Electrical, Industrial, and Mechanical Engineering. The CIP subset for these programs is a built-in dataset `exa_cip`. We show how these data were obtained in the [vignette ("Explore program CIP codes")](explore_cip.html). 

```{r message = FALSE}
# load packages
library("midfieldr")

# view the example CIP
exa_cip
```

Next, we use `label_programs()` to extract 6-digit codes (and names) and to label groups of programs to suit our purposes. The result is used to filter the student-record data sets (students, courses, terms, or degrees) for the analysis at hand.





<br>
<a href="#top">&#9650; top of page</a> 





## Extract and label programs


In the example data, the program names at the 4-digit level are those associated with accredited engineering departments. To see the names in full, 

```{r}
# case study CIP subset
columns_we_want <- c("cip4", "cip4name")
exa_cip4 <- exa_cip[, columns_we_want, drop = FALSE]

# examine the result
exa_cip4
```

Three of these names (Civil, Industrial, and Mechanical) are concise enough for small-multiple or faceted graphs. The Electrical program name is inconveniently long.  

Two approaches to editing the program labels are shown below. 

### 1. Work with one program one at a time

We separate `exa_cip` into four data frames, one for each program. 

```{r}
# work with programs one at a time and bind
# get civil engineering
cve_cip <- get_cip(data = exa_cip, keep_any = "^1408")
cve_cip
```

We operate on the result with `label_programs()` to extract its 6-digit columns. The `label` argument creates the label in a new column called `program`, used later for grouping, summarizing, and joining. 

```{r}
# keep the 6-digit CIP and add a program label
cve <- label_programs(data = cve_cip, label = "Civil Engineering")
cve
```

Repeat for electrical engineering.  

```{r}
# get electrical  engineering
ele_cip <- get_cip(data = exa_cip, keep_any = "^1410")
ele <- label_programs(data = ele_cip, label = "Electrical Engineering")
ele
```

For industrial and mechanical engineering, we assign the default 4-digit CIP name using the option `label = "cip4name"`. 

```{r}
# get mechanical  engineering
mce_cip <- get_cip(data = exa_cip, keep_any = "^1419")
mce <- label_programs(data = mce_cip, label = "cip4name")
mce

# get industrial engineering
ise_cip <- get_cip(data = exa_cip, keep_any = "^1435")
ise <- label_programs(data = ise_cip, label = "cip4name")
ise
```

We have 4 data frames that we combine row-wise. We can see that our custom program names are consistent with the default 6-digit CIP names, so we can dispense with the `cip6names` column. 

```{r }
# gather the programs in the study
program_group <- rbind(cve, ele, ise, mce)

# delete the verbose column
program_group$cip6name <- NULL

# examine the result
program_group
```

### 2. Work with all programs in one data frame

Alternatively, we can operate on one data frame throughout. We assign the 4-digit name as our preliminary program label. 

```{r}
# work with programs all in one data frame
program_group <- label_programs(data = exa_cip, label = "cip4name")

# delete the verbose column
program_group$cip6name <- NULL

# examine the result
program_group
```

Then we edit the electrical programs only.  

```{r}
# identify the CIP rows that start with 1410
rows_to_edit <- startsWith(program_group$cip6, "1410")

# relabel the electrical programs
program_group$program[rows_to_edit] <- "Electrical Engineering"

# examine the result
program_group
```

For convenience, this group of programs is included in midfieldr as a built-in data set `exa_group`. View its help page by running

```r
? exa_group
```


<br>
<a href="#top">&#9650; top of page</a> 



## Options for the program argument

In this section, we explore three options for `program` argument in `label_programs()`. 

### Option 1. Assign any string

When a string of our own choosing is assigned to `program`, then that string (with some exceptions) is the value assigned to every observation. In the previous example, we used this option for Electrical Engineering. 

Here we use this option for CIP code 31 programs: Parks, Recreation, Leisure and Fitness Studies.

```{r}
# assign an arbitrary program name
sub_cip <- get_cip(data = cip, keep_any = "^31")
program_group <- label_programs(data = sub_cip, label = "Leisure Studies")
```

```{r echo = FALSE}
kable2html(program_group)
```

<br>

The exceptions to this option are the special `program` arguments "cip2name", "cip4name", and "cip6name", described below. 

### Option 2. Default CIP strings

When the `program` argument is "cip2name", "cip4name", or "cip6name", then the 2-, 4-, or 6-digit names from `cip` are  assigned to the new column. In the previous example, we used this option for Industrial and Mechanical Engineering.

Using these options for CIP code 31 programs yields: 

```{r}
# assign the 2-digit level name
program_group <- label_programs(data = sub_cip, label = "cip2name")
```

```{r echo = FALSE}
kable2html(program_group)
```

<br>

```{r}
# assign the 6-digit level name
program_group <- label_programs(data = sub_cip, label = "cip6name")
```

```{r echo = FALSE}
kable2html(program_group)
```

### Option 3. NULL value

When `label_programs = NULL`, then the 4-digit CIP program name is used. This result is identical to `label_programs = "cip4name"`. 

```{r}
# label argument NULL same as 4-digit level name
program_group <- label_programs(data = sub_cip)
```

```{r echo = FALSE}
kable2html(program_group)
```

<br>

To learn more about `label_programs()`, open the help page by running 

```r
? label_programs
```



<a href="#top">&#9650; top of page</a> 





## CIP data from another source

If you use a CIP data set from another source, it must have the same structure as `cip`. Reshaping data frames is a conventional bit of R data carpentry. If you need help, consult any convenient R resource.

```{r}
# name and class of variables (columns) in cip
cip_variables <- lapply(cip, function(col) class(col))
str(cip_variables)
```

 




<br>
<a href="#top">&#9650; top of page</a> 








## Appendix

### Complete script

In response to requests from some of our workshop attendees, we collect the vignette code chunks in one script. We condense the script by omitting exploratory steps so we can focus on the steps that produce the results. 

```{r eval=FALSE}
# load packages
library("midfieldr")

# work with programs one at a time and bind
cve_cip <- get_cip(data = exa_cip, keep_any = "^1408")
cve <- label_programs(data = cve_cip, label = "Civil Engineering")

ele_cip <- get_cip(data = exa_cip, keep_any = "^1410")
ele <- label_programs(data = ele_cip, label = "Electrical Engineering")

mce_cip <- get_cip(data = exa_cip, keep_any = "^1419")
mce <- label_programs(data = mce_cip, label = "cip4name")

ise_cip <- get_cip(data = exa_cip, keep_any = "^1435")
ise <- label_programs(data = ise_cip, label = "cip4name")

program_group <- rbind(cve, ele, ise, mce)
program_group$cip6name <- NULL

# work with programs all in one data frame
program_group <- label_programs(data = exa_cip, label = "cip4name")
program_group$cip6name <- NULL
rows_to_edit <- startsWith(program_group$cip6, "1410")
program_group$program[rows_to_edit] <- "Electrical Engineering"

# assign an arbitrary program name
sub_cip <- get_cip(data = cip, keep_any = "^31")
program_group <- label_programs(data = sub_cip, label = "Leisure Studies")

# assign the 2-digit level name
program_group <- label_programs(data = sub_cip, label = "cip2name")

# assign the 6-digit level name
program_group <- label_programs(data = sub_cip, label = "cip6name")

# label argument NULL same as 4-digit level name
program_group <- label_programs(data = sub_cip)

# name and class of variables (columns) in cip
cip_variables <- lapply(cip, function(col) class(col))
str(cip_variables)
```




<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 


