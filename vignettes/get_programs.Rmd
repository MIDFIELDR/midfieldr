---
title: "Gather programs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gather programs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = "../man/figures/vignette-get-programs-")
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
```

## Introduction 

While CIP data include 2-, 4-, and 6-digit program codes and names, all program data in MIDFIELD is encoded using only the 6-digit codes. Thus, once we have identified the 6-digit CIP codes for the programs we wish to study, we collect them and label them with program names suitable for grouping, summarizing, and joining operations. 

When finished with this step, the working data frame is expected to have two columns `cip6` and `program` or equivalent. 

### This vignette uses

midfieldr functions 
 
- `filter_by_text()` 

data.table syntax

- `DT[, new_col := value]` add new column 
- `DT[, ..cols_we_want]` select columns
- `DT[, .(col1, new_col = col2)]` select columns, rename one  
- `DT[rows_to_edit, col := value]` for identified rows, assign value in column 

packages

```{r}
# packages used
library(midfieldr)
library(data.table)

# print max 20 rows, otherwise 10 rows each head/tail
options(datatable.print.nrows = 20, datatable.print.topn = 10)
```

## Determine the CIP subset

In the *Explore program CIP codes* vignette [(link)](explore_cip.html), we obtain the subset of CIP codes and names for the engineering case study. These data are included with midfieldr as the built-in data set `rep_cip`. View its help page by loading midfieldr and running

```r
? rep_cip 
```

The contents of `rep_cip`:

```{r echo=FALSE}
kable2html(rep_cip)
```
<br>

## Extract and label programs

Starting with a CIP subset, we extract the 6-digit codes and label groups of programs to suit our purposes. The result is later used to filter the student-record data sets (students, courses, terms, or degrees) for the analysis at hand.

As you can see in the table above, the program names at the 4-digit level are those associated with accredited engineering departments. Three of these names (Civil, Industrial, and Mechanical) are concise enough for small-multiple or faceted graphs. The Electrical program name is inconveniently long.  

Two approaches to editing the program labels are shown below. 

### 1. Work with one program one at a time

We separate `rep_cip` into four data frames, one for each program. 

```{r}
# work with programs one at a time and bind
# get civil engineering 6-digit codes
cve <- filter_by_text(rep_cip, keep_text = "^1408", keep_col = "cip6")
cve
```

We operate on the result to create a new column called `program`, used later for grouping, summarizing, and joining. 

```{r}
# add a program label
cve[, program := "Civil Engineering"]
cve
```

Repeat for the other majors

```{r}
# get electrical  engineering
ele <- filter_by_text(rep_cip, keep_text = "^1410", keep_col = "cip6")
ele[, program := "Electrical Engineering"]
ele

# get mechanical  engineering
mce <- filter_by_text(rep_cip, keep_text = "^1419", keep_col = "cip6")
mce[, program := "Mechanical Engineering"]
mce

# get industrial engineering
ise <- filter_by_text(rep_cip, keep_text = "^1435", keep_col = "cip6")
ise[, program := "Industrial Engineering"]
ise
```

We have 4 data frames that we combine row-wise. 

```{r }
# gather the programs in the study
program_group <- rbind(cve, ele, ise, mce)

# examine the result
program_group
```

### 2. Work with all programs in one data frame

Alternatively, we can operate on one data frame throughout. Starting with the 6-digit codes and the 4-digit names, 

```{r}
# work with programs all in one data frame
program_group <- rep_cip[, .(cip6, program = cip4name)]

# examine the result
program_group
```

All but Electrical Engineering have conveniently short program names. We use `startsWith()` to edit the program column for electrical. 

```{r}
# identify the CIP rows that start with 1410
rows_to_edit <- startsWith(program_group$cip6, "1410")

# relabel the electrical programs
program_group[rows_to_edit, program := "Electrical Engineering"]

# examine the result
program_group
```

The program group derived above is the data set `rep_group` in midfieldr.  View its help page by running

```r
? rep_group
```

## Options for the program column

Our goal is to create a data frame with two columns, `cip6` and `program` or equivalent. In this section, we explore several options for assigning program labels.   

### Option 1. Use one of the built-in CIP names 

We can use one of the built-in 2-, 4-, or 6-digit names as follows. 

```{r}
# retain the 2-digit level name
sub_cip <- filter_by_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip2name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip2name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 4-digit level name
sub_cip <- filter_by_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip4name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip4name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

```{r}
# retain the 6-digit level name
sub_cip <- filter_by_text(cip,
  keep_text = "^31",
  keep_col = c("cip6", "cip6name")
)

# rename column to "program"
program_group <- sub_cip[, .(cip6, program = cip6name)]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

### Option 2. Assign any string

CIP program names are occasionally verbose. In such cases, we often use a shortened version of the program name to use as a graph or table heading. In this example, we substitute our own name for the "Parks, Recreation, Leisure and Fitness Studies" programs used in the previous example. 

```{r}
# ignore all default CIP names
sub_cip <- filter_by_text(cip, keep_text = "^31", keep_col = "cip6")

# assign an arbitrary program name
program_group <- sub_cip[, program := "Leisure Studies"]
```

```{r echo = FALSE}
kable2html(program_group)
```
<br>

## CIP data from another source

If you use a CIP data set from another source, it must have the same structure as `cip`: six character columns named as follows,  

```{r}
# name and class of variables (columns) in cip
unlist(lapply(cip, FUN = class))
```

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script.

```{r eval = FALSE}
# packages used
library(midfieldr)
library(data.table)

# work with programs one at a time and bind
cve <- filter_by_text(rep_cip, keep_text = "^1408", keep_col = "cip6")
cve[, program := "Civil Engineering"]

ele <- filter_by_text(rep_cip, keep_text = "^1410", keep_col = "cip6")
ele[, program := "Electrical Engineering"]

mce <- filter_by_text(rep_cip, keep_text = "^1419", keep_col = "cip6")
mce[, program := "Mechanical Engineering"]

ise <- filter_by_text(rep_cip, keep_text = "^1435", keep_col = "cip6")
ise[, program := "Industrial Engineering"]

program_group <- rbind(cve, ele, ise, mce)

# work with programs all in one data frame
program_group <- rep_cip[, .(cip6, program = cip4name)]
rows_to_edit  <- startsWith(program_group$cip6, "1410")
program_group[rows_to_edit, program := "Electrical Engineering"]

# assign the 2-digit level name
sub_cip <- filter_by_text(cip,
                          keep_text = "^31",
                          keep_col = c("cip6", "cip2name"))
program_group <- sub_cip[, .(cip6, program = cip2name)]

# assign the 4-digit level name
sub_cip <- filter_by_text(cip,
                          keep_text = "^31",
                          keep_col = c("cip6", "cip4name"))
program_group <- sub_cip[, .(cip6, program = cip4name)]

# assign the 6-digit level name
sub_cip <- filter_by_text(cip, 
                          keep_text = "^31", 
                          keep_col = c("cip6", "cip6name"))
program_group <- sub_cip[, .(cip6, program = cip6name)]

# assign an arbitrary program name
sub_cip <- filter_by_text(cip, keep_text = "^31", keep_col = "cip6")
program_group <- sub_cip[, program := "Leisure Studies"]

# name and class of variables (columns) in cip
unlist(lapply(cip, FUN = class))
```
