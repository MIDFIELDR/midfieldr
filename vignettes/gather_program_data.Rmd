---
title: "Gather program data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Gather program data}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/gather-program-data-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

## Introduction 

In the vignette "Explore program CIP codes", we show how to explore the `cip` data set using the `cip_filter()` function to filter the data, retaining some instructional programs and dropping others. 

In the student-record database, programs are encoded using 6-digit CIP codes. Thus, to find the student records affiliated with the programs we are studying, we isolate their 6-digit CIP codes.  

Also, to prepare the data for eventual grouping, summarizing, and joining, we want to add a custom program label.  

We use `cip6_select()` to accomplish both steps. We apply these steps to the vignette case study as well as exploring optional values for the arguments. 



<br>
<a href="#top">&#9650; top of page</a> 





## Custom program names

The case study programs are Civil, Electrical, Industrial, and Mechanical Engineering.

```{r message = FALSE}
# packages used
library("midfieldr")
library("dplyr")
library("stringr")
```

The data frame `exa_cip` (one of the midfieldr built-in datasets) contains the full CIP information for these four programs. 

```{r}
print(exa_cip)
```

In these data, the program names at the 4-digit level are those associated with accredited engineering departments. To see the names in full, 

```{r}
exa_cip %>% 
  select(cip4, cip4name) %>% 
  unique() %>% 
  print()
```

Three of these names are concise enough for using in faceted graphs (also called a lattice or small multiples). The electrical engineering default program name can be shortened, however. 

Two approaches to editing the program labels are shown below. 

### 1. Work with programs one at a time

To work with the programs one at a time, we separate `exa_cip` into four data frames, one for each program. 

```{r}
# working with one program at a time 
cve <- cip_filter(exa_cip, keep_any = "^1408") %>%
  print()
```

Then we use `cip6_select()` to extract the 6-digit columns and add a new `program` variable. 

```{r}
cve <- cip6_select(cve, program = "Civil Engineering") %>% 
  print()
```

Repeat for electrical engineering and combine the two steps using the pipe operator, 

```{r}
ele <- cip_filter(exa_cip, keep_any = "^1410") %>%
  cip6_select(program = "Electrical Engineering") %>% 
  print()
```

An option for the program argument is `program = "cip4name"` to use the default 4-digit name. 

```{r}
ise <- cip_filter(exa_cip, keep_any = "^1435") %>%
  cip6_select(program = "cip4name")

mce <- cip_filter(exa_cip, keep_any = "^1419") %>%
  cip6_select(program = "cip4name")
```

We have 4 data frames that we combine row-wise using `bind_rows()`. 

```{r echo = -1}
options(tibble.print_min = 12L)
exa_program_group <- bind_rows(cve, ele, ise, mce) %>%
  print()
```

### 2. Work with one data frame 

As a rule, the midfieldr vignettes are written for the R novice. We attempt to facilitate the reader's understanding by reducing the density of the programming by using more and simpler lines of code than strictly necessary. 

In this optional section, we rewrite the procedure used above to illustrate a more concise approach that simply operates on one data frame throughout. 

- We assign the default 4-digit program names to all programs.
- We then use `stringr::str_detect()` to identify `cip6` values starting with 1410 and use `mutate()` to change the corresponding `program` values to Electrical Engineering, leaving the other program names intact.   

```{r echo=-1}
options(tibble.print_min = 12L)
# working with one data frame 
exa_program_group <- exa_cip %>%
  cip6_select(program = "cip4name") %>%
  mutate(program = ifelse(str_detect(cip6, "^1410"), "Electrical Engineering", program)) %>%
  print()
```

Thus we have 3 lines of code producing the same result as we obtained earlier with 9 lines (excluding the print functions). 



<br>
<a href="#top">&#9650; top of page</a> 



## Options for the program argument

In this section, we explore four options for `program` argument in `cip6_select()`. 

### Option 1. Assign any value

When a string of our own choosing is assigned to `program`, then that string is the value assigned to every observation. 

```{r results = "hide"}
# program argument any value
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "Leisure Studies") %>%
  print() 
```

```{r echo = FALSE}
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "Leisure Studies") %>%
  kable2html()
```

### Option 2. Named series value

When `program = "named_series"` and `data`  matches one of the named `cip_series`, then the value from the named series is assigned to the new column.

```{r results = "hide"}
# program argument a named series
cip %>%
  cip_filter(keep_any = cip_math_stat) %>%
  cip6_select(program = "named_series") %>%
  print()
```

```{r echo = FALSE}
cip %>%
  cip_filter(keep_any = cip_math_stat) %>%
  cip6_select(program = "named_series") %>%
  kable2html()
```

### Option 3. Default CIP value

When `program` is assigned one of three strings ("cip2name", "cip4name", or "cip6name"), then the 2-, 4-, or 6-digit names from `cip` are  assigned to the new column. We saw the 4-digit name used earlier. 

```{r results = "hide"}
# program argument the 2-digit name
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "cip2name") %>%
  print()
```

```{r echo = FALSE}
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "cip2name") %>%
  kable2html()
```

```{r results = "hide"}
# program argument the 6-digit name
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "cip6name") %>%
  print()
```

```{r echo = FALSE}
cip %>%
  cip_filter(data = ., keep_any = "^31") %>%
  cip6_select(data = ., program = "cip6name") %>%
  kable2html()
```

### Option 4. NULL value

When `program = NULL`, then the 4-digit CIP program name is used. This result is identical to `program = "cip4name"`. 

```{r results = "hide"}
# program argument NULL
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select() %>%
  print()
```

```{r echo = FALSE}
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select() %>%
  kable2html()
```



<a href="#top">&#9650; top of page</a> 





## CIP variables with non-standard names

Optional arguments in `cip6_select()` accommodate the possibility that one uses a CIP data frame with different variable names than those in `midfieldr::cip`. The four columns accommodated are `cip6`, `cip6name`, `cip4name`, and `cip2name`. 

For illustration only, let's create a CIP data frame called `nonstandard_cip` with a different name for the two variables `cip6` and `cip6name`. 

```{r echo=-1}
options(tibble.print_min = 5L)
# create CIP data frame with non-standard variable names
nonstandard_cip <- exa_cip %>%
  rename("CODE_6" = cip6, "NAME_6" = cip6name) %>%
  print()
```

### Option 1. Non-standard names kept intact

If the non-standard variable names must be kept intact, then we use the optional arguments `cip6` and `cip6name` so that `cip6_select()` can operate on the nonstandard column names.  

```r
# incorrect
nonstandard_cip %>%
  cip6_select(program = "Civil Engineering") %>%
  print()
#> Error: Can't subset columns that don't exist.
#> Column `cip6` doesn't exist
```

```{r}
# correct using optional arguments
nonstandard_cip %>%
  cip6_select(program = "Civil Engineering", cip6 = "CODE_6", cip6name = "NAME_6") %>%
  print()
```



### Option 2. Non-standard names can be revised

If the non-standard variable names do not have to be kept intact, the simple option is to `dplyr::rename()` the nonstandard variable names to the standard names, e.g.,  

```{r}
# rename the variables 
standard_cip <- nonstandard_cip %>%
  rename("cip6" = CODE_6, "cip6name" = NAME_6) %>%
  cip6_select(program = "Civil Engineering") %>%
  print()
```





<br>
<a href="#top">&#9650; top of page</a> 






## Case study

The data frame `exa_program_group`, developed in the first half of the vignette, is also one of the midfieldr built-in datasets for use in the continuing case study.   

To see the data set help page, run  

```r
? exa_program_group
```

To learn more about `cip6_select()`, open the help page by running 

```r
? cip6_select
```



<br>
<a href="#top">&#9650; top of page</a> 


## References

<div id="refs"></div>


## Appendix

### Complete script

In response to requests from some of our workshop attendees, we collect the vignette code chunks in one script. We condense the script by omitting exploratory steps so we can focus on the steps that produce the results. 

```{r eval=FALSE}
# packages used
library("midfieldr")
library("dplyr")
library("stringr")

# working with one program at a time 
cve <- cip_filter(exa_cip, keep_any = "^1408") %>%
  cip6_select(program = "Civil Engineering")

ele <- cip_filter(exa_cip, keep_any = "^1410") %>%
  cip6_select(program = "Electrical Engineering")

ise <- cip_filter(exa_cip, keep_any = "^1435") %>%
  cip6_select(program = "cip4name")

mce <- cip_filter(exa_cip, keep_any = "^1419") %>%
  cip6_select(program = "cip4name")

exa_program_group <- bind_rows(cve, ele, ise, mce)

# working with one data frame 
exa_program_group <- exa_cip %>%
  cip6_select(program = "cip4name") %>%
  mutate(program = ifelse(str_detect(cip6, "^1410"), "Electrical Engineering", program))

# program argument any value
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "Leisure Studies")

# program argument a named series
cip %>%
  cip_filter(keep_any = cip_math_stat) %>%
  cip6_select(program = "named_series")

# program argument the 2-digit name
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "cip2name")

# program argument the 6-digit name
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select(program = "cip6name")

# program argument NULL
cip %>%
  cip_filter(keep_any = "^31") %>%
  cip6_select()

# create CIP data frame with non-standard variable names
nonstandard_cip <- exa_cip %>%
  rename("CODE_6" = cip6, "NAME_6" = cip6name)

# correct using optional arguments
nonstandard_cip %>%
  cip6_select(program = "Civil Engineering", cip6 = "CODE_6", cip6name = "NAME_6")

# rename the variables 
standard_cip <- nonstandard_cip %>%
  rename("cip6" = CODE_6, "cip6name" = NAME_6) %>%
  cip6_select(program = "Civil Engineering")
```

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 


