---
title: "Using midfieldr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using midfieldr}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
link-citations: yes
resource_files:
  - ../man/figures/using-midfieldr-fig1-1.png
---


```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/using-midfieldr-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

This exercise illustrates a typical workflow for computing a persistence metric, starting with student record data and ending with a multiway graph. 

Our metric in this case is "stickiness", the ratio of the number of students graduating from a program to the number ever enrolled in the program [@stickiness2012]. We compare the stickiness of three engineering programs with students grouped by program, race, and sex. 

In this introductory example, conveying *what* is more important than *how*. We explain what the steps are and how they fit together instead of explaining the details of how the functions work. For those details, see the  [vignettes](https://midfieldr.github.io/midfieldr/articles/index.html).  


 


## Gather program data 

We wish to compare the stickiness of three programs: Chemical Engineering, Electrical Engineering, and Industrial Engineering with students grouped by program, race, and sex. 

```{r packages}
# packages used in the vignette
library("midfieldr")
library("midfielddata")
library("dplyr")
library("seplyr")
library("ggplot2")
```

We start by searching the `cip` data set for the programs we want. The results show that the 4-digit codes we want are 1407, 1410, and 1435. 
 
```{r first-cip-search, echo = -1, results = "hide"}
options(tibble.print_min = 10L)
cip %>%
  cip_filter(keep_any = "engineering", drop_any = c("tech", "bio")) %>%
  cip_filter(keep_any = c("chemical", "electrical", "industrial")) %>%
  print()
```

```{r echo=FALSE}
cip %>%
  cip_filter(keep_any = "engineering", drop_any = c("tech", "bio")) %>%
  cip_filter(keep_any = c("chemical", "electrical", "industrial")) %>%
  kable2html()
```

<br> 

Knowing the programs we want, we use  `cip_filter()` to extract their 6-digit codes and assign our own program names.

```{r extract-cip}
# chemical engineering
che <- cip %>% 
  cip_filter(keep_any = "^1407") %>%
  cip6_select(program = "Chemical Engineering")

# electrical engineering
ece <- cip %>% 
  cip_filter(keep_any = "^1410") %>%
  cip6_select(program = "Electrical Engineering")

# industrial engineering
ise <- cip %>% 
  cip_filter(keep_any = "^1435") %>%
  cip6_select(program = "Industrial Engineering")
```

We combine the three programs into one data frame.

```{r group-cip, results = "hide"}
# three programs in one data frame
program_group <- bind_rows(che, ece, ise) %>%
  print()
```

```{r echo = FALSE}
kable2html(program_group)
```




<br>
<a href="#top">&#9650; top of page</a> 





## Gather student data

We extract the `cip6` column from our group of programs to use as a character vector of search terms. 

```{r}
# for filtering operations
program_codes <- program_group[["cip6"]] %>%
  print()
```

`ever_filter()`  accesses the `midfieldterms` dataset to extract all students who ever enrolled in the `program_codes` programs. 

```{r gather-ever}
students <- ever_filter(midfieldterms, codes = program_codes) %>%
  print()
```

`race_sex_join()` accesses the `midfieldstudents` dataset to append students' race and sex to the working data frame. 

```{r}
students <- race_sex_join(students, demographics = midfieldstudents) %>%
  print()
```

To our working data frame, we join the program names in `program_group` that we created earlier.  

```{r}
students <- left_join(students, program_group, by = "cip6") %>%
  print()
```

We create a vector of variable names to be used for grouping, summarizing, and joining. 

```{r}
# for group, summarize, and join operations
grouping_variables <- c("program", "race", "sex")
```

We count the number of students ever enrolled grouped by program, race/ethnicity, and sex.  

```{r}
# count students ever enrolled
ever_enrolled <- group_summarize(students, groupingVars = grouping_variables, ever = n()) %>%
  print()
```

A similar process is used to group and summarize our graduates. We start with `grad_filter()` to access the `midfielddegrees` data. 

```{r grad}
# count students graduating
graduated <- grad_filter(codes = program_codes) %>%
  race_sex_join() %>%
  left_join(program_group, by = "cip6") %>%
  group_summarize(groupingVars = grouping_variables, grad = n()) %>% 
  print()
```

This code is slightly more compact than the code for the ever-enrolled calculation because we've omitted explicit statements of default arguments.   



<br>
<a href="#top">&#9650; top of page</a> 




## Compute the metric

We join the two data frames by program, race/ethnicity, and sex, producing a data frame with `ever` and `grad` for each group. 

```{r}
sticki_data <- left_join(ever_enrolled, graduated, by = grouping_variables) %>%
  print()
```

We omit rows with zero students ever enrolled (to avoid dividing by zero) then divide `grad` by `ever` to compute stickiness.  

```{r}
# compute the metric
sticki_data <- sticki_data %>%
  filter(ever > 0) %>%
  mutate(stickiness = round(grad / ever, 3)) %>%
  print()
```




<br>
<a href="#top">&#9650; top of page</a> 



## Prepare the results for display

To prepare the stickiness data for graphing, we remove ambiguous levels of race/ethnicity  and sex. 

```{r prep-data}
# prepare data for multiway graph
prep_data <- sticki_data %>%
  filter(!race %in% c("Unknown", "International", "Other")) %>%
  filter(!sex %in% "Unknown")
```

To protect confidentiality, we omit observations with 5 or fewer students ever enrolled.

```{r}
# protect confidentiality of small populations
prep_data <- prep_data %>%
  filter(ever > 5) %>%
  print()
```


We plan to display these data in a multiway graph, characterized by a single quantitative response variable (stickiness) for each combination of levels of the two categorical variables (program and race/ethnicity/sex).

The race/ethnicity/sex category is created by uniting `race` and `sex`. 

```{r}
prep_data <- prep_data %>%
  mutate(race_sex = paste(race, sex)) %>% 
  print()
```

To structure the data in multiway form, we select the three multiway variables and use  `multiway_order()` to convert the categorical variables to factors and order the levels of the categories by the median stickiness. 

```{r results = "hide"}
multiway_data  <- prep_data %>%
  select(program, race_sex, stickiness) %>%
  multiway_order() %>% 
  print()
```

Results are tabulated below. For programs having fewer than 5 students ever enrolled, stickiness is NA. Rows of the table are ordered by descending median stickiness of the race/ethnicity/sex groups.  

```{r echo=FALSE}
mw_table  <- multiway_data %>% 
  tidyr::pivot_wider(names_from = program, 
                     values_from = stickiness, 
                     names_sort = TRUE) %>% 
  arrange(desc(race_sex))

kable2html(mw_table)
```



<br>
<a href="#top">&#9650; top of page</a> 



## Graph the results

We use conventional ggplot2 functions to graph stickiness in a multiway dot plot. Rows and panels, from top to bottom, are ordered by decreasing median stickiness.  

```{r eval = FALSE}
# graph results
ggplot(multiway_data, aes(x = stickiness, y = race_sex)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

```{r fig1, fig.asp = 1.6/1.6, echo = FALSE}
# for annotation
pt1 <- multiway_data %>% 
  filter(program == "Electrical Engineering") %>% 
  filter(race_sex == "White Female")
pt2 <- multiway_data %>% 
  filter(program == "Chemical Engineering") %>% 
  filter(race_sex == "Asian Male")
pt3 <- multiway_data %>% 
  filter(program == "Chemical Engineering") %>% 
  filter(race_sex == "Native American Male")
df <- bind_rows(pt1, pt2, pt3)

ggplot(multiway_data, aes(x = stickiness, y = race_sex)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield() + 
  geom_point(data = df, mapping = aes(x = stickiness, y = race_sex), 
             color = "red", shape = 1, size = 4)
```

A multiway design reveals patterns and anomalies in the results. For example, among these programs for this sample population, 

Patterns 

- For students in these sex/race/ethnicity groups, Industrial engineering is the stickiest program 
- Chemical engineering is the least sticky program  
- For these programs, Asian men and women stick the most   
- Native American men and women stick the least   

Anomalies, circled in red. 

- Electrical engineering stickiness is less than expected for White women  
- Chemical engineering stickiness is less than expected for Asian men 
- Chemical engineering stickiness is more than expected for Native American men 

Displays, like this one, of longitudinal student-record data reveal patterns and anomalies that raise questions unanswerable using student-record data alone---questions leading to further research in, for example, institutional polices, the cultures of professional disciplines, and student experiences in   the undergraduate ecosystem. 


 








<br>
<a href="#top">&#9650; top of page</a> 




## References

<div id="refs"></div>


## Appendix

### Complete script

In response to requests from some of our workshop attendees, we collect the vignette code chunks in one script. We condense the script by omitting exploratory steps so we can focus on the steps that produce the results. 

```{r eval=FALSE}
# packages used in the vignette
library("midfieldr")
library("midfielddata")
library("dplyr")
library("tidyr")
library("seplyr")
library("ggplot2")

# three programs in one data frame
che <- cip_filter(cip, keep_any = "^1407") %>%
  cip6_select(program = "Chemical Engineering")
ece <- cip_filter(cip, keep_any = "^1410") %>%
  cip6_select(program = "Electrical Engineering")
ise <- cip_filter(cip, keep_any = "^1435") %>%
  cip6_select(program = "Industrial Engineering")
program_group <- bind_rows(che, ece, ise)

# for filtering operations
program_codes <- program_group[["cip6"]]

# for group, summarize, and join operations
grouping_variables <- c("program", "race", "sex")

# count students ever enrolled
ever_enrolled <- ever_filter(midfieldterms, codes = program_codes) %>%
  race_sex_join() %>%
  left_join(program_group, by = "cip6") %>%
  group_summarize(grouping_variables, ever = n())

# count students graduating
graduated <- grad_filter(midfielddegrees, codes = program_codes) %>%
  race_sex_join() %>%
  left_join(program_group, by = "cip6") %>%
  group_summarize(grouping_variables, grad = n())

# compute the metric
sticki_data  <- left_join(ever_enrolled, graduated, by = grouping_variables) %>%
  filter(ever > 0) %>%
  mutate(stickiness = round(grad / ever, 3))

# prepare data in multiway form for graphing
multiway_data  <- sticki_data  %>%
  filter(!race %in% c("Unknown", "International", "Other")) %>%
  filter(!sex %in% "Unknown") %>%
  filter(ever > 5) %>%
  mutate(race_sex = paste(race, sex)) %>% 
  select(program, race_sex, stickiness) %>%
  multiway_order()

# graph results
ggplot(multiway_data, aes(x = stickiness, y = race_sex)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 

