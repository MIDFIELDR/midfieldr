---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
link-citations: yes
resource_files:
  - ../man/figures/getting-started-fig1-1.png
---


```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE,
  warning = FALSE, 
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/getting-started-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

This vignette presents an example to illustrate a representative sample of midfieldr functions. 

Functions are used without detailed explanations---for greater detail, see the individual [vignettes](https://midfieldr.github.io/midfieldr/articles/index.html) or see a function's help page by running `? function_name()`, for example, `? cip_filter()`, `? cip6_select`, etc.  






## Contents

[Identify CIP codes]    
[Select and label programs]    
[Group and count students]    
[Compute the metric]    
[Graph the results]    
[Session information]    
[References]    




## Identify CIP codes

To introduce midfieldr, we present a brief example that starts with student unit-record data and concludes with a graphical comparison of program "stickiness" with students grouped by program, race, and sex. 

Stickiness is the ratio of the number of students graduating from a program to the number ever enrolled in the program [@stickiness2012]. 

We compare the stickiness of three programs: Chemical Engineering, Electrical Engineering, and Industrial Engineering. 

```{r packages}
# packages used in the vignette
library("midfieldr")
library("dplyr")
library("seplyr")
library("ggplot2")
```

```{r echo=FALSE}
# used by my_session() 
pkg_names <- c("midfieldr", "dplyr", "seplyr", "ggplot2")
```

We use `cip_filter()` to search the `cip` dataset first for "Engineering" and then filter the result for "Chemical", "Electrical", and "Industrial". We use the `except` argument to omit technology programs and biochemical programs. 
 
```{r first-cip-search, echo = -1}
options(tibble.print_min = 10L)
cip %>% 
  cip_filter(., series = "engineering", except = c("tech", "bio")) %>%
  cip_filter(., series = c("chemical", "electrical", "industrial")) %>%
  print() # or View()
```

Notes on viewing the results:

- As seen above, the `print()` function sends an abbreviated view of the results to the Console. 
- In the remaining code chunks, we'll leave `print()` in place but you are welcome to replace it with `View()` to invoke a spreadsheet-like data viewer.


For clarity, shorter data frames are printed in the vignette as HTML tables, as shown below.  

```{r echo=FALSE}
cip %>% 
  cip_filter(., series = "engineering", except = c("tech", "bio")) %>%
  cip_filter(., series = c("chemical", "electrical", "industrial")) %>%
  kable2html()
```


<br>

The results show that the 4-digit codes we want are 1407, 1410, and 1435. 




<br>
<a href="#top">&#9650; top of page</a> 





## Select and label programs  


In the MIDFIELD data sets, programs are identified by 6-digit CIP codes. 

Knowing the programs we want (in this example, 1407, 1410, and 1435) we use `cip6_select()` to extract all 6-digit codes and names associated with these three groupings (Chemical, Electrical, and Industrial Engineering). 

At the same time, we assign a new program variable with deliberately selected program names that are later used for grouping and summarizing the data. 

```{r extract-cip}
# chemical engineering 
set1 <- cip_filter(cip, series = "^1407") %>%
  cip6_select(program = "Chemical Engineering")

# electrical engineering 
set2 <- cip_filter(cip, series = "^1410") %>%
  cip6_select(program = "Electrical Engineering")

# industrial engineering
set3 <- cip_filter(cip, series = "^1435") %>%
  cip6_select(program = "Industrial Engineering")
```

Combine the data frames. The `cip6_select()` function retains the original 6-digit program names so that one can confirm that the new `program` variable is consistent with the original program name. 

```{r group-cip, results = "hide"}
program_group <- bind_rows(set1, set2, set3) %>%
  print() # or View()
```

```{r echo = FALSE}
kable2html(program_group)
```

<br>



<br>
<a href="#top">&#9650; top of page</a> 





## Group and count students

First we extract the 6-digit CIP codes from our program group to use as search terms to identify students in these programs. 

```{r}
program_group_cip6 <- program_group[["cip6"]]
```

Use `ever_filter()` to access the `midfieldterms` dataset and extract all students who ever enrolled in these programs. Use `race_sex_join()` to access the `midfieldstudents` dataset and append students' race and sex to the data frame. 

```{r gather-ever}
students <- ever_filter(series = program_group_cip6) %>%
  race_sex_join() %>%
  print() # or View()
```

Next we join our custom program names to the student data.

```{r}
students <- left_join(students, program_group, by = "cip6") %>%
  print() # or View()
```

We create a vector of grouping variables and use the seplyr `group_summarize()` function to count the numbers of students ever enrolled in these programs. 

At this point, by grouping and summarizing, we lose all but the three grouping variables and add the new variable `ever` to denote the count. 

```{r}
# grouping variables for summarizing and later for joining 
grouping_variables <- c("program", "race", "sex")

ever_enrolled <- students %>%
  group_summarize(grouping_variables, ever = n()) %>%
  print() # or View()
```

Following similar steps, we use `grad_filter()` to access the `midfielddegrees` dataset and extract all students who graduated from these programs. We group and summarize the counts using `grad` as the new count variable. 

```{r grad}
graduated <- grad_filter(series = program_group_cip6) %>%
  race_sex_join() %>%
  left_join(program_group, by = "cip6") %>%
  group_summarize(grouping_variables, grad = n())
```




<br>
<a href="#top">&#9650; top of page</a> 




## Compute the metric

We join the two data frames by the grouping variables. 

```{r}
stickiness <- left_join(ever_enrolled, graduated, by = grouping_variables)
```

We suggest omitting observations with 5 or fewer students ever enrolled. 

```{r}
stickiness <- stickiness %>%
  filter(ever > 5)
```

And we compute stickiness, the ratio of `grad` to `ever`. 

```{r}
stickiness <- stickiness %>%
  mutate(stick = round(grad / ever, 3)) %>%
  print() # or View()
```




<br>
<a href="#top">&#9650; top of page</a> 




## Graph the results

To prepare the stickiness data for graphing, we remove ambiguous levels of race/ethnicity (Unknown, International, or Other) and then combine race and sex into a single variable. 

```{r prep-data}
stickiness_mw <- stickiness %>%
  filter(!race %in% c("Unknown", "International", "Other")) %>%
  filter(!sex %in% "Unknown") %>%
  mutate(race_sex = paste(race, sex))
```

We graph these results in a *multiway dot plot* [@cleveland1993], a display type based on a data structure of two categorical variables (program and race/ethnicity/sex) and one quantitative variable (stickiness). 

`multiway_order()` converts the two categorical variables to factors and orders their levels by median stickiness.

```{r multiway-order}
stickiness_mw <- stickiness_mw %>%
  select(program, race_sex, stick) %>%
  multiway_order(return_medians = TRUE) %>%
  print() # or View()
```

We use conventional ggplot2 functions to graph stickiness in a multiway dot plot. We also apply our own `theme_midfield()` to edit the visual properties of the graph.

```{r fig1, fig.asp = 1.6/1.6}
ggplot(stickiness_mw, aes(x = stick, y = race_sex)) +
  facet_wrap(vars(program), ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

The ordering of the rows and panels of the multiway plot tell us that for these three engineering majors, Industrial Engineering has the greatest stickiness and Electrical the least; that Asian men have the greatest stickiness and Native American Women the least. The visual anomalies are White women in Electrical with lower stickiness than expected by the ranking overall and Asian men in Chemical, also lower than expected. 

Results will vary depending on the programs one compares. Variations can also be expected if one uses the whole population data available to MIDFIELD member institutions. 






<br>
<a href="#top">&#9650; top of page</a> 


## Session information 

```{r echo = FALSE, comment = NA}
# internal function for session information
my_session(pkg_names)
```

<br>
<a href="#top">&#9650; top of page</a>   

## References

<div id="refs"></div>

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="index.html"   >&#9665; vignettes index </a>  
<a href="../index.html">&#9665;       main page </a> 

