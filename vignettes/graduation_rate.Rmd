---
title: "Graduation rate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Graduation rate}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
resource_files:
  - ../man/figures/vignette-graduation-rate-fig1-1.png
---

```{r include = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  fig.path = "../man/figures/vignette-graduation-rate-"
)
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
asp_ratio_mw <- function(data, categories) {
  cat1 <- categories[1] # panels
  cat2 <- categories[2] # rows
  nlevel1 <- nlevels(data[, get(cat1)])
  nlevel2 <- nlevels(data[, get(cat2)])
  r <- nlevel1 * nlevel2
  q <- 32
  asp_ratio1 <- (r + 2 * nlevel1) / q
  asp_ratio2 <- (r + 2 * nlevel2) / q
  ratios <- c(asp_ratio1, asp_ratio2)
}
```

```{r echo = FALSE}
load("inst/extdata/ipeds-vignette-data.rda")
```

##  Introduction

In the US, the Integrated Postsecondary Education Data System (IPEDS) defines "graduation rate" as the fraction of full-time, first-time, degree/certificate-seeking undergraduate students in a particular year who complete the program in which they matriculate within 150 percent of normal time, i.e., within 6 years for a 4-year program [@IPEDS:2020]. 

The IPEDS definition excludes students who attend college part-time, who transfer from one institution to another, who change majors, and who start college in any term other than the Fall term. The American Council on Education (ACE) estimates that this definition of graduation rate may exclude up to 60% of students at 4-year institutions [@Cook+Hartle:2011]. 

So why use the metric at all? Do graduation rates really matter? Cook and Hartle say, yes they do ... 

> ... because in the eyes of the public, policy makers, and the media, they provide a clear, simple, and logical---if often misleading---number.


### Using less-restrictive criteria 

By definition, graduation rate is a program-based outcome. Thus, how one defines a program affects the outcome. 

For example, consider a student matriculating in mechanical engineering (CIP code 141901) but graduating in 6 years in industrial engineering (CIP code 143501). Applying the IPEDS definition of graduation rate, the student *is not counted* as a graduate in either program because the CIPs of the two programs do not match. 

In contrast, MIDFIELD defines a program by its 2-digit CIP when computing graduation rate. In the example above, mechanical and industrial engineering are both programs in Engineering (CIP code 14). Applying the MIDFIELD definition of graduation rate, the student in the example *is counted* as a Engineering graduate.  

MIDFIELD also includes transfer students, part-time students, and students who start college in any term. The IPEDS-MIDFIELD comparison is summarized in the table. 

<br>
```{r echo = FALSE}
library(midfieldr)
library(midfielddata)
library(data.table)
Constraints <- c(
  "program definition", 
  "timely completion span", 
  "transfer students", 
  "part-time students", 
  "matriculation term"
)
IPEDS <- c(
  "6-digit CIP", 
  "6 years",
  "excluded", 
  "excluded", 
  "Fall only"
)
MIDFIELD <- c(
  "2-digit CIP", 
  "6 years", 
  "included", 
  "included", 
  "any term"
)
Notes <- c(
  "can be changed by user",
  "can be changed by user", 
  "with adjusted time to graduation", 
  "", 
  ""
)

DT <- data.table(Constraints, IPEDS, MIDFIELD, Notes)
setnames(DT, old = c("Notes"), new = c("MIDFIELD notes"))
kable2html(DT, caption = "Comparing graduation rate criteria")
```







### This vignette uses

midfieldr functions 

- `program_bookends()` 
- `subset_feasible()` 
- `timely_completion()`
- `prepare_multiway()`

packages

```{r}
# packages used
library(midfieldr)
library(midfielddata)
library(data.table)
library(ggplot2)

# print max 20 rows, otherwise 10 rows each head/tail
options(datatable.print.nrows = 20, datatable.print.topn = 10)
```




## Choose the programs to study

The program group for the engineering case study is included with midfieldr as the built-in data set `rep_group`. View its help page by running

```r
? rep_group 
```

The data are loaded with midfieldr. 

```{r}
# obtain programs (built-in data set)
program_group <- copy(rep_group)

# examine the result
program_group
```

We extract the `cip6` column as a character vector to gather student data. 

```{r}
# extract a vector of 6-digit CIP codes
group_cip <- program_group$cip6

# examine the result
group_cip
```


Related vignettes 

- *Identify  programs* [(link)](identify_programs.html) illustrates program labeling options 



## Gather the starters  

By "starters" we mean students matriculating in a case study program and FYE students whose starting programs are in the case study.  

- matriculants from `midfieldstudents` by CIP
- FYE starters from `fye_start`

From `midfieldstudents`, we extract the IDs of students matriculating in these programs.  

```{r}
# gather students matriculating in programs
cols_we_want <- c("id", "cip6")
rows_we_want <- midfieldstudents$cip6 %in% group_cip
matriculants <- midfieldstudents[rows_we_want, ..cols_we_want]
matriculants <- unique(matriculants)

# examine the result
matriculants
```

In the *Handle FYE programs* vignette [(link)](handle_fye.html), we derive the starting programs for all FYE students in midfielddata. Again, we filter by the program group CIP codes. 

```{r}
# gather FYE students predicted to start in these programs
cols_we_want <- c("id", "start")
rows_we_want <- fye_start$start %in% group_cip
fye_starters <- fye_start[rows_we_want, ..cols_we_want]
fye_starters <- unique(fye_starters)
setnames(fye_starters, old = "start", new = "cip6")

# examine the result
fye_starters
```

Bind the two data frames

```{r}
starters <- rbind(matriculants, fye_starters)

# examine the result
starters
```

This data frame is the input argument of the  `program_bookends()` function described in the next section. 

save the starters as `rep_start` RDA for use in the timely completion vignette



## Apply the graduation rate criteria


### `program_bookends()` 

The argument of `program_bookends()` is a data frame `starters` with two columns (`id` and `cip6`). The function returns a data frame with three columns keyed by ID: character variables `at_start` and `at_degree` giving the starting and degree CIPs at the level (2-digit by default) used for comparison; and a logical variable `bookend_match`, stating if the matriculating program and degree program match. 

The function compares the degree CIP to the starting CIP provided by the user, ignoring intervening CIPs. 

Optional argument `by_institution` (default FALSE) compares institutions instead of CIPs, `at_start` and `at_degree` report the institution ID, and `bookend_match` states if the matriculating institution and degree institution match. Such institutional graduation rates are sometimes called  "completion rates." 

Example output of `program_bookends(starters)` 


    #>      id  at_start   at_degree  bookend_match 
    #>  MID001        14          14           TRUE
    #>  MID002        14          14           TRUE        
    #>  MID003        14        <NA>          FALSE   
    #>  MID004        14          52          FALSE
    #>  MID005        14          23          FALSE
    #>   ---     



### `timely_completion()` 

The argument of `timely_completion()` is a vector of student IDs. The function returns a data frame with two columns keyed by ID: a numerical variable  `years_to_grad`, giving the time to graduation; and a logical variable `is_timely`, stating if the graduate satisfies the timely completion criterion. 

Example output of `timely_completion(id)` 


    #>      id   years_to_grad   is_timely 
    #>  MID001               5        TRUE
    #>  MID002               7       FALSE        
    #>  MID003            <NA>       FALSE  
    #>  MID004               5        TRUE
    #>  MID005             6.5       FALSE
    #>   ---   


Related vignettes 

- *Timely completion* [(link)](timely_completion.html)  


## Group, summarize, and join 

Next, merge these data frames with the starters. When counting the number of graduates, `bookend_match` and `is_timely` must both be TRUE. All others are counted among the non-graduates. For example, if we created the variable `include_grad` to represent students to be included as graduates in the graduation rate calculation, 

    #>           id   cip6   bookend_match   is_timely  include_grad
    #>    1: MID001 141901            TRUE        TRUE          TRUE
    #>    2: MID002 140801            TRUE       FALSE         FALSE
    #>    3: MID003 141001           FALSE       FALSE         FALSE
    #>    4: MID004 141001           FALSE        TRUE         FALSE
    #>    5: MID005 140801           FALSE       FALSE         FALSE
    #>   ---   



apply `timely_completion(id)` see separate vignette

- obtain entering terms and transfer credit hours by ID
- derive effective start = actual matriculation - TF terms (if any)
- derive time to completion = degree term - effective start 



- assign `meets_criteria` variable = TRUE if and only if time to completion <= 6 years and degree CIP = start CIP (using 2-digit CIPs)

demographics

- merge race and sex
- count by program, race, and sex
- compute graduation rate
- graph





                  

## Compute graduation rate

## Condition the data for display 

## Graph the metric









## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 




