---
title: "Demographics (left outer joins)"
date: "`r Sys.Date()`"
link-citations: yes
bibliography: ../inst/REFERENCES.bib
output: rmarkdown::html_vignette
csl: ../inst/information-science-and-technology.csl
vignette: >
  %\VignetteIndexEntry{Demographics (left outer joins)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
nocite: |
  @Dowle+Srinivasan:2021:data.table
resource_files: |
---

```{r setup}
#| include: false

# code chunks
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = FALSE,
  comment = "#>",
  error = FALSE
)

# figures
knitr::opts_chunk$set(
  fig.path = "../man/figures/art-050-demographics-",
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)

# inline numbers
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})

# accented text
accent <- function (text_string){
    kableExtra::text_spec(text_string, color = "#b35806", bold = TRUE)
}
```

Depending on the goals of a study, additional variables from the MIDFIELD data tables are added to one's working data frame to prepare for additional data manipulation, grouping, and summarizing.  Student demographics is one of the most common examples. 


## Method

We add MIDFIELD variables to a working data frame using a left-outer join by ID. We demonstrate syntax from both base R and data.table. 

Our most common join is student demographics (race/ethnicity and sex) from the `student` table. Yet variables can be joined from any of the MIDFIELD data tables---we illustrate by adding columns from `student`, `term`, and `degree`. 

This vignette in the MIDFIELD workflow.   

1. Planning  
1. Initial processing 
1. Blocs  
1. Grouping variables  
    - `r accent("Demographics")`  
1. Metrics  
1. Results    

*Caveat:* The Student Unit Records included with midfieldr and midfielddata are practice data, not research data, suitable for practice working with SURs but not for drawing inferences about program attributes or student experiences.








## Load practice data

*Start a script*. If you are writing your own script to follow along, we use these packages in this vignette:

```{r}
# Programs
# midfieldr vignette

# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)
```

*Load source data.* MIDFIELD practice data tables as described in [Getting started](art-000-getting-started.html). 

```{r}
# Load practice data sets
data(student, term, degree, package = "midfielddata")
```

*Prepared data.* `study_mcid`, included with midfieldr, contains the IDs of students ever enrolled in the case study programs as developed in [Case study: Data](art-002-case-data.html).

```{r}
#| collapse: true

# Display prepared data
study_mcid
```






## Initial processing

*Optional.* Reduce the dimensions of MIDFIELD data tables. Code reproduced from [Data sufficiency](art-010-data-sufficiency.html). 

```{r}
#| collapse: true

# Optional. Set aside the source files in case they are needed
source_student <- copy(student)
source_term    <- copy(term)
source_degree  <- copy(degree)

# Work with required midfieldr variables only
student <- select_required(source_student)
term    <- select_required(source_term)
degree  <- select_required(source_degree)

# View top few rows of the result
head(student, n = 3L)

head(term, n = 3L)

head(degree, n = 3L)
```


*Copying.* Prevents operations on `DT` from affecting `study_mcid` by reference  [@data.table-reference-semantics].

```{r}
# Working data frame
DT <- copy(study_mcid)

# Display results
DT[]
```



## Left outer joins

An left outer join is a merge operation between two data frame which returns all observations (rows) of the "left" data frame and all the matching rows in the "right" data frame, where specified variables are used for matching.  

Using data.table syntax, we have two approaches: `merge()` and the `Y[X, j]` syntax.

*Using merge().* Using the data.table `merge()` syntax, the `all.x = TRUE` argument creates the left-outer join. To join only race and sex from `student`, we extract those columns before the join. 


```{r}
# Subset of student data frame to join
cols_to_join <- student[, .(mcid, race, sex)]
merge(DT, cols_to_join, by = c("mcid"), all.x = TRUE)
```

Alternatively, one can include the columns selection within the merge operation.

```{r}
merge(DT, student[, .(mcid, race, sex)], by = c("mcid"), all.x = TRUE)
```

*Using Y[X, j].* The second approach---computationally more efficient---uses the data.table `Y[X, j]` syntax were `X` is the "left" data (all rows returned) and `Y` the "right" (matching rows returned). 

```{r}
# Fresh start
DT <- copy(study_mcid)

# Left-outer join student to DT
DT <- student[DT, .(mcid, race, sex), on = c("mcid")]

# Display results
DT[]
```

The  `on` argument defines the shared column to use in matching. The `j` argument, .(mcid, race, sex), defines the columns from both data frames to return. In the `Y[X, j, on]` configuration, all rows of `X` are returned plus matching rows from `Y` with NA in columns of `Y` where there is no match. 

*Demonstrate equivalence.* Showing that the two approaches produce the same result. 

```{r}
#| collapse: true
# Fresh start
DT <- copy(study_mcid)
x <- merge(DT, student[, .(mcid, race, sex)], by = c("mcid"), all.x = TRUE)
setkey(x, NULL)
y <- student[DT, .(mcid, race, sex), on = c("mcid")]
all.equal(x, y)
```

*Order matters.* In the [Degree seeking (inner joins)](art-020-degree-seeking.html) vignette, we show that for inner joins  `X[Y, j]` and `Y[X, j]` return the same result. Not so with outer joins. 

In left-outer joins, `Y[X, j]` returns all rows of `X` and `X[Y, j]` returns all rows of `Y`. 

```{r}
#| collapse: true

# What we want
x <- student[DT, .(mcid, race, sex), on = c("mcid")]

# Not what we want
y <- DT[student, .(mcid, race, sex), on = c("mcid")]

# Equal?
all.equal(x, y)

# Compare N rows
nrow(x)

nrow(y)
```





## Columns from `student`

Above we added  the race and sex columns from `student` to a working data frame. Depending on the goals of a study, other columns could be added as well. 

The variables available in `source_student` are:

```{r}
#| collapse: true

# Variables in the practice data set
names(source_student)
```

Adding transfer status and transfer credit hours. This example illustrates a case in which the original source file is needed because the columns we want were deleted by `select_required()`. 

```{r}
#| collapse: true

# Fresh start
DT <- copy(study_mcid)

# Add variables from student to DT
source_student[DT, .(mcid, transfer, hours_transfer), on = c("mcid")]
```

Adding SAT scores. 

```{r}
#| collapse: true

# Add variables from student to DT
source_student[DT, .(mcid, sat_math, sat_verbal), on = c("mcid")]
```









## Columns from `term`

Joining variables from degree gives us the opportunity to show that in left-outer joins, where rows in `X` have multiple matches in `Y`, a row in `X` is added for every match in `Y`. 

The variables available in `source_term` are:

```{r}
#| collapse: true

# Variables in the practice data set
names(source_term)
```

Adding hours and GPA per term. 

```{r}
#| collapse: true

# Fresh start
DT <- copy(study_mcid)

# Add variables from term to DT
DT <- source_term[DT, .(mcid, institution, term, hours_term, gpa_term), on = c("mcid")]
setkeyv(DT, c("mcid", "term"))

# Display results
DT[]
```

Some data in `term` are known to have two rows for the same term where we would expect one row per student per term. For example, the SUR below shows two entries for the Spring 1994 term (encoded `19933`) that are different only in the `hours_cumul` and `gpa_cumul` values.  

```{r}

options(datatable.print.nrows = 20)
setkeyv(source_term, c("mcid", "term"))

source_term[mcid == "MID25988779"][1:5]
```

```{r}
source_term[mcid == "MID26292075"][1:5]
```

```{r}
source_term[mcid == "MID26437765"][1:5]
```



```{r}



DT[duplicated(DT)][institution == "Institution G"]


```






## Columns from `degree`

Joining variables from degree gives us the opportunity to show that in left-outer joins, where rows in `X` have no match in `Y`, the `Y` column values are NA.

The variables available in `source_degree` are:

```{r}
#| collapse: true

# Variables in the practice data set
names(source_degree)
```

Add degree term and CIP. Where rows in `DT` have no match in `degree`, the `degree` column values are NA.  

```{r}
#| collapse: true

# Add variables from degree to DT
source_degree[DT, .(mcid, term_degree, cip6), on = c("mcid")]
```









## Closing

Using data.table syntax, we demonstrate left outer joins for adding columns from midfielddata tables to a working data frame. 

Adding student demographic columns is typical in MIDFIELD research because  race/ethnicity and sex are so often used for grouping and summarizing. 


## References

<div id="refs"></div>



## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

```{r}
#| eval: false

# Packages
library("midfieldr")
library("midfielddata")
suppressPackageStartupMessages(library("data.table"))

# Printing options for data.table
options(
  datatable.print.nrows = 15,
  datatable.print.topn = 5,
  datatable.print.class = TRUE
)

# Load data sets from midfielddata
data(student, term, degree, package = "midfielddata")

# Using merge
DT <- copy(study_mcid)
cols_to_join <- student[, .(mcid, race, sex)]
merge(DT, cols_to_join, by = c("mcid"), all.x = TRUE)
merge(DT, student[, .(mcid, race, sex)], by = c("mcid"), all.x = TRUE)

# Using Y[X, j]
DT <- copy(study_mcid)
student[DT, .(mcid, race, sex), on = c("mcid")]

# Compare
x <- merge(DT, student[, .(mcid, race, sex)], by = c("mcid"), all.x = TRUE)
setkey(x, NULL)
y <- student[DT, .(mcid, race, sex), on = c("mcid")]
all.equal(x, y)

# Order matters
x <- student[DT, .(mcid, race, sex), on = c("mcid")]
y <- DT[student, .(mcid, race, sex), on = c("mcid")]
all.equal(x, y)
nrow(x)
nrow(y)

# Columns from student
names(student)
DT <- copy(study_mcid)
student[DT, .(mcid, transfer, hours_transfer), on = c("mcid")]
student[DT, .(mcid, sat_math, sat_verbal), on = c("mcid")]

# Columns from term
names(term)
DT <- copy(study_mcid)
unique(term[DT, .(mcid, institution), on = c("mcid")])
unique(term[DT, .(mcid, cip6), on = c("mcid")])

# Columns from degree
names(degree)
degree[DT, .(mcid, term_degree, cip6), on = c("mcid")]
```


```{r}
#| echo: false

# to change the CSS file
# per https://github.com/rstudio/rmarkdown/issues/732
knitr::opts_chunk$set(echo = FALSE)
```

```{css}
blockquote {
    padding:     10px 20px;
    margin:      0 0 20px;
    border-left: 0px
}
caption {
    color:       #525252;
    text-align:  left;
    font-weight: normal;
    font-size:   medium;
    line-height: 1.5;
}
```
