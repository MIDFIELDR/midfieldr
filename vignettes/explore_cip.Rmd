---
title: "Explore program CIP codes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Explore program CIP codes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
link-citations: yes
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
# knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/explore-cip-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

## Introduction

In studying student records, a common first step is to filter the data, retaining some instructional programs and dropping others. 

Programs in the US are encoded by "CIP" codes. CIP is the acronym for *Classification of Instructional Programs*, a taxonomy of academic programs curated by the US Department of Education [@cip2010].  

A CIP code is a 6-digit integer assigned to an instructional program. The 2010 CIP codes are included with midfieldr in the data set `cip`. 

We explore the `cip` data set using the `cip_filter()` function. We illustrate several search strategies and we conclude by constructing an example data set used in subsequent vignettes. 





<br>
<a href="#top">&#9650; top of page</a>



## CIP data

```{r}
# packages used in the vignette
library("midfieldr")
library("dplyr")
library("stringr")
```

The midfieldr package includes a data set called `cip` that provides the 2010 CIP codes and names for `r nrow(cip)` programs, one program per row. Every program has three codes: 

- 6-digit code, a specific program
- 4-digit code, a group of 6-digit programs of comparable content 
- 2-digit code, a grouping of 4-digit groups of related content 

`cip` can be viewed by running

```{r}
# CIP data
print(cip)
```

```{r echo = FALSE}
# x     <- cip_filter(cip, c(110103, 141003, 260911, 400604, 500916, 450204))
# xcip6 <- x$cip6
# nr    <- nrow(x)
# y     <- cip_filter(cip, xcip6) %>% arrange(cip2)
# y[nr+1, c(1, 3, 5)] <- ""
# y[nr+1, c(2, 4, 6)] <- "$\\vdots$"
# kable2html(y)

df <- cip_filter(cip, "^41")
n41 <- df %>% nrow()
n4102 <- df %>%
  cip_filter("^4102") %>%
  nrow()
n4103 <- df %>%
  cip_filter("^4103") %>%
  nrow()
name41 <- df %>%
  select(cip2name) %>%
  unique()

df24 <- cip %>% cip_filter("^24")
n24 <- df24 %>% nrow()
name24 <- df24 %>%
  select(cip2name) %>%
  unique()

df51 <- cip %>% cip_filter("^51")
n51 <- df51 %>% nrow()
name51 <- df51 %>%
  select(cip2name) %>%
  unique()

df1313 <- cip %>% cip_filter("^1313")
n1313 <- df1313 %>% nrow()
name1313 <- df1313 %>%
  select(cip2name) %>%
  unique()
```

To illustrate how 6-, 4-, and 2-digit CIP codes are related, we tabulate below the programs in `r name41` (CIP code 41). We find `r n41` programs at the 6-digit level (codes 410000, 410101, ...) sorted into `r length(unique(df$cip4))` groups at the 4-digit level (codes 4100, 4101, ...) and one grouping  at the 2-digit level (code 41).  

```{r echo=FALSE}
cip %>%
  cip_filter("^41") %>%
  kable2html()
```
<br>

Higher-level groups comprise different numbers of lower-level groups. As shown above, codes 4102 and 4103  include `r n4103` programs each but codes 4100, 4101, and 4199 include only one program each. At the 2-digit level, code 41 comprises N = `r n41` programs total. 

In `cip` overall, the number of programs in a 2-digit grouping ranges from N = `r n24` (code 24, `r name24`) to N = `r n51` (code 51, `r name51`). Similarly, the number of programs in a 4-digit grouping ranges from N = 1, e.g., codes 4100, 4101, and 4199 shown above, to N = `r n1313` (code 1313, `r name1313`). 

To see the full set of 2-digit codes, run: 

```{r echo = -1}
options(tibble.print_min = 12L)
# all 2-digit CIP codes
cip %>%
  select(cip2, cip2name) %>%
  unique() %>%
  print()
```

To learn more, open the help page by running 

```r
? cip
```




<br>
<a href="#top">&#9650; top of page</a> 





## Filtering basics

The variables in `cip` are all characters, facilitating filtering using character search terms. 

```{r echo = -1}
options(tibble.print_min = 5L)
print(cip)
```

`cip_filter()` filters a data frame using character search terms. The arguments are: 

- `data`: data frame of CIP codes and names    
- `keep_any`: character vector used to filter `data`, retaining rows containing any of these terms.
- `drop_any`: character vector, optional argument. The output of the `keep_any` filter is the input to the `drop_any` filter, dropping all rows in which any matches or partial matches are detected.


For example, filtering the CIP data for all programs containing the word "engineering" yields `r nrow(cip_filter(cip, "engineering"))` observations. 

```{r}
# filter basics
cip_filter(data = cip, keep_any = "engineering") %>%
  print()
```

The first two argument names can be omitted if they are in the correct order. 

```{r}
# argument names omitted
cip_filter(cip, "engineering") %>%
  print()
```

If the optional `drop_any` argument is used, it must be named, 

```{r}
# incorrect drop_any argument
cip_filter(cip, "civil engineering", "technology") %>%
  print()

# correct drop_any argument
cip_filter(cip, "civil engineering", drop_any = "technology") %>%
  print()
```



To learn more, open the help page by running 

```r
? cip_filter()
```


<br>
<a href="#top">&#9650; top of page</a> 





## Filtering examples

### 1. Using keywords and phrases

Suppose we want to find the CIP codes and names for all programs in Civil Engineering. The search is case-insensitive, so we start with the following code chunk. 

```{r}
# example 1 filter by keywords
cip_filter(cip, "civil") %>%
  print() # View() can be used instead
```

For clarity on this vignette page, data frames are sometimes printed as HTML tables. For example, the previous code chunk yields this table:

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kable2html(cip_filter(data = cip, keep_any = "civil"))
```
<br>

The search returns some programs with Civilization in their names as well as Engineering Technology. If we wanted Civil Engineering only, we can use a sequence of function calls, where the outcome of the one operation is assigned to the first argument of the next operation via the pipe `%>%` operator.  

The following code chunk could be read as, "Start with the `cip` data frame, then keep any rows in which 'civil' is detected, then keep any rows in which 'engineering' is detected, then drop any rows in which 'technology' is detected."

```{r results = "hide"}
cip %>%
  cip_filter(keep_any = "civil") %>%
  cip_filter(keep_any = "engineering") %>%
  cip_filter(drop_any = "technology") %>%
  print()
```

```{r echo = FALSE}
kable2html(cip %>%
  cip_filter("civil") %>%
  cip_filter("engineering") %>%
  cip_filter(drop_any = "technology"))
```
<br>

Seeing that all Civil Engineering programs have the same `cip4name`, we could shorten our search to one line, 

```{r results = "hide"}
cip_filter(cip, "civil engineering", drop_any = "technology") %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, "civil engineering", drop_any = "technology"))
```




<br>
<a href="#top">&#9650; top of page</a> 



### 2. Using numerical codes

Suppose we want to study programs relating to German culture, language, and literature. Using  "german" for the `keep_any` value yields 

```{r results = "hide"}
# example 2 filter by codes
cip_filter(cip, "german") %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, "german"))
```

<br>

From the 6-digit program names we find only two that are of interest, German Studies (050125) and German Language and Literature (160501). We use a character vector to assign these two codes to the `keep_any` argument. 
 
```{r results = "hide"}
cip_filter(cip, c("050125", "160501")) %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, c("050125", "160501")))
```
<br>

If the 6-digit codes are entered as integers, they are coerced to characters and used as search terms as above, yielding the same result. 
 
```{r results = "hide"}
cip_filter(cip, c(050125, 160501)) %>%
  print()
```

Because integers are coerced to characters, we can use a numerical sequence as a series using `seq()`. Here, the sequence is from 540101 to 540199. Invalid codes, e.g., from 540109--540198, are silently ignored. 

```{r results = "hide"}
# series as a sequence
cip_filter(cip, seq(540101, 540199, 1)) %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, seq(540101, 540199, 1)))
```





<br>
<a href="#top">&#9650; top of page</a> 





### 3. Using regular expressions

Specifying 4-digit codes yields a data frame all 6-digit programs containing the 4-digit string. We use the regular expression notation `^` to match the start of the strings.

```{r results = "hide"}
# 4-digit example matching the start of the string
cip_filter(cip, c("^1407", "^1408")) %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, c("^1407", "^1408")))
```

<br>

The 2-digit series represent the most general groupings of related programs. Here, the result includes all History programs. 

```{r results = "hide"}
# 2-digit example
cip_filter(cip, "^54") %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, "^54"))
```

<br>

The series argument can include any combination of 2, 4, and 6-digit codes. 

```{r results = "hide"}
# a series with 2, 4, and 6-digits specified
cip_filter(cip, c("^24", "^4102", "^450202")) %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, c("^24", "^4102", "^450202")))
```










<br>
<a href="#top">&#9650; top of page</a> 






### 4. Using named series

midfieldr includes several datasets of *named series*. A named series is a character vector of 6-digit CIP codes that belong to a group of programs such as Engineering, Physical Sciences, STEM, etc. 

A named series is assigned to the series argument in `cip_filter()`. 

```{r results = "hide"}
# the math and statistics series
cip_filter(cip, keep_any = cip_math_stat) %>%
  print()
```

```{r echo = FALSE}
kable2html(cip_filter(cip, keep_any = cip_math_stat))
```

<br>

To see the full set of available named series, see the help page by running 

```r
? cip_series
```





<br>
<a href="#top">&#9650; top of page</a> 






## Case study  

In the midfieldr vignettes, we use a case study of four programs (Civil, Electrical, Industrial, and Mechanical Engineering) to illustrate our process of computing persistence metrics. 

The case study begins here, by extracting CIP data for the four engineering programs. 

```{r echo = -1}
options(tibble.print_min = 15L)
cip_filter(cip, keep_any = "engineering", drop_any = "technology") %>%
  cip_filter(keep_any = c("civil", "electrical", "industrial", "mechanical")) %>%
  print()
```

The results show that the codes we want are at the 4-digit level:  1408, 1410, 1419, and 1435. We use these codes as search strings to filter `cip` and assign the result to the object `exa_cip`. 


```{r}
# example CIP excerpt for case study
exa_cip <- cip_filter(cip, c("^1408", "^1410", "^1419", "^1435")) %>%
  print()
```

Because we'll be using these data again, it would be useful to write them to file, e.g., by running `saveRDS(exa_cip, "data/exa_cip")`. 

However, for convenience, `exa_cip` has been included in midfieldr.  Loading midfieldr makes the data available, for example, 

```{r}
library(midfieldr)
x <- exa_cip
```

To see the help page, run

```r
? exa_cip
```



## References

<div id="refs"></div>






## Appendix

### Complete script

In response to requests from some of our workshop attendees, we collect the vignette code chunks in one script. We condense the script by omitting exploratory steps to focus on the steps that produce the results. 

```{r eval=FALSE}
# packages used in the vignette
library("midfieldr")
library("dplyr")

# CIP data
print(cip)

# all 2-digit CIP codes
cip %>%
  select(cip2, cip2name) %>%
  unique()

# filter basics
cip_filter(data = cip, keep_any = "engineering")
cip_filter(cip, "engineering")
cip_filter(cip, "civil engineering", drop_any = "technology")

# example 1 filter using keywords
cip_filter(cip, "civil")
cip %>%
  cip_filter(keep_any = "civil") %>%
  cip_filter(keep_any = "engineering") %>%
  cip_filter(drop_any = "technology")

# example 2 filter using numerical codes
cip_filter(cip, "german")
cip_filter(cip, c("050125", "160501"))
cip_filter(cip, c(050125, 160501))
cip_filter(cip, seq(540101, 540199, 1))

# example 3 filter using regular expressions
cip_filter(cip, c("^1407", "^1408"))
cip_filter(cip, "^54")
cip_filter(cip, c("^24", "^4102", "^450202"))

# example 4 filter using named series
cip_filter(cip, keep_any = cip_math_stat)

# example CIP excerpt for case study
exa_cip <- cip_filter(cip, c("^1408", "^1410", "^1419", "^1435"))
```

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 








