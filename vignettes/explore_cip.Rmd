---
title: "Explore program CIP codes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Explore program CIP codes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
link-citations: yes
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
# knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/vign-explore-cip-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

## Introduction

In studying student records, a common first step is to subset the data, retaining some instructional programs and dropping others. 

Programs in the US are encoded by "CIP" codes. CIP is the acronym for *Classification of Instructional Programs*, a taxonomy of academic programs curated by the US Department of Education [@cip2010].  

A CIP code is a 6-digit integer assigned to an instructional program. The 2010 CIP codes are included with midfieldr in the data set `cip`. 

We explore the `cip` data set using the `get_cip()` function. We illustrate several search strategies and we conclude by constructing an example data set used in subsequent vignettes. 





<br>
<a href="#top">&#9650; top of page</a>



## CIP data

```{r}
# load packages
library("midfieldr")
```

The midfieldr package includes a data set called `cip` that provides the 2010 CIP codes and names for `r nrow(cip)` programs, one program per row. Every program has three codes: 

- 6-digit code, a specific program
- 4-digit code, a group of 6-digit programs of comparable content 
- 2-digit code, a grouping of 4-digit groups of related content 

```{r echo = FALSE}
df     <- get_cip(cip, "^41")
n41    <- nrow(df)
n4102  <- get_cip(df, "^4102") %>% nrow()
n4103  <- get_cip(df, "^4103") %>%nrow()
name41 <- df$cip2name %>% unique()

df24   <- get_cip(cip, "^24")
n24    <- nrow(df24)
name24 <- df24$cip2name %>% unique()

df51   <- get_cip(cip, "^51")
n51    <- nrow(df51)
name51 <- df51$cip2name %>% unique()

df1313   <- get_cip(cip, "^1313")
n1313    <- nrow(df1313)
name1313 <- df1313$cip2name %>% unique()

cip <- get_cip(cip) # removes data.frame class if present 
```

View the internal structure of `cip` using `str()`.

```{r}
# examine variable types
str(cip)
```

If you prefer to see a spreadsheet-like array of the data, run

```r
View(cip)
```

In the table below, we show all programs associated with the 2-digit code "41", for "`r name41`" programs. We find 

- one grouping  at the 2-digit level (code 41), that contains...  
- `r length(unique(df$cip4))` groups at the 4-digit level (codes 4100, 4101, ...), that contain...
- `r n41` programs at the 6-digit level (codes 410000, 410101, ...) 

The 6-digit codes and names represent distinct instructional programs. 

```{r echo=FALSE}
sub_cip <- get_cip(cip, "^41")
kable2html(sub_cip)
```
<br>

Higher-level groups comprise different numbers of lower-level groups. As shown above, codes 4102 and 4103  include `r n4103` programs each but codes 4100, 4101, and 4199 include only one program each. At the 2-digit level, code 41 comprises N = `r n41` programs total. 

In `cip` overall, a 2-digit grouping can include anywhere from `r n24` programs  (code 24 `r name24`) to `r n51` programs (code 51 `r name51`). Similarly, a 4-digit grouping can include anywhere from 1 program (codes 4100, 4101, and 4199 shown above) to `r n1313` programs (code 1313 `r name1313`). 

To learn more, open the help page by running 

```r
? cip
```




<br>
<a href="#top">&#9650; top of page</a> 





## Filtering basics

The variables in `cip` are all characters, facilitating filtering using character search terms. 

```{r echo = -1}
cip <- get_cip() # quietly removes data.table class
# examine variable types 
str(cip)
```

`get_cip()` filters a data frame using character search terms. The arguments are: 

- `data` data frame to be subsetted
- `keep_any` character vector of search patterns for retaining rows, not case-sensitive 
- `drop_any` (optional) character vector of search patterns for dropping rows

For example, filtering the CIP data for all programs containing the word "engineering" yields `r nrow(get_cip(cip, "engineering"))` observations. 

```{r}
# filter basics
sub_cip <- get_cip(data = cip, keep_any = "engineering")
str(sub_cip)
```

The first two argument names can be omitted if they are in the correct order. If the optional `drop_any` argument is used, it must be named, 

```{r}
# only the drop_any argument must be named
sub_cip <- get_cip(cip, "civil engineering", drop_any = "technology")
print(sub_cip)
```

To learn more, open the help page by running 

```r
? get_cip()
```



<br>
<a href="#top">&#9650; top of page</a> 





## Filtering examples

### 1. Using keywords and phrases

Suppose we want to find the CIP codes and names for all programs in Civil Engineering. The search is case-insensitive, so we start with the following code chunk. 

```{r}
# example 1 filter using keywords
sub_cip <- get_cip(cip, keep_any = "civil")
# examine the result
print(sub_cip)
```

The same information is tabulated below to help you see the structure.  In the examples that follow, we show a table like this one instead of the R output. 

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kable2html(sub_cip)
```
<br>

The search returns some programs with Civilization in their names as well as Engineering Technology. If we wanted Civil Engineering only, we can use a sequence of function calls, where the outcome of the one operation is assigned to the first argument of the next operation via the pipe `%>%` operator.  

The following code chunk could be read as, "Start with the `cip` data frame, then keep any rows in which 'civil' is detected, then keep any rows in which 'engineering' is detected, then drop any rows in which 'technology' is detected."

```{r results = "hide"}
# first pass
sub_cip <- get_cip(cip, keep_any = "civil")
# refine the search
sub_cip <- get_cip(sub_cip, keep_any = "engineering")
# refine further 
sub_cip <- get_cip(sub_cip, drop_any = "technology")
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

Seeing that all Civil Engineering programs have the same `cip4name`, we could combine our search terms in one argument set, 

```{r results = "hide"}
sub_cip <- get_cip(cip, keep_any = "civil engineering", drop_any = "technology")
```

```{r echo = FALSE}
kable2html(sub_cip)
```




<br>
<a href="#top">&#9650; top of page</a> 



### 2. Using numerical codes

Suppose we want to study programs relating to German culture, language, and literature. Using  "german" for the `keep_any` value yields 

```{r results = "hide"}
# example 2 filter using numerical codes
sub_cip <- get_cip(cip, keep_any = "german")
```

```{r echo = FALSE}
kable2html(sub_cip)
```

<br>

From the 6-digit program names we find only two that are of interest, German Studies (050125) and German Language and Literature (160501). We use a character vector to assign these two codes to the `keep_any` argument. 
 
```{r results = "hide"}
sub_cip <- get_cip(cip, keep_any = c("050125", "160501"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```
<br>

If the 6-digit codes are entered as integers, they produce an error. 
 
```{r results = "hide"}
get_cip(cip, keep_any = c(050125, 160501))
```





<br>
<a href="#top">&#9650; top of page</a> 





### 3. Using regular expressions

Specifying 4-digit codes yields a data frame all 6-digit programs containing the 4-digit string. We use the regular expression notation `^` to match the start of the strings.

```{r results = "hide"}
# example 3 filter using regular expressions
sub_cip <- get_cip(cip, keep_any = c("^1407", "^1408"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```

<br>

The 2-digit series represent the most general groupings of related programs. Here, the result includes all History programs. 

```{r results = "hide"}
# 2-digit example
sub_cip <- get_cip(cip, keep_any = "^54")
```

```{r echo = FALSE}
kable2html(sub_cip)
```

<br>

The series argument can include any combination of 2, 4, and 6-digit codes. 

```{r results = "hide"}
# a series with 2, 4, and 6-digits specified
sub_cip <- get_cip(cip, keep_any = c("^24", "^4102", "^450202"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```







<br>
<a href="#top">&#9650; top of page</a> 



### 4. Search terms that cannot be found

If the `keep_any` argument includes terms that cannot be found in the CIP data frame, the unsuccessful terms are identified in a message and the successful terms produce the usual output. 

For example, the following `keep_any` argument includes three search terms that are not present in the CIP data ("111111", "^55", and "Bogus") and two that are ("050125" and "160501").  

```{r message = TRUE}
# unsuccessful terms produce a message 
sub_cip <- get_cip(cip, keep_any = c("050125", "111111", "160501", "Bogus", "^55"))

# but the successful terms are returned
sub_cip
```

However, as seen earlier, if none of the search terms are found, an error occurs. 

```{r}
get_cip(cip, keep_any = c("111111", "Bogus", "^55"))
```




<br>
<a href="#top">&#9650; top of page</a> 



## Case study  

In the midfieldr vignettes, we use a case study of four programs (Civil, Electrical, Industrial, and Mechanical Engineering) to illustrate our process of computing persistence metrics. 

The case study begins here, by extracting CIP data for the four engineering programs. 

```{r results = "hide"}
sub_cip <- get_cip(cip, keep_any = "engineering", drop_any = "technology") 
sub_cip <- get_cip(sub_cip, keep_any = c("civil", "electrical", "industrial", "mechanical"))
```

```{r echo = FALSE}
kable2html(sub_cip)
```

The results show that the codes we want are at the 4-digit level:  1408, 1410, 1419, and 1435.

```{r}
exa_cip <- get_cip(cip, keep_any = c("^1408", "^1410", "^1419", "^1435"))
```

```{r echo = FALSE}
kable2html(exa_cip)
```

For convenience, `exa_cip` is included in midfieldr as a built-in data set. View its help page by running

```r
? exa_cip
```



## References

<div id="refs"></div>






## Appendix

### Complete script

In response to requests from some of our workshop attendees, we collect the vignette code chunks in one script. We condense the script by omitting exploratory steps to focus on the steps that produce the results. 

```{r eval=FALSE}
# load packages
library("midfieldr")

# examine variable types
str(cip)

# filter basics
get_cip(data = cip, keep_any = "engineering")
get_cip(cip, "civil engineering", drop_any = "technology")

# example 1 filter using keywords
sub_cip <- get_cip(cip, keep_any = "civil")
# refine the search
sub_cip <- get_cip(sub_cip, keep_any = "engineering")
# refine further 
sub_cip <- get_cip(sub_cip, drop_any = "technology")
# in one line
sub_cip <- get_cip(cip, keep_any = "civil engineering", drop_any = "technology")

# example 2 filter using numerical codes
sub_cip <- get_cip(cip, keep_any = "german")
sub_cip <- get_cip(cip, keep_any = c("050125", "160501"))

# example 3 filter using regular expressions
sub_cip <- get_cip(cip, keep_any = c("^1407", "^1408"))
sub_cip <- get_cip(cip, keep_any = "^54")
sub_cip <- get_cip(cip, keep_any = c("^24", "^4102", "^450202"))

# example 4 search terms that cannot be found
sub_cip <- get_cip(cip, keep_any = c("050125", "111111", "160501", "Bogus", "^55"))

# case study data set
get_cip(cip, keep_any = c("^1408", "^1410", "^1419", "^1435"))
print(exa_cip)
```

<br>
<a href="#top"         >&#9650;     top of page </a>     
<a href="../index.html">&#9665;       main page </a> 








