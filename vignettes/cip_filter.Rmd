---
title: "Selecting CIP codes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Selecting CIP codes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
---

```{r setup, echo = FALSE, message = FALSE, purl = FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(
  echo = TRUE, # varies from one Rmd to another
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  fig.path = "../man/figures/cip-filter-"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)

# normally, purl is FALSE. But in some code chunks, I want purl = TRUE so that the code in the vignette is executed to pass R CMD check. These next few lines set that up. In the code chunk header, add opts.label = 'dopurl'
knitr::knit_hooks$set(purl = knitr::hook_purl)
knitr::opts_template$set(dopurl = list(purl = TRUE, error = FALSE))
```

```{r echo = FALSE}
# unpack data bits
library(midfieldr)
load("R/sysdata.rda")

# data_bits <- midfieldr:::data_bits
obs_cip <- round(data_bits$data[data_bits$name == "obs_cip"] / 1e+0, 1)
var_cip <- data_bits$data[data_bits$name == "var_cip"]
size_cip <- round(data_bits$data[data_bits$name == "size_cip"] / 1e+3, 0)

# function to print to html using kable, controll font size
kable2html <- function(...) {
  kable(..., "html") %>%
    kable_styling(font_size = 12)
}
```

The Classification of Instructional Programs (CIP) is a taxonomy of academic programs curated by an agency of the US Department of Education [@cip2010]. 

```{r}
# packages used in the vignette
library(midfieldr)
library(dplyr)
library(stringr)
library(knitr)
library(seplyr)
```

```{r echo = FALSE}
# use kable_styling() for output but conceal from novice user
library(kableExtra)
```

## Introduction

Instructional programs are encoded in `cip`, a data set bundled with midfieldr. `cip` is a data frame of character variables listing the 2, 4, and 6-digit CIP codes and program names in the database. To learn more, open the help page by running `?cip`. 

Using `glimpse()` (a [dplyr/tibble](https://tibble.tidyverse.org/) function) reveals that `cip` has   `r obs_cip` unique observations (6-digit programs) and shows the first few values of the `r var_cip` variables. 

```{r}
glimpse(cip)
```

`cip_filter()` filters a reference data frame (the default is `cip`) for specified search terms. The two arguments are: 

- `series` an atomic character vector of search terms to filter by
- `reference` the data frame to be filtered and returned 

For R novices, an "atomic vector" is a one-dimensional, homogeneous data structure, often created using the `c()` function. For more information on data structures, see [Advanced R](http://adv-r.had.co.nz/Data-structures.html). 

With no arguments, `cip_filter()` returns the complete `cip` data set. 

```{r}
cip_filter() %.>%
  print(.)
```

## Search by keywords

Because `cip_filter()` searches all columns in `reference`, we can search by keyword to find the CIP codes that match the programs under study. The search is case-sensitive.  

For example, if we wanted all Civil Engineering programs, we might try keywords "civil" and "Civil". `kable()` (a [knitr](https://yihui.name/knitr/) function) is used to print the data frame as a table. 

```{r results = "hide"}
# series with a keyword
cip_filter(series = c("Civil", "civil")) %.>%
  kable(.)
```

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
kable2html(cip_filter(series = c("Civil", "civil")))
```

The search returns some programs with Civilization in their names as well as Engineering Technology. If we wanted Civil Engineering only, we should search for CIPs that start with the 4-digit "1408"  code. We use the regular expression notation `^` to match the start of the strings. 

```{r results = "hide"}
# series with a 4-digit code
cip_filter(series = "^1408") %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = "^1408"))
```

In the next example, suppose we want to study programs relating to German culture, history, politics, language, and literature. Using  "German" for the `series` value yields 

```{r results = "hide"}
# series with a keyword
cip_filter(series = c("German", "german")) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = c("German", "german")))
```

From the result we find the specific 6-digit codes we want and refine the search to obtain, 
 
```{r results = "hide"}
# series with a 6-digit code
cip_filter(series = c("050125", "160501", "160599")) %.>%
  kable(.)
```
 
```{r echo = FALSE}
kable2html(cip_filter(series = c("050125", "160501", "160599")))
```

## Search by CIP codes 

As illustrated above, assigning CIP codes to `series` yields a data frame of all rows from `reference` that contain those character strings. Invalid codes as well as valid codes not in the midfieldr `cip` dataset are silently ignored. 

Specifying 6-digit codes yields a data frame with a row for each 6-digit code.  

```{r results = "hide"}
# 6-digit example
cip_filter(series = c("140802", "140803")) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = c("140802", "140803")))
```

Specifying 4-digit codes yields a data frame with as many rows as there are rows that include the search strings. We use the regular expression notation `^` to match the start of the strings.

```{r results = "hide"}
# 4-digit example matching the start of the string
cip_filter(series = c("^1407", "^1408")) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = c("^1407", "^1408")))
```


The 2-digit series represent the most general groupings of related programs. Here, the result includes all History codes and programs. 

```{r results = "hide"}
# 2-digit example
cip_filter(series = "^54") %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = "^54"))
```

The series argument can include any combination of 2, 4, and 6-digit codes. 

```{r results = "hide"}
# a series with 2, 4, and 6-digits specified
cip_filter(series = c("^24", "^4102", "^450202")) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = c("^24", "^4102", "^450202")))
```

A series assigned numerically is coerced to characters. Invalid codes in the sequence, e.g., 540109 and 540110, are silently ignored. 

```{r results = "hide"}
# series as a sequence
cip_filter(series = seq(540102, 540110, 1)) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = seq(540102, 540110, 1)))
```

## Search by named series

midfieldr includes several datasets of *named series*. A named series is a character vector of 6-digit CIP codes that belong to a group of programs such as Engineering, Physical Sciences, STEM, etc. To see the full set of available named series, see the help page `?cip_series`. 

A named series is assigned to the series argument in `cip_filter()`. 

```{r}
# the engineering series
cip_engr

cip_filter(series = cip_engr) %.>%
  glimpse(.)
```

The 6-digit codes `14XXXX` and `14YYYY` are correct, appearing in the engineering series only. Run `?cip` for more information.   

## Using a previous result as a data argument 

A data frame produced by `cip_filter()` can be used as the `reference` argument in a subsequent use of `cip_filter()`. For example, suppose we examine a 2-digit series: 

```{r}
df1 <- cip_filter(series = "^49")
```

The we decide we only need the "4903" subset. We can use the data frame `df1` from above as the `reference` argument.  

```{r results = "hide"}
# use a previous result as a data argument
cip_filter(series = "^4903", reference = df1) %.>%
  kable(.)
```

```{r echo = FALSE}
kable2html(cip_filter(series = "^4903", reference = df1))
```

`cip_filter()` is compatible with the pipe operator `%>%` (a [magrittr](https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html) function). A previously filtered CIP data frame is the `reference = .` argument for the subsequent operation. For example: 

```{r results = "hide"}
# filtering sequentially
cip_filter(series = "History") %.>%
  cip_filter(series = "American", reference = .) %.>%
  kable(.)
```

```{r echo = FALSE}
# using kable_styling() for output but conceal from novice user
cip_filter(series = "History") %.>%
  cip_filter(series = "American", reference = .) %.>%
  kable2html(.)
```

```{r results = "hide"}
# filtering sequentially
cip_filter(series = "^14") %.>%
  cip_filter(series = "Civil", reference = .) %.>%
  kable(.)
```

```{r echo = FALSE}
# print for html with smaller font
cip_filter(series = "^14") %.>%
  cip_filter(series = "Civil", reference = .) %.>%
  kable2html(.)
```


## Issue bin

- Possibly make `cip_filter()` case-insensitive 

## References

