---
title: "Timely completion"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Timely completion}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: ../inst/REFERENCES.bib
csl: ../inst/body-and-society.csl
link-citations: yes
resource_files:
  - ../man/figures/art-04-timely-completion-fig1-1.png
---

```{r include = FALSE}
knitr::opts_chunk$set(fig.path = here::here("man/figures", 
                                            "art-04-timely-completion-"))
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center"
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
kable2html <- function(x, font_size = NULL, caption = NULL) {
  font_size <- ifelse(is.null(font_size), 11, font_size)
  kable_in <- knitr::kable(x, format = "html", caption = caption)
  kableExtra::kable_styling(kable_input = kable_in, font_size = font_size)
}
asp_ratio_mw <- function(data, categories) {
  cat1 <- categories[1] # panels
  cat2 <- categories[2] # rows
  nlevel1 <- nlevels(data[, get(cat1)])
  nlevel2 <- nlevels(data[, get(cat2)])
  r <- nlevel1 * nlevel2
  q <- 32
  asp_ratio1 <- (r + 2 * nlevel1) / q
  asp_ratio2 <- (r + 2 * nlevel2) / q
  ratios <- c(asp_ratio1, asp_ratio2)
}
```

## Introduction

Students generally expect to complete a program within some span of years after entry. IPEDS defines timely completion as one of three values: 100%, 150%, or 200%  of the "normal" time to completion at the institution. For a 4-year institution, the 150% model (6 years) is in common use.  

However, the span over which program completion might be considered "timely" is highly dependent on the choices a student makes such as transferring  institutions or changing majors. 

For example, the figure illustrates the history of two students who enter in Fall 2010 and graduate in Spring 2015. We assume a basis of 6 years for timely completion. 

- Student A is a first-time-in-college student with a timely completion (*TC*) term of Spring 2016. Their completion is timely because their degree term comes before their *TC* term.

- Student B is a transfer student, entering as a junior. Having already satisfied 2 years of program requirements, their *TC* term is Spring 2014. Their completion is not timely because their degree term comes after their *TC* term.

<br>
```{r fig1, echo = FALSE, fig.asp = 5/10}
library("ggplot2")
library("data.table")
callout_color     <- "gray60"
callout_line_size <- 0.3
anno_size         <- 3.5 # 3.5 approx 10 point
vert_baseline     <- 1.07

y1    <- 1.5
y2    <- 1.7
y_lim <- c(1.3, 1.8)

x1    <- 1990
x2    <- 1993
x3    <- 1994
x4    <- 1995
x_lim <- c(x1 - 1.5, x4 + 1.5)

# arrows
df_arrow <- wrapr::build_frame(
  "x", "x_end", "y" |
    x1, x4, y2 |
    x1, x2, y1
)
setDT(df_arrow)
df_arrow[, x_mid := (x + x_end) / 2]

# dimension lines
del <- 0.03
dim_lines <- wrapr::build_frame(
  "x", "y", "y_end" |
    x1, y1, y2 |
    x2, y1, y1 |
    x4, y2, y2 |
    x3, y1, y2
)
setDT(dim_lines)
dim_lines[, `:=` (y = y - 2*del, y_end = y_end + del)]

# grad markers
grad <- wrapr::build_frame(
  "x", "y" |
    x3, y1 |
    x3, y2
)

ggplot(data = df_arrow) +
  scale_x_continuous(limits = x_lim, 
                     breaks = c(1990, 1993, 1994, 1995), 
                     labels = c("Fall 2010", "Spr 14", "Spr 15", "Spr 16")) +
  scale_y_continuous(limits = y_lim) +
  labs(
    y = "",
    x = "Term",
    title = "Illustrating timely completion"
  ) +
  theme_light() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  ) +
  # label start of student row
  annotate("text",
           x = df_arrow$x - 0.6,
           y = df_arrow$y,
           size = anno_size,
           label = c("student A", "student B"), 
 
           vjust = 0.5, 
           hjust = 1
  ) +
  # label end of student row
  # annotate("text",
  #          x = 1995.2,
  #          y = df_arrow$y,
  #          size = anno_size,
  #          label = c("timely", 
  #                    "not timely"),
  #          vjust = 0.5, 
  #          hjust = 0
  # ) +
  # arrows
  geom_segment(aes(x = x, xend = x_end, y = y, yend = y),
               color = callout_color,
               size = callout_line_size,
               arrow = arrow(
                 type = "closed",
                 ends = "both",
                 length = unit(2, "mm")
               ),
               arrow.fill = callout_color
  ) +
  # label arrows
  annotate("text",
           x = df_arrow$x_mid,
           y = df_arrow$y,
           size = anno_size,
           label = "TC span",
           vjust = -0.5
  ) +
  # dimension lines
  geom_segment(data = dim_lines, 
               aes(x = x, xend = x, y = y, yend = y_end),
               color = callout_color,
               size = callout_line_size, 
               linetype = c(1, 1, 1, 2)
  ) +
  # label lines
  annotate("text",
           x = dim_lines$x,
           y = dim_lines$y,
           size = anno_size, 
           label = c("entry term",
                     "TC term",
                     "TC term",
                     "degree term"), 
           vjust = 1,
           hjust = c(-0.1, 1.1, 1.1, -0.1)
  ) +
  # grad points
  geom_point(data = grad, aes(x = x, y = y), 
             size = 2)
```

entry term
: Term in which a student enters the institution. 

timely completion span (TC span)
: Span of years after entry over which program completion would be considered timely. Depends on the heuristic used to evaluate a student's history in the data record. 

timely completion term (TC term)
: Last term for which program completion would be considered timely. The end of the TC span. 

degree term 
: Term in which a student completes a program.

### Outline

- Start with 
- do
- do
- do
- Result is

### This vignette uses

midfieldr functions 

- `add_completion_timely()`  
- `add_data_sufficiency()`
- `add_institution()`
- `add_timely_term()` 
- `filter_match()` 


packages

```{r}
# packages used
library("midfieldr")
library("midfielddata")
library("data.table")
library("ggplot2")

# optional code to control data.table printing
options(datatable.print.nrows = 10, 
        datatable.print.topn  = 5, 
        datatable.print.class = TRUE)
```

data

```{r}
# load data tables from midfielddata
data(student, term, degree)
```
  
## Estimate the timely completion term 

To illustrate how we estimate and apply the timely completion term, we start with the case study students. 

```{r}
# case study IDs and CIP codes
study_students
```

To confirm that the pool of students are all degree-seeking, we use `filter_match()` to match to the IDs in the `student` table. 

```{r}
# limit population to degree-seeking students
DT <- filter_match(study_students, 
                   match_to = student, 
                   by_col = "mcid")

# examine the result
DT
```

We use `add_timely_term()` to estimate the timely completion term. View its help page by running

```r
? add_timely_term
```

`add_timely_term()` accesses the `term` table and adds a new column, `timely_term`, to the data frame input. For example, 

```{r}
# estimate the timely completion term
DT <- add_timely_term(DT, midfield_table = term)
DT
```

The `timely_term` column contains the estimate of the timely completion term for each student. The basic heuristic starts with span number of years for each student (default 6 years) and adjusts the span by subtracting a whole number of years based on the level at which the student is admitted.

For example, a student admitted at the second-year level is assumed to have completed one year of a program, so their span is reduced by one year. Similarly, spans are reduced by two years for students admitted at the 3rd-year level and by three years for students admitted at the fourth-year level. The adjusted span of years is added to their starting term; the result is the timely completion reported in the timely_term column added to the data frame.

Optional arguments include `details` and `span`. 

```r
add_timely_term(dframe,
                midfield_table,
                ...,
                details = NULL,
                span = NULL)
```

- The `span` argument has a default setting of 6 years but can be reset by the user, e.g., including the argument `span = 4` 
- The `details` argument default is FALSE. When set to TRUE, additional columns are provided providing the information on which the `timely_term` was based. 

Setting `details` to TRUE yields additional columns for 

- `term_i` 
- `level_i` 
- `adj_span` 
 
```{r}
# estimate the timely completion term with details shown
DT <- add_timely_term(DT, 
                      midfield_table = term, 
                      details = TRUE
                      )
DT
```

If the input data frame has existing columns matching any of the new added columns, the existing columns are overwritten. Thus, you can repeat running the function and still obtain the expected results, 

```{r}
# repeat
DT <- add_timely_term(DT, 
                      midfield_table = term, 
                      details = TRUE
                      )
DT
```

And you can run the function again, effectively removing the details columns with no effect on the main outcome, 

```{r}
# remove details
DT <- add_timely_term(DT, 
                      midfield_table = term, 
                      details = FALSE
                      )
DT
```


## Assess timely completion 

Depends on `timely_term` and `mcid` column in input, Accesses `degree` table.

- Untimely graduation? Grad reclassified as nongrad

```{r}
DT <- add_completion_timely(DT,
                            midfield_table = degree, 
                            details = TRUE)
DT

# no details
DT <- add_completion_timely(DT,
                            midfield_table = degree, 
                            details = FALSE)
DT
```



















## Assess data sufficiency 



This step requires `timely_term` and `institution` column in input.

To get institution

```{r}
DT <- add_institution(DT, 
                      midfield_table = term)
DT

```


- TC exceeds data limit? Omit students from study 

```{r}
# add column with details
DT <- add_data_sufficiency(DT, 
                           midfield_table = term, 
                           details = TRUE)
DT


# add column without details
DT <- add_data_sufficiency(DT, 
                           midfield_table = term, 
                           details = FALSE)
DT




DT[, c("timely_term", "institution") := NULL]
DT

```

## Evaluate

```{r}
# limit population to data sufficient
DT <- DT[data_sufficiency == TRUE]
DT[]


DT <- DT[, grad_status := fifelse(completion_timely, "grad", "nongrad")]
DT[]

DT <- DT[, .(mcid, cip6, grad_status)]
DT[]

DT <- merge(DT, study_programs, by = "cip6", all.x = TRUE)
DT[, cip6 := NULL]
setcolorder(DT, c("mcid", "program"))
DT
```





## References

<div id="refs"></div>

## Appendix

### Complete script

The vignette code chunks are collected below in a single, condensed script. 

