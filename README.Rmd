---
output: github_document
bibliography: inst/REFERENCES.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  # these options tend to vary from one Rmd to another
  echo = TRUE,
  fig.path = "man/figures/README-",
  # these options tend to remain constant
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  # http://r-pkgs.had.co.nz/vignettes.html: error = TRUE captures errors in
  # the block and shows them inline. This is useful for demonstrating what
  # happens if code throws an error. If you use error = TRUE, set
  # purl = FALSE. Vignettes are accompanied by files containing all the
  # code from the vignette. purl = FALSE prevents the code from being
  # inserted into that file
  error = TRUE,
  purl = FALSE
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)
library(magrittr) # for the pipe %>%
unpack_data <- function(x = data_bits, bit, power10 = 0, decimals = 0) {
  x <- x %>%
    dplyr::filter(name == bit) %>%
    dplyr::select(data) %>%
    unlist() %>%
    unname()
  x <- round(x / 10^power10, decimals)
}
```


# midfieldr <a href="https://engineering.purdue.edu/MIDFIELD" target="blank"><img src="man/figures/midfieldcut.png" align="right"/></a>


[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/midfieldr)](http://cran.r-project.org/package=midfieldr)
[![Build Status](https://travis-ci.org/MIDFIELDR/midfieldr.svg?branch=master)](https://travis-ci.org/MIDFIELDR/midfieldr)
[![Coverage Status](https://img.shields.io/codecov/c/github/MIDFIELDR/midfieldr/master.svg)](https://codecov.io/github/MIDFIELDR/midfieldr?branch=master)
[![](https://cranlogs.r-pkg.org/badges/grand-total/midfieldr)](https://cran.r-project.org/package=midfieldr)
[![License: GPL v3](man/figures/License-GPL-v3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)


```{r databits, echo = FALSE}
data_bits <- midfieldr:::data_bits # ::: for internal variables

obs_cip  <- unpack_data(bit = "obs_cip")
var_cip  <- unpack_data(bit = "var_cip")
size_cip <- unpack_data(bit = "size_cip", power10 = 3)

obs_students  <- unpack_data(bit = "obs_students")
var_students  <- unpack_data(bit = "var_students")
size_students <- unpack_data(bit = "size_students", power10 = 6)

year_min  <- unpack_data(bit = "year_min")
year_max  <- unpack_data(bit = "year_max")

obs_degrees  <- unpack_data(bit = "obs_degrees")
var_degrees  <- unpack_data(bit = "var_degrees")
size_degrees <- unpack_data(bit = "size_degrees", power10 = 6)

obs_terms  <- unpack_data(bit = "obs_terms")
var_terms  <- unpack_data(bit = "var_terms")
size_terms <- unpack_data(bit = "size_terms", power10 = 6)

obs_courses  <- unpack_data(bit = "obs_courses", power10 = 6, decimals = 1)
var_courses  <- unpack_data(bit = "var_courses")
size_courses <- unpack_data(bit = "size_courses", power10 = 6)
```

A package for investigating student record data provided by registrars at US universities participating in the MIDFIELD project. 

midfieldr provides tools for accessing and analyizing s stratified sample of the MIDFIELD database. The sample comprises demographic, term, course, and degree information for `r obs_students` undergraduate students from `r year_min` to `r year_max`. The sample data are provided in a separate data package.

midfieldr includes functions for selecting specific fields of study and  aggregating, computing, and graphing student persistence metrics.

## Installation

To use midfieldr, the  [midfielddata](https://github.com/MIDFIELDR/midfielddata) package should also be installed.  From CRAN, 

```r
install.packages("midfieldr")
install.packages("midfielddata")
```

Or you can obtain the most recent devlopment version from GitHub.  

```r
install.packages("devtools")
devtools::install_github("MIDFIELDR/midfieldr")
devtools::install_github("MIDFIELDR/midfielddata")
```

## Data

The midfieldr package includes: 

- `cip`  A data frame with `r obs_cip` observations and `r var_cip` CIP variables of program codes and names at the 2, 4, and 6-digit levels. Each observation is a unique program. Occupies `r size_cip` kb of memory.  

The [midfielddata](https://github.com/MIDFIELDR/midfielddata) package contains the four datasets that comprise a stratified sample of the MIDFIELD database. 

- `midfieldstudents` A data frame with `r obs_students` observations and `r var_students` demographic variables. Each observation is a unique student. Occupies `r size_students` Mb of memory.  

- `midfieldcourses` A data frame with `r obs_courses` M observations and `r var_courses` academic course variables. Each observation is one course in one term for one student. Occupies `r size_courses` Mb of memory. 

- `midfieldterms` A data frame with `r obs_terms` observations and `r var_terms` academic term variables. Each observation is one term for one student. Occupies `r size_terms` Mb of memory. 

- `midfielddegrees` A data frame with `r obs_degrees` observations and `r var_degrees` graduation variables. Each observation is a unique student. Occupies `r size_degrees` Mb of memory.


## Usage

We illustrate usage by demonstrating how to compute and graph the stickiness metric. "Stickiness" is the ratio of the number of students graduating from a program to the number ever enrolled in the program [@stickiness2012]. 



The demonstration requires that the midfielddata package be installed (though not loaded). 

Packages to load: 

```{r packages}
library(midfieldr)
library(tidyverse)
```

### Select programs to study

In this example we compare the stickiness of three engineering programs: Chemical, Electrical, and Industrial. 

We use `cip_filter()` to search first for "Engineering" and then filter the result for "Chemical", "Electrical", and "Industrial". The results show that the 2-digit code "14" describes Engineering programs (wht we want) while "15" denotes Engineering Technology programs (not what we want). 
 
```{r first-cip-search, echo = -1}
options(tibble.print_min = 12L)
search_results <- cip_filter(series = "Engineering") %>% 
	cip_filter(series = c("Chemical", "Electrical", "Industrial"))

search_results
```

Running the search again with "^14" (starts with 14), we find that the codes we want are 1407 Chemical Engineering, 1410  Electrical Engineering, and 1435 Industrial Engineering.
 
```{r second-cip-search}
search_results <- cip_filter(series = "^14") %>%
  cip_filter(series = c("Chemical", "Electrical", "Industrial"))

search_results
```

We extract the series for each major and assign our own program label using `cip_label()`. We can assign the default code name, e.g., using "cip4name" or we can assign our own label. Here for example, I've used "Electrical Engineering" instead of the longer, default 4-digit code name "Electrical/Electronics and Communications Engineering." 

```{r extract-cip}
set1 <- cip_filter(series = "^1407") %>% 
	cip_label(program = "cip4name") # use the default 4-digit code name
set2 <- cip_filter(series = "^1410") %>% 
	cip_label(program = "Electrical Engineering")
set3 <- cip_filter(series = "^1435") %>% 
	cip_label(program = "cip4name")
```

Combine the data frames. 

```{r group-cip}
cip_group <- bind_rows(set1, set2, set3)
```

For additional information, try the help page `?cip_filter()` and the  [Selecting CIP codes](cip_filter.html) vignette. 

### Compute the metric

Use `gather_ever()` to access the `midfieldterms` dataset and extract all students who ever enrolled in these programs. 

```{r gather-ever}
students <- gather_ever(cip_group)
```

Use `race_sex_join()` to access the `midfieldstudents` dataset and append students' race and sex to the data frame. 

```{r race-sex-join}
students <- students %>%
  race_sex_join()
```

Count the numbers of students grouped by program, race, and sex using the  dplyr `group_by()` and `summarize()` functions. We define the new variable `ever` to denote the count. 

```{r ever}
ever_enrolled <- students %>%
  group_by(program, race, sex) %>%
  summarize(ever = n()) %>%
  ungroup()
```

Use `zero_fill()` to expand the data frame to include all missing combinations of variables (if any) and insert a count of zero in the numerical column.  The arguments of `zero_fill()` must be identical to the arguments of `group_by()` above.

```{r zero-ill}
ever_enrolled <- ever_enrolled %>%
  zero_fill(program, race, sex)
```

Use `gather_grad()` to access the `midfielddegrees` dataset and extract all students who graduated from these programs. We group and summarize the counts using `grad` as the new count variable.  

```{r grad}
graduated <- gather_grad(cip_group) %>%
  race_sex_join() %>%
  group_by(program, race, sex) %>%
  summarize(grad = n()) %>%
  ungroup() %>%
  zero_fill(program, race, sex)
```

The two data frames `ever_enrolled` and `graduated` are the arguments for the `tally_stickiness()` function that joins the two data frames by their common variables and computes stickiness. 

```{r stickiness}
stickiness <- tally_stickiness(ever_enrolled, graduated)

glimpse(stickiness)
```

For a discussion of each step in greater detail, see the [Stickiness metric](stickiness.html) vignette.

### Graph the results 

To prepare the stickiness data for graphing, we remove ambiguous race levels (Unknown, International, or Other) and then combine race and sex into a single variable. 

```{r prep-data}
stickiness_mw_data <- stickiness %>%
  filter(!race %in% c("Unknown", "International", "Other")) %>%
  mutate(race_sex = str_c(race, sex, sep = " "))
```

We graph these results in a *multiway dot plot* [@cleveland1993], a display type based on a data structure of two categorical variables (program and race/ethnicity/sex) and one quantitative variable (stickiness). 

`multiway_order()` converts the two categorical variables to factors and orders their levels by median stickiness.

```{r multiway-order}
stickiness_mw_data <- stickiness_mw_data %>%
  select(program, race_sex, stick) %>%
  multiway_order()

glimpse(stickiness_mw_data)
```

We use conventional ggplot2 functions to graph stickiness in a multiway dot plot. We also apply our own `midfield_theme()` to edit the visual properties of the graph. For additional information on multiways, see the [Multiway data, graphs, and tables](multiway.html) vignette. 

```{r fig1, fig.asp = 1.6/1.6}
ggplot(stickiness_mw_data, aes(x = stick, y = race_sex)) +
  facet_wrap(~ program, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

## Meta

- License: [GPL-3](https://www.gnu.org/licenses/gpl-3.0). 
- Please report any [issues or bugs](https://github.com/MIDFIELDR/midfieldr/issues). 
- Get citation information with `citation("midfieldr")`. 
- Please note that this project is released with a [Code of Conduct](CONDUCT.md). If you contribute to this project you agree to abide by its terms. 



## References
