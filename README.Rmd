---
output: github_document
bibliography: inst/REFERENCES.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  # these options tend to vary from one Rmd to another
  echo = TRUE,
  fig.path = "man/figures/README-",
  # these options tend to remain constant
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 6,
  fig.asp = 1 / 1.6,
  out.width = "70%",
  fig.align = "center",
  # http://r-pkgs.had.co.nz/vignettes.html: error = TRUE captures errors in
  # the block and shows them inline. This is useful for demonstrating what
  # happens if code throws an error. If you use error = TRUE, set
  # purl = FALSE. Vignettes are accompanied by files containing all the
  # code from the vignette. purl = FALSE prevents the code from being
  # inserted into that file
  error = TRUE,
  purl = FALSE
)
knitr::knit_hooks$set(inline = function(x) {
  if (!is.numeric(x)) {
    x
  } else if (x >= 10000) {
    prettyNum(round(x, 2), big.mark = ",")
  } else {
    prettyNum(round(x, 2))
  }
})
options(tibble.print_min = 8L, tibble.print_max = 8L)
library(dplyr) # for the pipe %>%
unpack_data <- function(x = data_bits, bit, power10 = 0, decimals = 0) {
  x <- x %>%
    dplyr::filter(name == bit) %>%
    dplyr::select(data) %>%
    unlist() %>%
    unname()
  x <- round(x / 10^power10, decimals)
}
```


# midfieldr <a href="https://engineering.purdue.edu/MIDFIELD" target="blank"><img src="man/figures/logo.png" align="right"/></a>

[![CRAN_Status_Badge](http://www.r-pkg.org/badges/version/midfieldr)](http://cran.r-project.org/package=midfieldr)
[![Build Status](https://travis-ci.org/MIDFIELDR/midfieldr.svg?branch=master)](https://travis-ci.org/MIDFIELDR/midfieldr)
[![Coverage Status](https://img.shields.io/codecov/c/github/MIDFIELDR/midfieldr/master.svg)](https://codecov.io/github/MIDFIELDR/midfieldr?branch=master)
[![](https://cranlogs.r-pkg.org/badges/grand-total/midfieldr)](https://cran.r-project.org/package=midfieldr)
[![License: GPL v3](man/figures/License-GPL-v3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)


```{r databits, echo = FALSE}
library(midfieldr)
data_bits <- midfieldr:::data_bits # ::: for internal variables

obs_cip <- unpack_data(bit = "obs_cip")
var_cip <- unpack_data(bit = "var_cip")
size_cip <- unpack_data(bit = "size_cip", power10 = 3)

obs_students <- unpack_data(bit = "obs_students")
var_students <- unpack_data(bit = "var_students")
size_students <- unpack_data(bit = "size_students", power10 = 6)

year_min <- unpack_data(bit = "year_min")
year_max <- unpack_data(bit = "year_max")

obs_degrees <- unpack_data(bit = "obs_degrees")
var_degrees <- unpack_data(bit = "var_degrees")
size_degrees <- unpack_data(bit = "size_degrees", power10 = 6)

obs_terms <- unpack_data(bit = "obs_terms")
var_terms <- unpack_data(bit = "var_terms")
size_terms <- unpack_data(bit = "size_terms", power10 = 6)

obs_courses <- unpack_data(bit = "obs_courses", power10 = 6, decimals = 1)
var_courses <- unpack_data(bit = "var_courses")
size_courses <- unpack_data(bit = "size_courses", power10 = 6)
```

A package for investigating student record data provided by registrars at US universities participating in the MIDFIELD project. 

midfieldr provides tools for accessing and analyzing a stratified sample of the MIDFIELD database. The sample comprises demographic, term, course, and degree information for `r obs_students` undergraduate students from `r year_min` to `r year_max`. The sample data are provided in a separate data package.

midfieldr includes functions for selecting specific fields of study and  aggregating, computing, and graphing student persistence metrics.

## Installation

Package not yet submitted to CRAN. Development version can be installed from GitHub using:

```r
install.packages("devtools")
devtools::install_github("MIDFIELDR/midfieldr")
```
midfieldr depends on data in a data package (midfielddata) that is available through a drat repository on GitHub. To use midfieldr, you will need to install midfielddata on your computer. 

```r
install.packages("drat")
drat::addRepo("midfieldr")
install.packages("midfielddata")
```






## Data

The midfieldr package includes: 

- `cip`  A data frame with `r obs_cip` observations and `r var_cip` CIP variables of program codes and names at the 2, 4, and 6-digit levels. Each observation is a unique program. Occupies `r size_cip` kb of memory.  

The [midfielddata](https://midfieldr.github.io/midfielddata) package contains the four datasets that comprise a stratified sample of the MIDFIELD database. 

- `midfieldstudents` A data frame with `r obs_students` observations and `r var_students` demographic variables. Each observation is a unique student. Occupies `r size_students` Mb of memory.  

- `midfieldcourses` A data frame with `r obs_courses` M observations and `r var_courses` academic course variables. Each observation is one course in one term for one student. Occupies `r size_courses` Mb of memory. 

- `midfieldterms` A data frame with `r obs_terms` observations and `r var_terms` academic term variables. Each observation is one term for one student. Occupies `r size_terms` Mb of memory. 

- `midfielddegrees` A data frame with `r obs_degrees` observations and `r var_degrees` graduation variables. Each observation is a unique student. Occupies `r size_degrees` Mb of memory.


## Usage

We illustrate a number of midfieldr functions by demonstrating how to compute and graph the "stickiness" metric. Stickiness is the ratio of the number of students graduating from a program to the number ever enrolled in the program [@stickiness2012]. 

Packages to install and load: 

```{r packages}
library(midfieldr)
library(seplyr)
library(dplyr)
library(ggplot2)
```

**Step 1. Select programs to study**

In this example we compare the stickiness of three engineering programs: Chemical, Electrical, and Industrial. 

We use `cip_filter()` to search the `cip` dataset first for "Engineering" and then filter the result for "Chemical", "Electrical", and "Industrial". 
 
```{r first-cip-search, echo = -1}
options(tibble.print_min = 10L)
cip_filter(series = "Engineering") %>%
  cip_filter(series = c("Chemical", "Electrical", "Industrial"), reference = .) %>%
  head(., n = 10L)
```

The results show that the codes we want are 1407 Chemical Engineering, 1410  Electrical Engineering, and 1435 Industrial Engineering.

We extract the series for each major and assign our own program label using `cip_label()`. We can assign the default code name, e.g., using "cip4name" or we can assign our own label. Here for example, I've used "Electrical Engineering" instead of the longer, default 4-digit code name "Electrical/Electronics and Communications Engineering." 

```{r extract-cip}
set1 <- cip_filter(series = "^1407") %>%
  cip_label(., program = "cip4name")
set2 <- cip_filter(series = "^1410") %>%
  cip_label(., program = "Electrical Engineering")
set3 <- cip_filter(series = "^1435") %>%
  cip_label(., program = "cip4name")
```

Combine the data frames. 

```{r group-cip}
program_group <- bind_rows(set1, set2, set3)

program_group
```

For additional information, try the help page `?cip_filter()` and the  [Selecting CIP codes](cip_filter.html) vignette. 

**Step 2. Gather the data and compute the metric**

First we extract the 6-digit CIP codes from our program group to use as search terms. 

```{r}
program_cip6 <- program_group[["cip6"]]
```

Use `gather_ever()` to access the `midfieldterms` dataset and extract all students who ever enrolled in these programs. Use `race_sex_join()` to access the `midfieldstudents` dataset and append students' race and sex to the data frame. 

```{r gather-ever}
students <- gather_ever(series = program_cip6) %>%
  race_sex_join(.)

students
```

Next we join our custom program names to the student data.

```{r}
students <- left_join(students, program_group, by = "cip6")

students
```

We create a vector of grouping variables and use the seplyr `group_summarize()` function to count the numbers of students ever enrolled in these programs. We define the new variable `ever` to denote the count. 

```{r}
grouping_variables <- c("program", "race", "sex")

ever_enrolled <- students %>%
  group_summarize(., grouping_variables, ever = n())

ever_enrolled
```

Following similar steps, we use `gather_grad()` to access the `midfielddegrees` dataset and extract all students who graduated from these programs. We group and summarize the counts using `grad` as the new count variable. 

```{r grad}
graduated <- gather_grad(series = program_cip6) %>%
  race_sex_join(.) %>%
  left_join(., program_group, by = "cip6") %>%
  group_summarize(., grouping_variables, grad = n())
```

We join the two data frames by the grouping variables. 

```{r}
stickiness <- left_join(ever_enrolled, graduated, by = grouping_variables)
```

We suggest omitting observations with 5 or fewer students ever enrolled. 

```{r}
stickiness <- stickiness %>%
  filter(., ever > 5)
```

And we compute stickiness, the ratio of `grad` to `ever`. 

```{r}
stickiness <- stickiness %>%
  mutate(., stick = round(grad / ever, 3))

stickiness
```

For a discussion of each step in greater detail, see the [Stickiness metric](stickiness.html) vignette.

**Step 3. Graph the results**

To prepare the stickiness data for graphing, we remove ambiguous race levels (Unknown, International, or Other) and then combine race and sex into a single variable. 

```{r prep-data}
stickiness_mw <- stickiness %>%
  filter(., !race %in% c("Unknown", "International", "Other")) %>%
  filter(., !sex %in% "Unknown") %>%
  mutate(., race_sex = paste(race, sex))
```

We graph these results in a *multiway dot plot* [@cleveland1993], a display type based on a data structure of two categorical variables (program and race/ethnicity/sex) and one quantitative variable (stickiness). 

`multiway_order()` converts the two categorical variables to factors and orders their levels by median stickiness.

```{r multiway-order}
stickiness_mw <- stickiness_mw %>%
  select(., program, race_sex, stick) %>%
  multiway_order(.)
```

We use conventional ggplot2 functions to graph stickiness in a multiway dot plot. We also apply our own `theme_midfield()` to edit the visual properties of the graph.

```{r fig1, fig.asp = 1.6/1.6}
ggplot(stickiness_mw, aes(x = stick, y = race_sex)) +
  facet_wrap(~program, ncol = 1, as.table = FALSE) +
  geom_point(na.rm = TRUE) +
  labs(x = "Stickiness", y = "") +
  theme_midfield()
```

The ordering of the rows and panels of the multiway plot tell us that for these three engineering majors, Industrial Engineering has the greatest stickiness and Electrical the least; that Asian men have the greatest stickiness and Native American Women the least. The visual anomalies are White women in Electrical with lower stickiness than expected by the ranking overall and Asian men in Chemical, also lower than expected. 

Results will vary depending on the programs one compares. Variations can also be expected if one uses the whole population data available to MIDFIELD member institutions. 

For additional information on multiways, see the [Multiway data, graphs, and tables](multiway.html) vignette. For additional midfieldr functionality and metrics see the [vignettes](articles/index.html).  

## Meta

- Get citation information with `citation("midfieldr")`. 
- Please note that this project is released with a [Code of Conduct](CONDUCT.md). If you contribute to this project you agree to abide by its terms. 

## References
